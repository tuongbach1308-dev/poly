<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Qu·∫£n L√Ω S·ª≠a Ch·ªØa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
   
  <style>
    /* Base */
    :root { --primary: #ea580c; }
    /* Fix scrollbar & layout for Iframe */
    html, body { height: 100%; width: 100%; overflow: hidden; margin: 0; padding: 0; }
    
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    body { font-family: 'Roboto', sans-serif; background-color: #fff7ed; -webkit-tap-highlight-color: transparent; }
    
    .modal-open { opacity: 1; transform: scale(1); pointer-events: auto; }
    .modal-hide { opacity: 0; transform: scale(0.95); pointer-events: none; }
    
    /* Mobile optimization for Sticky Columns */
    .sticky-col-shadow { box-shadow: -4px 0 10px -4px rgba(0,0,0,0.1); }
    
    /* Status Badges */
    .badge { font-size: 10px; font-weight: bold; padding: 3px 8px; border-radius: 12px; text-transform: uppercase; white-space: nowrap; display: inline-flex; align-items: center; gap: 4px; }
    .st-pending { background: #fef9c3; color: #b45309; border: 1px solid #fcd34d; }
    .st-fixing { background: #dbeafe; color: #1d4ed8; border: 1px solid #93c5fd; }
    .st-wait { background: #f3e8ff; color: #7e22ce; border: 1px solid #d8b4fe; }
    .st-done { background: #dcfce7; color: #15803d; border: 1px solid #86efac; }
    .st-cancel { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }

    /* Responsive Table Helpers */
    .mobile-card { display: block; }
    .desktop-row { display: none; }
    @media (min-width: 768px) {
        .mobile-card { display: none; }
        .desktop-row { display: table-row; }
    }

    /* Print */
    @media print {
        body > *:not(#printReceiptModal) { display: none !important; }
        #printReceiptModal { display: block !important; position: absolute; top: 0; left: 0; width: 100%; height: auto; background: white; z-index: 9999; }
        .no-print { display: none !important; }
        .page-a5 { width: 148mm; min-height: 210mm; padding: 10mm; margin: 0 auto; border: none; box-shadow: none; }
    }
    .page-a5 { width: 148mm; min-height: 210mm; background: white; padding: 10mm; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-family: 'Times New Roman', serif; color: #000; }
  </style>
</head>
<body class="text-gray-800 flex flex-col">

<!-- Main Layout: S·ª≠ d·ª•ng h-full v√† flex-col ƒë·ªÉ v·ª´a kh√≠t iframe -->
<div class="flex-1 flex flex-col w-full max-w-[1600px] mx-auto no-print overflow-hidden p-2 md:p-4">
   
  <!-- Header & Stats -->
  <div class="bg-white p-3 md:p-4 rounded-xl shadow-sm border border-orange-100 mb-3 shrink-0">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-3 border-b border-gray-100 pb-3 gap-3">
      <div>
        <h1 class="text-lg md:text-2xl font-bold text-orange-700 flex items-center gap-2">
          <i class="fa-solid fa-screwdriver-wrench"></i> D·ªãch V·ª• S·ª≠a Ch·ªØa
        </h1>
        <p class="text-gray-500 text-xs mt-1 hidden md:block">Qu·∫£n l√Ω ti·∫øp nh·∫≠n & c√¥ng n·ª£</p>
      </div>
      
      <!-- Quick Stats (ƒê√£ ·∫©n L·ª£i Nhu·∫≠n) -->
      <div class="flex gap-2 text-center w-full md:w-auto">
          <div class="bg-red-50 px-3 py-2 rounded-lg border border-red-100 flex-1 md:flex-none">
              <div class="text-[10px] text-gray-500 uppercase font-bold">Kh√°ch n·ª£</div>
              <div class="text-base md:text-lg font-bold text-red-600" id="statDebt">0 ‚Ç´</div>
          </div>
          <div class="bg-orange-50 px-3 py-2 rounded-lg border border-orange-100 flex-1 md:flex-none">
              <div class="text-[10px] text-gray-500 uppercase font-bold">ƒêang s·ª≠a</div>
              <div class="text-base md:text-lg font-bold text-orange-600" id="statFixing">0</div>
          </div>
          <!-- ƒê√£ x√≥a √¥ T·ªïng L·ª£i Nhu·∫≠n -->
      </div>
    </div>

    <!-- Toolbar -->
    <div class="flex flex-col md:flex-row gap-2">
        <div class="relative flex-1">
            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input id="searchInput" type="text" oninput="renderTable(allData)" placeholder="T√¨m t√™n, SƒêT, m√°y..."
            class="w-full pl-9 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 transition-all text-sm" />
        </div>
        
        <div class="flex gap-2 overflow-x-auto pb-1 md:pb-0">
            <select id="filterTime" onchange="renderTable(allData)" class="border border-gray-200 rounded-lg px-2 py-2 text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 font-bold bg-white">
                <option value="THIS_MONTH" selected>Th√°ng n√†y</option>
                <option value="LAST_MONTH">Th√°ng tr∆∞·ªõc</option>
            </select>

            <select id="filterStatus" onchange="renderTable(allData)" class="border border-gray-200 rounded-lg px-2 py-2 text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 font-bold bg-white">
                <option value="ALL">üìã T·∫•t c·∫£</option>
                <option value="DEBT">‚ö†Ô∏è N·ª£</option>
                <option value="FIXING">üõ†Ô∏è ƒêang s·ª≠a</option>
                <option value="DONE">‚úÖ Xong</option>
            </select>
        </div>

        <div class="flex gap-2 shrink-0">
            <button onclick="loadData()" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"><i class="fa-solid fa-rotate"></i></button>
            <button onclick="openModal('add')" class="flex-1 md:flex-none px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-bold shadow-md flex items-center justify-center gap-2 text-sm">
                <i class="fa-solid fa-plus"></i> <span class="hidden md:inline">Ti·∫øp Nh·∫≠n</span><span class="md:hidden">Th√™m</span>
            </button>
        </div>
    </div>
  </div>

  <!-- Table Container -->
  <div class="relative bg-white rounded-xl shadow border border-orange-100 flex-1 overflow-hidden flex flex-col">
    <div id="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-50">
        <i class="fa-solid fa-circle-notch fa-spin text-3xl text-orange-500 mb-2"></i>
        <span class="text-gray-500 font-medium animate-pulse text-xs">ƒêang t·∫£i...</span>
    </div>
    
    <div class="overflow-y-auto custom-scrollbar flex-1 p-2 md:p-0">
        <!-- Desktop Table -->
        <table class="min-w-full text-left border-collapse hidden md:table">
            <thead class="bg-orange-600 text-white text-xs uppercase sticky top-0 z-20 shadow-sm">
                <tr>
                    <th class="p-3 text-center w-10">#</th>
                    <th class="p-3 w-24">Ng√†y</th>
                    <th class="p-3 w-40">Kh√°ch H√†ng</th>
                    <th class="p-3 min-w-[200px]">Thi·∫øt B·ªã & D·ªãch V·ª•</th>
                    <th class="p-3 w-24 text-center">H·∫πn Tr·∫£</th>
                    <th class="p-3 text-right w-28">T·ªïng Ti·ªÅn</th>
                    <!-- ƒê√£ x√≥a c·ªôt L·ª£i Nhu·∫≠n -->
                    <th class="p-3 text-center w-32">Tr·∫°ng Th√°i</th>
                    <th class="p-3 text-center w-16 sticky right-0 bg-orange-600">X·ª≠ L√Ω</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="divide-y divide-gray-100 text-gray-700 text-sm"></tbody>
        </table>

        <!-- Mobile Card View -->
        <div id="mobileList" class="md:hidden space-y-2 pb-20"></div>
    </div>
  </div>
</div>

<!-- ================= MODAL TI·∫æP NH·∫¨N / S·ª¨A ================= -->
<div id="modal" class="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center transition-opacity duration-200 modal-hide backdrop-blur-sm no-print hidden">
  <div class="bg-white w-full h-full md:h-auto md:w-full md:max-w-4xl md:max-h-[90vh] md:rounded-xl shadow-2xl flex flex-col overflow-hidden">
    <div class="bg-orange-600 p-3 flex justify-between items-center text-white shrink-0">
        <h2 class="text-lg font-bold flex items-center gap-2"><i class="fa-solid fa-file-pen"></i> <span id="modalTitle">Phi·∫øu Ti·∫øp Nh·∫≠n</span></h2>
        <button onclick="closeModal()" class="text-white/80 hover:text-white text-2xl w-8 h-8 flex items-center justify-center">&times;</button>
    </div>
    
    <div class="p-4 overflow-y-auto grow bg-gray-50 space-y-4 pb-24 md:pb-6">
        <input type="hidden" id="inp_id">

        <!-- Th√¥ng tin chung -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <!-- Kh√°ch h√†ng -->
            <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                <div class="text-xs font-bold text-orange-700 uppercase mb-2 flex items-center gap-2"><i class="fa-solid fa-user"></i> Kh√°ch h√†ng</div>
                <div class="grid grid-cols-1 gap-2">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 mb-1">SƒêT</label>
                        <input type="text" id="inp_phone" class="w-full border p-2 rounded text-sm focus:border-orange-500 outline-none font-bold font-mono text-orange-800" placeholder="09xxxx">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 mb-1">T√™n Kh√°ch</label>
                        <input type="text" id="inp_cust" class="w-full border p-2 rounded text-sm focus:border-orange-500 outline-none" placeholder="Nh·∫≠p t√™n...">
                    </div>
                </div>
            </div>

            <!-- Thi·∫øt b·ªã -->
            <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                <div class="text-xs font-bold text-orange-700 uppercase mb-2 flex items-center gap-2"><i class="fa-solid fa-mobile-screen"></i> Thi·∫øt b·ªã</div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="col-span-2">
                        <label class="block text-[10px] font-bold text-gray-500 mb-1">T√™n M√°y</label>
                        <input type="text" id="inp_device" class="w-full border p-2 rounded text-sm focus:border-orange-500 outline-none font-bold" placeholder="VD: iPhone 14 Pro">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 mb-1">M·∫≠t Kh·∫©u</label>
                        <input type="text" id="inp_pwd" class="w-full border p-2 rounded text-sm focus:border-orange-500 outline-none bg-yellow-50 text-red-600 font-mono font-bold" placeholder="123456">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 mb-1">K·ªπ Thu·∫≠t Vi√™n</label>
                        <select id="inp_tech" class="w-full border p-2 rounded text-sm focus:border-orange-500 bg-white">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="Kh√°nh">Kh√°nh</option>
                            <option value="Khoa">Khoa</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chi ti·∫øt s·ª≠a ch·ªØa -->
        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
            <div class="flex justify-between items-center mb-2">
                <div class="text-xs font-bold text-orange-700 uppercase flex items-center gap-2"><i class="fa-solid fa-list-check"></i> H·∫°ng m·ª•c</div>
                <button onclick="addItemRow()" class="text-[10px] bg-green-50 text-green-700 px-2 py-1 rounded border border-green-200 hover:bg-green-100 font-bold"><i class="fa-solid fa-plus"></i> Th√™m</button>
            </div>
            
            <div class="space-y-2" id="repairItemsBody">
                <!-- Mobile-friendly rows will be added here -->
            </div>
            
            <div class="mt-3 pt-2 border-t flex justify-between items-center">
                <div>
                     <span class="text-[10px] text-gray-400 font-medium">V·ªën: <span id="inp_total_capital">0</span></span>
                </div>
                <div>
                    <span class="text-sm font-bold text-gray-600 mr-2">T·ªîNG C·ªòNG:</span>
                    <span class="text-lg font-bold text-orange-600" id="inp_total_cost">0</span>
                </div>
            </div>
        </div>

        <!-- Thanh to√°n & Tr·∫°ng th√°i -->
        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 items-end">
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Kh√°ch ƒë√£ tr·∫£</label>
                    <input type="text" id="inp_paid" onkeyup="formatCurrency(this); updateDebt();" class="w-full border p-2 rounded text-sm focus:border-orange-500 outline-none font-bold text-right text-green-600" placeholder="0">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">C√≤n n·ª£</label>
                    <div id="inp_debt" class="w-full p-2 text-sm text-right font-bold text-red-600 bg-red-50 rounded border border-red-100">0</div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Tr·∫°ng Th√°i</label>
                    <select id="inp_status" class="w-full border p-2 rounded text-sm focus:border-orange-500 bg-white font-bold text-gray-700">
                        <option value="PENDING">‚è≥ Ch·ªù ki·ªÉm tra</option>
                        <option value="FIXING">üõ†Ô∏è ƒêang s·ª≠a</option>
                        <option value="WAIT_PAY">üì¶ Ch·ªù tr·∫£ kh√°ch</option>
                        <option value="DONE">‚úÖ Ho√†n th√†nh</option>
                        <option value="CANCEL">‚ùå H·ªßy / Tr·∫£ l·∫°i</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Ng√†y H·∫πn</label>
                    <input type="date" id="inp_appoint" class="w-full border p-2 rounded text-sm focus:border-orange-500">
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Footer on Mobile, Static on Desktop -->
    <div class="p-3 border-t bg-white flex justify-end gap-3 shrink-0 absolute bottom-0 left-0 w-full md:static z-20 shadow-[0_-2px_5px_rgba(0,0,0,0.05)]">
        <button onclick="closeModal()" class="flex-1 md:flex-none px-5 py-2 border rounded-lg hover:bg-gray-100 text-gray-600 font-bold">H·ªßy</button>
        <button onclick="saveData()" id="btnSave" class="flex-1 md:flex-none px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 shadow-lg font-bold flex items-center justify-center gap-2"><i class="fa-solid fa-save"></i> L∆∞u Phi·∫øu</button>
    </div>
  </div>
</div>

<!-- ================= MODAL BI√äN NH·∫¨N (IN A5) ================= -->
<div id="printReceiptModal" class="fixed inset-0 bg-white z-[70] hidden overflow-auto flex justify-center p-0 md:p-8">
    <div class="page-a5 relative w-full md:w-auto h-full md:h-auto">
        <button onclick="closePrint()" class="no-print absolute top-2 right-2 text-gray-400 hover:text-red-500 text-3xl z-50">&times;</button>
        
        <div class="text-center border-b-2 border-black pb-2 mb-4 mt-8 md:mt-0">
            <h1 class="text-2xl font-bold uppercase">POLY STORE</h1>
            <p class="text-sm">ƒê/c: 170/4/2 B√πi ƒê√¨nh T√∫y, P.12, Q. B√¨nh Th·∫°nh</p>
            <p class="text-sm font-bold">Hotline: 0902.96.0804</p>
            <h2 class="text-xl font-bold uppercase mt-4 border-2 border-black inline-block px-4 py-1">BI√äN NH·∫¨N S·ª¨A CH·ªÆA</h2>
            <p class="text-sm italic mt-1">Ng√†y nh·∫≠n: <span id="pr_date"></span></p>
        </div>
        <div class="text-sm space-y-2 mb-4">
            <div class="flex"><span class="w-24 font-bold shrink-0">Kh√°ch h√†ng:</span> <span class="border-b border-dotted border-black flex-1 font-bold" id="pr_cust"></span></div>
            <div class="flex"><span class="w-24 font-bold shrink-0">ƒêi·ªán tho·∫°i:</span> <span class="border-b border-dotted border-black flex-1 font-bold" id="pr_phone"></span></div>
            <div class="flex"><span class="w-24 font-bold shrink-0">Thi·∫øt b·ªã:</span> <span class="border-b border-dotted border-black flex-1 font-bold" id="pr_device"></span></div>
            <div class="flex"><span class="w-24 font-bold shrink-0">M·∫≠t kh·∫©u:</span> <span class="border-b border-dotted border-black flex-1 font-mono font-bold" id="pr_pwd"></span></div>
        </div>
        
        <table class="w-full border-collapse border border-black text-sm mb-4">
            <thead><tr class="bg-gray-200"><th class="border border-black p-1 text-center">N·ªôi dung s·ª≠a ch·ªØa / Linh ki·ªán</th><th class="border border-black p-1 text-center w-24">Chi ph√≠</th></tr></thead>
            <tbody id="pr_items_body"></tbody>
            <tfoot>
                <tr><td class="border border-black p-1 text-right font-bold">T·ªïng c·ªông:</td><td class="border border-black p-1 text-right font-bold" id="pr_total"></td></tr>
                <tr><td class="border border-black p-1 text-right italic">ƒê√£ thanh to√°n:</td><td class="border border-black p-1 text-right italic" id="pr_paid"></td></tr>
                <tr><td class="border border-black p-1 text-right font-bold text-red-600">C√≤n l·∫°i:</td><td class="border border-black p-1 text-right font-bold text-red-600" id="pr_debt"></td></tr>
            </tfoot>
        </table>

        <div class="text-xs space-y-1 mb-6"><p><strong>L∆∞u √Ω:</strong></p><ul class="list-disc pl-4 italic"><li>Vui l√≤ng ki·ªÉm tra k·ªπ ngo·∫°i h√¨nh m√°y tr∆∞·ªõc khi r·ªùi c·ª≠a h√†ng.</li><li>C·ª≠a h√†ng kh√¥ng ch·ªãu tr√°ch nhi·ªám d·ªØ li·ªáu c√° nh√¢n.</li><li>B·∫£o h√†nh theo tem d√°n tr√™n m√°y.</li></ul></div>
        <div class="flex justify-between text-center mt-10"><div><p class="font-bold">Kh√°ch h√†ng</p></div><div><p class="font-bold">KTV Ti·∫øp Nh·∫≠n</p></div></div>
        <div class="no-print mt-10 text-center"><button onclick="window.print()" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg w-full md:w-auto"><i class="fa-solid fa-print"></i> IN NGAY</button></div>
    </div>
</div>

<!-- Action Menu (Mobile) -->
<div id="actionSheet" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-end justify-center" onclick="closeMenu()">
    <div class="bg-white w-full max-w-md rounded-t-2xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
        <input type="hidden" id="act_id">
        <div class="bg-gray-50 p-4 text-center font-bold text-gray-700 border-b flex justify-between items-center">
            <span>Thao T√°c</span>
            <button onclick="closeMenu()" class="text-gray-400"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="p-4 space-y-3 pb-8">
             <button onclick="handleAction('print')" class="w-full py-3.5 bg-blue-50 text-blue-700 rounded-xl font-bold flex items-center justify-center gap-3 active:scale-95 transition"><i class="fa-solid fa-print text-xl"></i> In Bi√™n Nh·∫≠n</button>
             <button onclick="handleAction('edit')" class="w-full py-3.5 bg-orange-50 text-orange-700 rounded-xl font-bold flex items-center justify-center gap-3 active:scale-95 transition"><i class="fa-solid fa-pen text-xl"></i> S·ª≠a / Thanh To√°n</button>
             <button onclick="handleAction('delete')" class="w-full py-3.5 bg-red-50 text-red-600 rounded-xl font-bold flex items-center justify-center gap-3 active:scale-95 transition"><i class="fa-solid fa-trash text-xl"></i> X√≥a Phi·∫øu</button>
        </div>
    </div>
</div>

<script>
// !!! LINK API BACKEND !!!
const API_URL = 'https://script.google.com/macros/s/AKfycbwn-uSc2DnJIh5xRtLyROGKUFrh7_hgMGkNNpG2vShy8Ug6zJI7iB33NhNnReTKbgRhzw/exec'; 

let allData = [];
const qs = (s) => document.querySelector(s);
const getVal = (id) => document.getElementById(id).value;
const setVal = (id, val) => document.getElementById(id).value = val;
const formatMoney = (n) => n ? Number(String(n).replace(/\D/g, '')).toLocaleString('vi-VN') : '0';
function formatCurrency(input) { let val = input.value.replace(/\D/g, ''); input.value = val ? Number(val).toLocaleString('vi-VN') : ''; }
const parseMoney = (n) => n ? Number(String(n).replace(/\D/g, '')) : 0;

// === LOAD DATA ===
async function loadData() {
    qs('#loading').classList.remove('hidden');
    try {
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "get_repairs" }) });
        const json = await res.json();
        if(json.success) {
            allData = json.data;
            renderTable(allData);
        }
    } catch(e) { console.error(e); }
    qs('#loading').classList.add('hidden');
}

// === CHECK TIME FILTER (UPDATED) ===
function checkTimeFilter(dateStr, filter) {
    if (filter === 'ALL') return true;
    if (!dateStr) return false;
    
    // Parse dd/MM/yyyy from sheet
    const parts = dateStr.split(' ')[0].split('/');
    if (parts.length !== 3) return false;
    
    const d = new Date(parts[2], parts[1] - 1, parts[0]);
    const now = new Date();
    const nowYear = now.getFullYear();
    const nowMonth = now.getMonth();
    
    now.setHours(0,0,0,0);
    
    if (filter === 'THIS_MONTH') return d.getMonth() === nowMonth && d.getFullYear() === nowYear;
    if (filter === 'LAST_MONTH') {
        const lastMonthDate = new Date(nowYear, nowMonth - 1, 1);
        const lmMonth = lastMonthDate.getMonth();
        const lmYear = lastMonthDate.getFullYear();
        return d.getMonth() === lmMonth && d.getFullYear() === lmYear;
    }
    return true;
}

function renderTable(data) {
    const tbody = qs('#tableBody');
    const mobileList = qs('#mobileList');
    tbody.innerHTML = '';
    mobileList.innerHTML = '';
    
    const k = qs('#searchInput').value.toLowerCase().trim();
    const st = qs('#filterStatus').value;
    const tf = qs('#filterTime').value;

    let fixingCount = 0;
    let totalDebt = 0;

    const filtered = data.filter(i => {
        const text = (String(i.CUST_NAME||'') + " " + String(i.CUST_PHONE||'') + " " + String(i.DEVICE||'')).toLowerCase();
        const matchText = text.includes(k);
        const matchTime = checkTimeFilter(i.DATE, tf);
        
        let matchStatus = true;
        if (st === 'DEBT') matchStatus = (i.TOTAL_COST - i.PAID) > 0;
        else if (st !== 'ALL') matchStatus = i.STATUS === st;
        return matchText && matchStatus && matchTime;
    });

    if(filtered.length === 0) {
        const emptyHTML = `<tr><td colspan="8" class="p-8 text-center text-gray-400 italic">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
        tbody.innerHTML = emptyHTML;
        mobileList.innerHTML = `<div class="p-8 text-center text-gray-400 italic">Kh√¥ng c√≥ d·ªØ li·ªáu</div>`;
    }

    filtered.forEach((item, i) => {
        let stClass = 'st-pending', stText = 'Ch·ªù x·ª≠ l√Ω', stIcon = 'fa-hourglass';
        if(item.STATUS==='FIXING') { stClass='st-fixing'; stText='ƒêang s·ª≠a'; stIcon='fa-wrench'; fixingCount++; }
        if(item.STATUS==='WAIT_PAY') { stClass='st-wait'; stText='Ch·ªù tr·∫£'; stIcon='fa-box'; }
        if(item.STATUS==='DONE') { stClass='st-done'; stText='Ho√†n th√†nh'; stIcon='fa-check'; }
        if(item.STATUS==='CANCEL') { stClass='st-cancel'; stText='H·ªßy'; stIcon='fa-ban'; }
        
        const total = item.TOTAL_COST || 0;
        const paid = item.PAID || 0;
        const debt = total - paid;
        if(debt > 0) totalDebt += debt;

        let issueText = "S·ª≠a ch·ªØa chung";
        try {
            const details = JSON.parse(item.DETAILS || '[]');
            if(details.length > 0) issueText = details.map(d => d.name).join(', ');
        } catch(e) {}
        
        const appointDate = item.APPOINT_DATE ? item.APPOINT_DATE.split(' ')[0] : '-';

        // Desktop Row
        const tr = document.createElement('tr');
        tr.className = "hover:bg-orange-50 transition-colors group border-b border-gray-100 bg-white desktop-row";
        tr.innerHTML = `
            <td class="p-3 text-center text-gray-400 text-xs">${i + 1}</td>
            <td class="p-3 text-xs font-mono text-gray-500">${item.DATE.split(' ')[0]}</td>
            <td class="p-3">
                <div class="font-bold text-gray-800 text-sm">${item.CUST_NAME}</div>
                <div class="text-xs text-gray-500 font-mono">${item.CUST_PHONE}</div>
            </td>
            <td class="p-3">
                <div class="font-bold text-orange-700 text-sm">${item.DEVICE}</div>
                <div class="text-xs text-gray-600 mt-1 italic line-clamp-1">${issueText}</div>
            </td>
            <td class="p-3 text-center text-xs text-blue-600 font-bold font-mono">${appointDate}</td>
            <td class="p-3 text-right">
                <div class="font-mono font-bold text-gray-800 text-sm">${formatMoney(total)}</div>
                ${debt > 0 ? `<div class="text-[10px] text-red-600 font-bold bg-red-50 px-1 rounded border border-red-100 mt-0.5 inline-block">N·ª£: ${formatMoney(debt)}</div>` : '<div class="text-[10px] text-green-600 font-bold">ƒê·ªß</div>'}
            </td>
            <td class="p-3 text-center"><span class="badge ${stClass}"><i class="fa-solid ${stIcon}"></i> ${stText}</span></td>
            <td class="p-3 text-center sticky right-0 bg-white group-hover:bg-orange-50 sticky-col-shadow">
                <button onclick="openMenu('${item.ID}')" class="text-gray-400 hover:text-orange-600 p-2"><i class="fa-solid fa-ellipsis-vertical text-lg"></i></button>
            </td>
        `;
        tbody.appendChild(tr);

        // Mobile Card
        const card = document.createElement('div');
        card.className = "bg-white p-3 rounded-lg shadow-sm border border-gray-100 mobile-card relative";
        card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-mono text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">${item.DATE.split(' ')[0]}</span>
                    <span class="badge ${stClass} scale-90 origin-left"><i class="fa-solid ${stIcon}"></i> ${stText}</span>
                </div>
                <button onclick="openMenu('${item.ID}')" class="text-gray-400 p-1"><i class="fa-solid fa-ellipsis-vertical"></i></button>
            </div>
            <div class="flex justify-between items-center mb-1">
                <div class="font-bold text-gray-800">${item.CUST_NAME}</div>
                <div class="font-bold text-orange-700 text-sm">${item.DEVICE}</div>
            </div>
            <div class="text-xs text-gray-600 italic mb-2 line-clamp-1">${issueText}</div>
            <div class="flex justify-between items-end border-t pt-2 border-gray-50">
                <div class="text-xs text-gray-500">
                    ${debt > 0 ? `<span class="text-red-600 font-bold">N·ª£: ${formatMoney(debt)}</span>` : '<span class="text-green-600 font-bold">ƒê√£ thanh to√°n</span>'}
                </div>
                <div class="font-mono font-bold text-gray-800">${formatMoney(total)}</div>
            </div>
        `;
        mobileList.appendChild(card);
    });

    qs('#statFixing').innerText = fixingCount;
    qs('#statDebt').innerText = formatMoney(totalDebt) + ' ‚Ç´';
}

// === MULTI-ITEM LOGIC (Updated with Cost) ===
function addItemRow(name='', price='', cost='') {
    const container = qs('#repairItemsBody');
    const div = document.createElement('div');
    div.className = "item-row flex gap-2 items-center mb-2";
    div.innerHTML = `
        <div class="flex-1 grid grid-cols-1 gap-1">
            <input type="text" class="w-full border-b border-dashed border-gray-300 focus:border-orange-500 outline-none text-sm item-name p-1 bg-transparent" placeholder="T√™n d·ªãch v·ª•..." value="${name}">
            <div class="flex gap-2 justify-end">
                <input type="text" class="w-24 border-b border-dashed border-gray-300 focus:border-orange-500 outline-none text-right font-bold text-gray-700 font-mono item-price p-1 bg-transparent text-sm" placeholder="Gi√° kh√°ch" onkeyup="formatCurrency(this); updateTotal()" value="${price}">
                <input type="text" class="w-20 border-b border-dashed border-red-200 focus:border-red-500 outline-none text-right text-red-400 font-mono text-xs item-cost p-1 bg-transparent" placeholder="V·ªën" onkeyup="formatCurrency(this); updateTotal()" value="${cost}">
            </div>
        </div>
        <button onclick="this.parentElement.remove(); updateTotal()" class="text-red-400 hover:text-red-600 w-6 self-start mt-1"><i class="fa-solid fa-times"></i></button>
    `;
    container.appendChild(div);
}

function updateTotal() {
    let total = 0;
    let totalCapital = 0;
    document.querySelectorAll('.item-row').forEach(row => {
        total += parseMoney(row.querySelector('.item-price').value);
        totalCapital += parseMoney(row.querySelector('.item-cost').value);
    });
    qs('#inp_total_cost').innerText = formatMoney(total);
    qs('#inp_total_capital').innerText = formatMoney(totalCapital);
    updateDebt();
}

function updateDebt() {
    const total = parseMoney(qs('#inp_total_cost').innerText);
    const paid = parseMoney(qs('#inp_paid').value);
    const debt = total - paid;
    qs('#inp_debt').innerText = formatMoney(debt);
    qs('#inp_debt').className = debt > 0 ? "w-full p-2 text-sm text-right font-bold text-red-600 bg-red-50 rounded border border-red-100" : "w-full p-2 text-sm text-right font-bold text-green-600 bg-green-50 rounded border border-green-100";
}

// Actions
function openModal(mode) {
    qs('#modal').classList.remove('hidden'); setTimeout(() => { qs('#modal').classList.remove('modal-hide'); qs('#modal').classList.add('modal-open'); }, 10);
    
    if(mode === 'add') {
        setVal('inp_id', ''); setVal('inp_phone', ''); setVal('inp_cust', ''); 
        setVal('inp_device', ''); setVal('inp_pwd', ''); 
        setVal('inp_paid', ''); setVal('inp_tech', ''); setVal('inp_status', 'PENDING'); setVal('inp_appoint', '');
        qs('#repairItemsBody').innerHTML = ''; 
        addItemRow(); 
        updateTotal();
        qs('#modalTitle').innerText = "Phi·∫øu Ti·∫øp Nh·∫≠n";
    }
}
function closeModal() { qs('#modal').classList.remove('modal-open'); qs('#modal').classList.add('modal-hide'); setTimeout(() => qs('#modal').classList.add('hidden'), 200); }

function openMenu(id) { qs('#actionSheet').classList.remove('hidden'); qs('#act_id').value = id; }
function closeMenu() { qs('#actionSheet').classList.add('hidden'); }

function handleAction(type) {
    const id = qs('#act_id').value;
    const item = allData.find(i => i.ID == id);
    closeMenu();
    
    if(type === 'print') {
        qs('#pr_date').innerText = item.DATE;
        qs('#pr_cust').innerText = item.CUST_NAME;
        qs('#pr_phone').innerText = item.CUST_PHONE;
        qs('#pr_device').innerText = item.DEVICE;
        qs('#pr_pwd').innerText = item.PWD;
        qs('#pr_total').innerText = formatMoney(item.TOTAL_COST);
        qs('#pr_paid').innerText = formatMoney(item.PAID);
        qs('#pr_debt').innerText = formatMoney(item.TOTAL_COST - item.PAID);
        
        const tbody = qs('#pr_items_body');
        tbody.innerHTML = '';
        let details = [];
        try { details = JSON.parse(item.DETAILS || '[]'); } catch(e){}
        
        details.forEach(d => {
            tbody.innerHTML += `<tr><td class="border border-black p-2 align-top">${d.name}</td><td class="border border-black p-2 align-top text-right font-bold">${formatMoney(d.price)}</td></tr>`;
        });
        
        if(details.length === 0) tbody.innerHTML = `<tr><td class="border border-black p-2 h-20 align-top">S·ª≠a ch·ªØa theo y√™u c·∫ßu</td><td class="border border-black p-2 h-20 align-top text-right font-bold">${formatMoney(item.TOTAL_COST)}</td></tr>`;

        qs('#printReceiptModal').classList.remove('hidden');
    }
    if(type === 'edit') {
        openModal();
        qs('#modalTitle').innerText = "C·∫≠p Nh·∫≠t Phi·∫øu";
        setVal('inp_id', item.ID);
        setVal('inp_phone', item.CUST_PHONE); setVal('inp_cust', item.CUST_NAME);
        setVal('inp_device', item.DEVICE); setVal('inp_pwd', item.PWD);
        setVal('inp_paid', formatMoney(item.PAID));
        setVal('inp_tech', item.TECH);
        setVal('inp_status', item.STATUS); 
        if(item.APPOINT_DATE) setVal('inp_appoint', item.APPOINT_DATE.split(' ')[0]);
        
        qs('#repairItemsBody').innerHTML = '';
        let details = [];
        try { details = JSON.parse(item.DETAILS || '[]'); } catch(e){}
        if(details.length > 0) {
            details.forEach(d => addItemRow(d.name, formatMoney(d.price), formatMoney(d.cost || 0)));
        } else {
            addItemRow(); 
        }
        updateTotal();
    }
    if(type === 'delete') {
        if(confirm("X√≥a phi·∫øu n√†y?")) {
            allData = allData.filter(i => i.ID != id);
            renderTable(allData);
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete_repair', ID: id }) })
            .catch(e => { alert("L·ªói x√≥a: " + e.message); loadData(); });
        }
    }
}
function closePrint() { qs('#printReceiptModal').classList.add('hidden'); }

async function saveData() {
    const btn = qs('#btnSave');
    const oldText = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang l∆∞u...';
    btn.disabled = true;

    try {
        const items = [];
        document.querySelectorAll('.item-row').forEach(row => {
            const name = row.querySelector('.item-name').value.trim();
            const price = parseMoney(row.querySelector('.item-price').value);
            const cost = parseMoney(row.querySelector('.item-cost').value);
            if(name) items.push({ name, price, cost });
        });

        const body = {
            action: 'save_repair',
            ID: getVal('inp_id'),
            CUST_PHONE: getVal('inp_phone'), CUST_NAME: getVal('inp_cust'),
            DEVICE: getVal('inp_device'), PWD: getVal('inp_pwd'), 
            DETAILS: items, 
            TOTAL_COST: parseMoney(qs('#inp_total_cost').innerText), 
            PAID: parseMoney(getVal('inp_paid')),
            TECH: getVal('inp_tech'), STATUS: getVal('inp_status'), APPOINT_DATE: getVal('inp_appoint')
        };
        
        const res = await fetch(API_URL, { method: 'POST', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(body) });
        const json = await res.json();

        if(json.success) {
            const newItem = {
                ID: body.ID || json.ID,
                DATE: body.ID ? (allData.find(i=>i.ID==body.ID)?.DATE || 'V·ª´a xong') : 'V·ª´a xong',
                CUST_NAME: body.CUST_NAME, CUST_PHONE: body.CUST_PHONE,
                DEVICE: body.DEVICE, PWD: body.PWD,
                TOTAL_COST: body.TOTAL_COST, PAID: body.PAID,
                STATUS: body.STATUS, TECH: body.TECH, APPOINT_DATE: body.APPOINT_DATE,
                DETAILS: JSON.stringify(body.DETAILS)
            };

            if(body.ID) {
                const idx = allData.findIndex(i => i.ID == body.ID);
                if(idx !== -1) allData[idx] = newItem;
            } else {
                allData.unshift(newItem);
            }
            
            renderTable(allData);
            closeModal();
        } else {
            alert("L·ªói t·ª´ server: " + json.message);
        }
    } catch(e) { 
        alert("L·ªói k·∫øt n·ªëi: " + e.message); 
    } finally {
        btn.innerHTML = oldText;
        btn.disabled = false;
    }
}

qs('#searchInput').addEventListener('input', () => renderTable(allData));
loadData();
</script>
</body>
</html>