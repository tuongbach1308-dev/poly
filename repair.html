<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n L√Ω S·ª≠a Ch·ªØa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
   
  <style>
    /* Base */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #fff7ed; }
    ::-webkit-scrollbar-thumb { background: #ea580c; border-radius: 4px; }
    body { font-family: 'Roboto', sans-serif; background-color: #fff7ed; }
    
    .modal-open { opacity: 1; transform: scale(1); pointer-events: auto; }
    .modal-hide { opacity: 0; transform: scale(0.95); pointer-events: none; }
    .sticky-col-shadow { box-shadow: -4px 0 10px -4px rgba(0,0,0,0.1); }
    
    /* Status Badges */
    .badge { font-size: 10px; font-weight: bold; padding: 3px 8px; border-radius: 12px; text-transform: uppercase; white-space: nowrap; display: inline-flex; align-items: center; gap: 4px; }
    .st-pending { background: #fef9c3; color: #b45309; border: 1px solid #fcd34d; }
    .st-fixing { background: #dbeafe; color: #1d4ed8; border: 1px solid #93c5fd; }
    .st-wait { background: #f3e8ff; color: #7e22ce; border: 1px solid #d8b4fe; }
    .st-done { background: #dcfce7; color: #15803d; border: 1px solid #86efac; }
    .st-cancel { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }

    /* Print */
    @media print {
        body > *:not(#printReceiptModal) { display: none !important; }
        #printReceiptModal { display: block !important; position: absolute; top: 0; left: 0; width: 100%; height: auto; background: white; z-index: 9999; }
        .no-print { display: none !important; }
        .page-a5 { width: 148mm; min-height: 210mm; padding: 10mm; margin: 0 auto; border: none; box-shadow: none; }
    }
    .page-a5 { width: 148mm; min-height: 210mm; background: white; padding: 10mm; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-family: 'Times New Roman', serif; color: #000; }
  </style>
</head>
<body class="text-gray-800">

<div class="p-4 w-full max-w-[1600px] mx-auto pb-24 no-print">
   
  <!-- Header & Stats -->
  <div class="bg-white p-5 rounded-xl shadow-sm border border-orange-100 mb-4">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 border-b border-gray-100 pb-4 gap-4">
      <div>
        <h1 class="text-xl md:text-2xl font-bold text-orange-700 flex items-center gap-2">
          <i class="fa-solid fa-screwdriver-wrench"></i> D·ªãch V·ª• S·ª≠a Ch·ªØa
        </h1>
        <p class="text-gray-500 text-xs mt-1">Qu·∫£n l√Ω ti·∫øp nh·∫≠n, c√¥ng n·ª£ & l·ª£i nhu·∫≠n</p>
      </div>
      
      <!-- Quick Stats -->
      <div class="flex flex-wrap gap-4 text-center">
          <div class="bg-red-50 px-3 py-1 rounded-lg border border-red-100">
              <div class="text-[10px] text-gray-500 uppercase font-bold">Kh√°ch n·ª£</div>
              <div class="text-lg font-bold text-red-600" id="statDebt">0 ‚Ç´</div>
          </div>
          <div class="bg-orange-50 px-3 py-1 rounded-lg border border-orange-100 hidden md:block">
              <div class="text-[10px] text-gray-500 uppercase font-bold">ƒêang s·ª≠a</div>
              <div class="text-lg font-bold text-orange-600" id="statFixing">0</div>
          </div>
          <div class="bg-green-50 px-3 py-1 rounded-lg border border-green-100 hidden md:block">
              <div class="text-[10px] text-gray-500 uppercase font-bold">T·ªïng L·ª£i Nhu·∫≠n</div>
              <div class="text-lg font-bold text-green-600" id="statProfit">0 ‚Ç´</div>
          </div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="flex flex-col md:flex-row gap-3">
        <div class="relative flex-1">
            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input id="searchInput" type="text" oninput="renderTable(allData)" placeholder="T√¨m kh√°ch n·ª£, SƒêT, m√°y..."
            class="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 transition-all shadow-sm text-gray-700" />
        </div>
        
        <!-- B·ªô l·ªçc Th·ªùi Gian M·ªõi -->
        <select id="filterTime" onchange="renderTable(allData)" class="border border-gray-200 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-orange-500 text-gray-700 font-bold bg-white cursor-pointer shadow-sm">
            <option value="ALL">üìÖ T·∫•t c·∫£ th·ªùi gian</option>
            <option value="THIS_WEEK">Tu·∫ßn n√†y</option>
            <option value="THIS_MONTH">Th√°ng n√†y</option>
            <option value="THIS_QUARTER">Qu√Ω n√†y</option>
        </select>

        <select id="filterStatus" onchange="renderTable(allData)" class="border border-gray-200 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-orange-500 text-gray-700 font-bold bg-white cursor-pointer shadow-sm">
            <option value="ALL">üìã T·∫•t c·∫£ phi·∫øu</option>
            <option value="DEBT">‚ö†Ô∏è Kh√°ch n·ª£ ti·ªÅn</option>
            <option value="PENDING">‚è≥ Ch·ªù ki·ªÉm tra</option>
            <option value="FIXING">üõ†Ô∏è ƒêang s·ª≠a</option>
            <option value="WAIT_PAY">üì¶ Ch·ªù tr·∫£ kh√°ch</option>
            <option value="DONE">‚úÖ Ho√†n th√†nh</option>
        </select>

        <div class="flex gap-2 shrink-0">
            <button onclick="loadData()" class="px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors shadow-sm"><i class="fa-solid fa-rotate"></i></button>
            <button onclick="openModal('add')" class="px-5 py-2.5 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-bold transition-colors shadow-lg flex items-center gap-2">
                <i class="fa-solid fa-plus-circle"></i> <span class="hidden sm:inline">Ti·∫øp Nh·∫≠n</span>
            </button>
        </div>
    </div>
  </div>

  <!-- Table -->
  <div class="relative bg-white rounded-xl shadow border border-orange-100 overflow-hidden flex flex-col" style="min-height: 500px;">
    <div id="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-50">
        <i class="fa-solid fa-circle-notch fa-spin text-3xl text-orange-500 mb-2"></i>
        <span class="text-gray-500 font-medium animate-pulse">ƒêang t·∫£i d·ªØ li·ªáu...</span>
    </div>
    
    <div class="overflow-x-auto custom-scrollbar flex-1">
        <table class="min-w-full text-left border-collapse">
            <thead class="bg-orange-600 text-white text-xs uppercase sticky top-0 z-20 shadow-md">
                <tr>
                    <th class="p-3 text-center w-12">#</th>
                    <th class="p-3 w-24">Ng√†y Nh·∫≠n</th>
                    <th class="p-3 w-40">Kh√°ch H√†ng</th>
                    <th class="p-3 min-w-[200px]">Thi·∫øt B·ªã & L·ªói</th>
                    <th class="p-3 w-24 text-center">Ng√†y H·∫πn</th>
                    <th class="p-3 text-right w-32">Thanh To√°n</th>
                    <!-- C·ªôt L·ª£i Nhu·∫≠n M·ªõi -->
                    <th class="p-3 text-right w-24">L·ª£i Nhu·∫≠n</th>
                    <th class="p-3 text-center w-32">Tr·∫°ng Th√°i</th>
                    <th class="p-3 text-center w-16 sticky right-0 bg-orange-600 sticky-col-shadow">X·ª≠ L√Ω</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="divide-y divide-gray-100 text-gray-700 text-sm"></tbody>
        </table>
    </div>
  </div>
</div>

<!-- ================= MODAL TI·∫æP NH·∫¨N / S·ª¨A (N√ÇNG C·∫§P ƒêA M√ìN) ================= -->
<div id="modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center transition-opacity duration-200 modal-hide backdrop-blur-sm no-print hidden">
  <div class="bg-white w-full max-w-4xl rounded-xl shadow-2xl flex flex-col max-h-[95vh] overflow-hidden transform transition-all duration-200 scale-95">
    <div class="bg-orange-600 p-4 flex justify-between items-center text-white shrink-0">
        <h2 class="text-lg font-bold flex items-center gap-2"><i class="fa-solid fa-file-pen"></i> <span id="modalTitle">Phi·∫øu Ti·∫øp Nh·∫≠n</span></h2>
        <button onclick="closeModal()" class="text-orange-100 hover:text-white text-2xl">&times;</button>
    </div>
    
    <div class="p-6 overflow-y-auto grow bg-gray-50 space-y-4">
        <input type="hidden" id="inp_id">

        <!-- Th√¥ng tin chung -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="text-xs font-bold text-orange-700 uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-user"></i> Kh√°ch h√†ng</div>
                <div class="grid grid-cols-1 gap-3">
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">SƒêT</label><input type="text" id="inp_phone" class="w-full border p-2 rounded focus:border-orange-500 outline-none font-bold font-mono text-orange-800" placeholder="09xxxx"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">T√™n</label><input type="text" id="inp_cust" class="w-full border p-2 rounded focus:border-orange-500 outline-none" placeholder="Nh·∫≠p t√™n..."></div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="text-xs font-bold text-orange-700 uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-mobile-screen"></i> Thi·∫øt b·ªã</div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1">T√™n M√°y</label><input type="text" id="inp_device" class="w-full border p-2 rounded focus:border-orange-500 outline-none font-bold" placeholder="VD: iPhone 14 Pro"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">M·∫≠t Kh·∫©u</label><input type="text" id="inp_pwd" class="w-full border p-2 rounded focus:border-orange-500 outline-none bg-yellow-50 text-red-600 font-mono font-bold" placeholder="123456"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">K·ªπ Thu·∫≠t</label><select id="inp_tech" class="w-full border p-2 rounded focus:border-orange-500 bg-white"><option>--</option><option>KTV Huy</option><option>KTV T√πng</option></select></div>
                </div>
            </div>
        </div>

        <!-- Chi ti·∫øt s·ª≠a ch·ªØa (ƒêA M√ìN) -->
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
            <div class="flex justify-between items-center mb-2">
                <div class="text-xs font-bold text-orange-700 uppercase flex items-center gap-2"><i class="fa-solid fa-list-check"></i> H·∫°ng m·ª•c s·ª≠a ch·ªØa</div>
                <button onclick="addItemRow()" class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded border border-green-200 hover:bg-green-100 font-bold"><i class="fa-solid fa-plus"></i> Th√™m d√≤ng</button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm border-collapse">
                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase text-left">
                        <tr>
                            <th class="p-2 w-8">#</th>
                            <th class="p-2">N·ªôi dung s·ª≠a ch·ªØa / Linh ki·ªán</th>
                            <th class="p-2 w-32 text-right">Gi√° Kh√°ch</th>
                            <!-- Th√™m c·ªôt V·ªën -->
                            <th class="p-2 w-28 text-right text-red-500">V·ªën (G·ªëc)</th>
                            <th class="p-2 w-8"></th>
                        </tr>
                    </thead>
                    <tbody id="repairItemsBody">
                        <!-- Rows will be added here -->
                    </tbody>
                    <tfoot class="font-bold text-gray-700 border-t">
                        <tr>
                            <td colspan="2" class="p-2 text-right">T·ªîNG C·ªòNG:</td>
                            <td class="p-2 text-right text-lg text-orange-600" id="inp_total_cost">0</td>
                            <td class="p-2 text-right text-xs text-gray-400 italic" id="inp_total_capital">V·ªën: 0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Thanh to√°n & Tr·∫°ng th√°i -->
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-end">
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Kh√°ch ƒë√£ tr·∫£</label>
                    <input type="text" id="inp_paid" onkeyup="formatCurrency(this); updateDebt();" class="w-full border p-2 rounded focus:border-orange-500 outline-none font-bold text-right text-green-600" placeholder="0">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">C√≤n n·ª£</label>
                    <div id="inp_debt" class="w-full p-2 text-right font-bold text-red-600 bg-red-50 rounded border border-red-100">0</div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Tr·∫°ng Th√°i</label>
                    <select id="inp_status" class="w-full border p-2 rounded focus:border-orange-500 bg-white font-bold text-gray-700">
                        <option value="PENDING">‚è≥ Ch·ªù ki·ªÉm tra</option>
                        <option value="FIXING">üõ†Ô∏è ƒêang s·ª≠a</option>
                        <option value="WAIT_PAY">üì¶ Ch·ªù tr·∫£ kh√°ch</option>
                        <option value="DONE">‚úÖ Ho√†n th√†nh</option>
                        <option value="CANCEL">‚ùå H·ªßy / Tr·∫£ l·∫°i</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Ng√†y H·∫πn</label>
                    <input type="date" id="inp_appoint" class="w-full border p-2 rounded focus:border-orange-500">
                </div>
            </div>
        </div>
    </div>

    <div class="p-4 border-t bg-white flex justify-end gap-3 shrink-0">
        <button onclick="closeModal()" class="px-5 py-2 border rounded-lg hover:bg-gray-100 text-gray-600 font-bold">H·ªßy</button>
        <button onclick="saveData()" id="btnSave" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 shadow-lg font-bold transition transform active:scale-95"><i class="fa-solid fa-save mr-1"></i> L∆∞u Phi·∫øu</button>
    </div>
  </div>
</div>

<!-- ================= MODAL BI√äN NH·∫¨N (IN A5) ================= -->
<div id="printReceiptModal" class="fixed inset-0 bg-white z-[60] hidden overflow-auto flex justify-center p-8">
    <div class="page-a5 relative">
        <button onclick="closePrint()" class="no-print absolute top-0 right-0 text-gray-400 hover:text-red-500 text-3xl">&times;</button>
        <div class="text-center border-b-2 border-black pb-2 mb-4">
            <h1 class="text-2xl font-bold uppercase">POLY STORE</h1>
            <p class="text-sm">ƒê/c: 170/4/2 B√πi ƒê√¨nh T√∫y, P.12, Q. B√¨nh Th·∫°nh</p>
            <p class="text-sm font-bold">Hotline: 0902.96.0804</p>
            <h2 class="text-xl font-bold uppercase mt-4 border-2 border-black inline-block px-4 py-1">BI√äN NH·∫¨N S·ª¨A CH·ªÆA</h2>
            <p class="text-sm italic mt-1">Ng√†y nh·∫≠n: <span id="pr_date"></span></p>
        </div>
        <div class="text-sm space-y-2 mb-4">
            <div class="flex"><span class="w-24 font-bold">Kh√°ch h√†ng:</span> <span class="border-b border-dotted border-black flex-1 font-bold" id="pr_cust"></span></div>
            <div class="flex"><span class="w-24 font-bold">ƒêi·ªán tho·∫°i:</span> <span class="border-b border-dotted border-black flex-1 font-bold" id="pr_phone"></span></div>
            <div class="flex"><span class="w-24 font-bold">Thi·∫øt b·ªã:</span> <span class="border-b border-dotted border-black flex-1 font-bold" id="pr_device"></span></div>
            <div class="flex"><span class="w-24 font-bold">T√¨nh tr·∫°ng:</span> <span class="border-b border-dotted border-black flex-1 italic" id="pr_issue"></span></div>
            <div class="flex"><span class="w-24 font-bold">M·∫≠t kh·∫©u:</span> <span class="border-b border-dotted border-black flex-1 font-mono font-bold" id="pr_pwd"></span></div>
        </div>
        
        <table class="w-full border-collapse border border-black text-sm mb-4">
            <thead><tr class="bg-gray-200"><th class="border border-black p-1 text-center">N·ªôi dung s·ª≠a ch·ªØa</th><th class="border border-black p-1 text-center w-24">Chi ph√≠</th></tr></thead>
            <tbody id="pr_items_body">
                <!-- Items will be injected here -->
            </tbody>
            <tfoot>
                <tr><td class="border border-black p-1 text-right font-bold">T·ªïng c·ªông:</td><td class="border border-black p-1 text-right font-bold" id="pr_total"></td></tr>
                <tr><td class="border border-black p-1 text-right italic">ƒê√£ thanh to√°n:</td><td class="border border-black p-1 text-right italic" id="pr_paid"></td></tr>
                <tr><td class="border border-black p-1 text-right font-bold text-red-600">C√≤n l·∫°i:</td><td class="border border-black p-1 text-right font-bold text-red-600" id="pr_debt"></td></tr>
            </tfoot>
        </table>

        <div class="text-xs space-y-1 mb-6"><p><strong>L∆∞u √Ω:</strong></p><ul class="list-disc pl-4 italic"><li>Vui l√≤ng ki·ªÉm tra k·ªπ ngo·∫°i h√¨nh m√°y tr∆∞·ªõc khi r·ªùi c·ª≠a h√†ng.</li><li>C·ª≠a h√†ng kh√¥ng ch·ªãu tr√°ch nhi·ªám d·ªØ li·ªáu c√° nh√¢n.</li><li>B·∫£o h√†nh theo tem d√°n tr√™n m√°y.</li></ul></div>
        <div class="flex justify-between text-center mt-10"><div><p class="font-bold">Kh√°ch h√†ng</p></div><div><p class="font-bold">Nh√¢n vi√™n ti·∫øp nh·∫≠n</p></div></div>
        <div class="no-print mt-10 text-center"><button onclick="window.print()" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg"><i class="fa-solid fa-print"></i> IN NGAY</button></div>
    </div>
</div>

<!-- Action Menu (Mobile) -->
<div id="actionSheet" class="fixed inset-0 bg-black/50 z-40 hidden flex items-end justify-center" onclick="closeMenu()">
    <div class="bg-white w-full max-w-md rounded-t-2xl overflow-hidden" onclick="event.stopPropagation()">
        <input type="hidden" id="act_id">
        <div class="bg-gray-100 p-3 text-center font-bold text-gray-700 border-b">Thao T√°c</div>
        <div class="p-4 space-y-3">
             <button onclick="handleAction('print')" class="w-full py-3 bg-blue-50 text-blue-700 rounded-xl font-bold flex items-center justify-center gap-3"><i class="fa-solid fa-print"></i> In Bi√™n Nh·∫≠n</button>
             <button onclick="handleAction('edit')" class="w-full py-3 bg-orange-50 text-orange-700 rounded-xl font-bold flex items-center justify-center gap-3"><i class="fa-solid fa-pen"></i> S·ª≠a / Thanh To√°n</button>
             <button onclick="handleAction('delete')" class="w-full py-3 bg-red-50 text-red-600 rounded-xl font-bold flex items-center justify-center gap-3"><i class="fa-solid fa-trash"></i> X√≥a Phi·∫øu</button>
        </div>
    </div>
</div>

<script>
// !!! QUAN TR·ªåNG: H√£y ƒë·∫£m b·∫£o API_URL b√™n d∆∞·ªõi l√† link Web App c·ªßa B·∫†N sau khi Deploy l·∫°i !!!
const API_URL = 'https://script.google.com/macros/s/AKfycbwn-uSc2DnJIh5xRtLyROGKUFrh7_hgMGkNNpG2vShy8Ug6zJI7iB33NhNnReTKbgRhzw/exec'; 

let allData = [];
const qs = (s) => document.querySelector(s);
const getVal = (id) => document.getElementById(id).value;
const setVal = (id, val) => document.getElementById(id).value = val;
const formatMoney = (n) => n ? Number(String(n).replace(/\D/g, '')).toLocaleString('vi-VN') : '0';
function formatCurrency(input) { let val = input.value.replace(/\D/g, ''); input.value = val ? Number(val).toLocaleString('vi-VN') : ''; }
const parseMoney = (n) => n ? Number(String(n).replace(/\D/g, '')) : 0;

// === LOAD DATA ===
async function loadData() {
    qs('#loading').classList.remove('hidden');
    try {
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "get_repairs" }) });
        const json = await res.json();
        if(json.success) {
            allData = json.data;
            renderTable(allData);
            
            // Stats logic moved to renderTable for consistency
        }
    } catch(e) { console.error(e); }
    qs('#loading').classList.add('hidden');
}

// === CHECK TIME FILTER ===
function checkTimeFilter(dateStr, filter) {
    if (filter === 'ALL') return true;
    if (!dateStr) return false;
    
    // Parse dd/MM/yyyy
    const parts = dateStr.split(' ')[0].split('/');
    if (parts.length !== 3) return false;
    
    const d = new Date(parts[2], parts[1] - 1, parts[0]);
    const now = new Date();
    const nowYear = now.getFullYear();
    const nowMonth = now.getMonth();
    
    now.setHours(0,0,0,0);
    
    if (filter === 'THIS_MONTH') {
        return d.getMonth() === nowMonth && d.getFullYear() === nowYear;
    }
    
    if (filter === 'THIS_WEEK') {
        const currentDay = now.getDay(); // 0=Sun, 1=Mon...
        const distanceToMonday = currentDay === 0 ? 6 : currentDay - 1;
        const monday = new Date(now);
        monday.setDate(now.getDate() - distanceToMonday);
        return d >= monday;
    }
    
    if (filter === 'THIS_QUARTER') {
        const qNow = Math.floor(nowMonth / 3);
        const qDate = Math.floor(d.getMonth() / 3);
        return qNow === qDate && d.getFullYear() === nowYear;
    }
    
    return true;
}

function renderTable(data) {
    const tbody = qs('#tableBody');
    tbody.innerHTML = '';
    const k = qs('#searchInput').value.toLowerCase().trim();
    const st = qs('#filterStatus').value;
    const tf = qs('#filterTime').value; // Get Time Filter

    let fixingCount = 0;
    let totalDebt = 0;
    let totalProfit = 0;

    const filtered = data.filter(i => {
        const text = (String(i.CUST_NAME||'') + " " + String(i.CUST_PHONE||'') + " " + String(i.DEVICE||'')).toLowerCase();
        const matchText = text.includes(k);
        const matchTime = checkTimeFilter(i.DATE, tf); // Check Time
        
        let matchStatus = true;
        if (st === 'DEBT') {
            matchStatus = (i.TOTAL_COST - i.PAID) > 0;
        } else if (st !== 'ALL') {
            matchStatus = i.STATUS === st;
        }
        return matchText && matchStatus && matchTime;
    });

    if(filtered.length === 0) { tbody.innerHTML = `<tr><td colspan="9" class="p-8 text-center text-gray-400">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`; }

    filtered.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-orange-50 transition-colors group border-b border-gray-100 bg-white";
        
        let stClass = 'st-pending', stText = 'Ch·ªù x·ª≠ l√Ω', stIcon = 'fa-hourglass';
        if(item.STATUS==='FIXING') { stClass='st-fixing'; stText='ƒêang s·ª≠a'; stIcon='fa-wrench'; fixingCount++; }
        if(item.STATUS==='WAIT_PAY') { stClass='st-wait'; stText='Ch·ªù tr·∫£'; stIcon='fa-box'; }
        if(item.STATUS==='DONE') { stClass='st-done'; stText='Ho√†n th√†nh'; stIcon='fa-check'; }
        if(item.STATUS==='CANCEL') { stClass='st-cancel'; stText='H·ªßy'; stIcon='fa-ban'; }
        
        const total = item.TOTAL_COST || 0;
        const paid = item.PAID || 0;
        const debt = total - paid;
        if(debt > 0) totalDebt += debt;

        // T√≠nh V·ªën & L·ª£i Nhu·∫≠n
        let issueText = "Chi ti·∫øt xem phi·∫øu";
        let costPrice = 0; // V·ªën
        try {
            const details = JSON.parse(item.DETAILS || '[]');
            if(details.length > 0) {
                issueText = details.map(d => d.name).join(', ');
                details.forEach(d => costPrice += (d.cost || 0));
            }
        } catch(e) {}
        
        const profit = total - costPrice;
        totalProfit += profit;
        
        const appointDate = item.APPOINT_DATE ? item.APPOINT_DATE.split(' ')[0] : '-';

        tr.innerHTML = `
            <td class="p-3 text-center text-gray-400 text-xs">${i + 1}</td>
            <td class="p-3 text-xs font-mono text-gray-500">${item.DATE.split(' ')[0]}</td>
            <td class="p-3">
                <div class="font-bold text-gray-800">${item.CUST_NAME}</div>
                <div class="text-xs text-gray-500 font-mono">${item.CUST_PHONE}</div>
            </td>
            <td class="p-3">
                <div class="font-bold text-orange-700 text-sm">${item.DEVICE}</div>
                <div class="text-xs text-gray-600 mt-1 italic line-clamp-1">${issueText}</div>
            </td>
            <td class="p-3 text-center text-xs text-blue-600 font-bold font-mono">${appointDate}</td>

            <!-- C·ªôt T√†i Ch√≠nh -->
            <td class="p-3 text-right">
                <div class="font-mono font-bold text-gray-800 text-sm">${formatMoney(total)}</div>
                ${debt > 0 ? `<div class="text-[10px] text-red-600 font-bold bg-red-50 px-1 rounded border border-red-100 mt-0.5">N·ª£: ${formatMoney(debt)}</div>` : '<div class="text-[10px] text-green-600 font-bold">ƒê·ªß</div>'}
            </td>
            
            <!-- C·ªôt L·ª£i Nhu·∫≠n -->
             <td class="p-3 text-right">
                <div class="font-mono font-bold text-green-600 text-sm">${formatMoney(profit)}</div>
                <div class="text-[10px] text-gray-400 italic">V·ªën: ${formatMoney(costPrice)}</div>
            </td>

            <td class="p-3 text-center"><span class="badge ${stClass}"><i class="fa-solid ${stIcon}"></i> ${stText}</span></td>
            <td class="p-3 text-center sticky right-0 bg-white group-hover:bg-orange-50 sticky-col-shadow">
                <button onclick="openMenu('${item.ID}')" class="text-gray-400 hover:text-orange-600 p-2"><i class="fa-solid fa-ellipsis-vertical text-lg"></i></button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    // Update Stats
    qs('#statFixing').innerText = fixingCount;
    qs('#statDebt').innerText = formatMoney(totalDebt) + ' ‚Ç´';
    qs('#statProfit').innerText = formatMoney(totalProfit) + ' ‚Ç´';
}

// === MULTI-ITEM LOGIC ===
function addItemRow(name='', price='', cost='') {
    const tbody = qs('#repairItemsBody');
    const tr = document.createElement('tr');
    tr.className = "item-row border-b border-gray-100";
    tr.innerHTML = `
        <td class="p-2 text-center text-gray-400 text-xs">#</td>
        <td class="p-2"><input type="text" class="w-full border-b border-dashed border-gray-300 focus:border-orange-500 outline-none text-sm item-name" placeholder="Nh·∫≠p t√™n d·ªãch v·ª•/linh ki·ªán..." value="${name}"></td>
        <td class="p-2"><input type="text" class="w-full border-b border-dashed border-gray-300 focus:border-orange-500 outline-none text-right font-bold text-gray-700 font-mono item-price" placeholder="0" onkeyup="formatCurrency(this); updateTotal()" value="${price}"></td>
        <td class="p-2"><input type="text" class="w-full border-b border-dashed border-red-200 focus:border-red-500 outline-none text-right text-red-500 font-mono item-cost text-xs" placeholder="0" onkeyup="formatCurrency(this); updateTotal()" value="${cost}"></td>
        <td class="p-2 text-center"><button onclick="this.parentElement.parentElement.remove(); updateTotal()" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-times"></i></button></td>
    `;
    tbody.appendChild(tr);
}

function updateTotal() {
    let total = 0;
    let totalCapital = 0;
    document.querySelectorAll('.item-row').forEach(row => {
        total += parseMoney(row.querySelector('.item-price').value);
        totalCapital += parseMoney(row.querySelector('.item-cost').value);
    });
    qs('#inp_total_cost').innerText = formatMoney(total);
    qs('#inp_total_capital').innerText = "V·ªën: " + formatMoney(totalCapital);
    updateDebt();
}

function updateDebt() {
    const total = parseMoney(qs('#inp_total_cost').innerText);
    const paid = parseMoney(qs('#inp_paid').value);
    const debt = total - paid;
    qs('#inp_debt').innerText = formatMoney(debt);
    qs('#inp_debt').className = debt > 0 ? "w-full p-2 text-right font-bold text-red-600 bg-red-50 rounded border border-red-100" : "w-full p-2 text-right font-bold text-green-600 bg-green-50 rounded border border-green-100";
}

// Actions
function openModal(mode) {
    qs('#modal').classList.remove('hidden'); setTimeout(() => { qs('#modal').classList.remove('modal-hide'); qs('#modal').classList.add('modal-open'); }, 10);
    
    // Reset form
    if(mode === 'add') {
        setVal('inp_id', ''); setVal('inp_phone', ''); setVal('inp_cust', ''); 
        setVal('inp_device', ''); setVal('inp_pwd', ''); 
        setVal('inp_paid', ''); setVal('inp_tech', ''); setVal('inp_status', 'PENDING'); setVal('inp_appoint', '');
        qs('#repairItemsBody').innerHTML = ''; 
        addItemRow(); 
        updateTotal();
        qs('#modalTitle').innerText = "Phi·∫øu Ti·∫øp Nh·∫≠n";
    }
}
function closeModal() { qs('#modal').classList.remove('modal-open'); qs('#modal').classList.add('modal-hide'); setTimeout(() => qs('#modal').classList.add('hidden'), 200); }

function openMenu(id) { qs('#actionSheet').classList.remove('hidden'); qs('#act_id').value = id; }
function closeMenu() { qs('#actionSheet').classList.add('hidden'); }

function handleAction(type) {
    const id = qs('#act_id').value;
    const item = allData.find(i => i.ID == id);
    closeMenu();
    
    if(type === 'print') {
        qs('#pr_date').innerText = item.DATE;
        qs('#pr_cust').innerText = item.CUST_NAME;
        qs('#pr_phone').innerText = item.CUST_PHONE;
        qs('#pr_device').innerText = item.DEVICE;
        qs('#pr_pwd').innerText = item.PWD;
        qs('#pr_total').innerText = formatMoney(item.TOTAL_COST);
        qs('#pr_paid').innerText = formatMoney(item.PAID);
        qs('#pr_debt').innerText = formatMoney(item.TOTAL_COST - item.PAID);
        
        const tbody = qs('#pr_items_body');
        tbody.innerHTML = '';
        let details = [];
        try { details = JSON.parse(item.DETAILS || '[]'); } catch(e){}
        
        details.forEach(d => {
            tbody.innerHTML += `<tr><td class="border border-black p-2 align-top">${d.name}</td><td class="border border-black p-2 align-top text-right font-bold">${formatMoney(d.price)}</td></tr>`;
        });
        
        if(details.length === 0) tbody.innerHTML = `<tr><td class="border border-black p-2 h-20 align-top">S·ª≠a ch·ªØa theo y√™u c·∫ßu</td><td class="border border-black p-2 h-20 align-top text-right font-bold">${formatMoney(item.TOTAL_COST)}</td></tr>`;

        qs('#printReceiptModal').classList.remove('hidden');
    }
    if(type === 'edit') {
        openModal();
        qs('#modalTitle').innerText = "C·∫≠p Nh·∫≠t Phi·∫øu";
        setVal('inp_id', item.ID);
        setVal('inp_phone', item.CUST_PHONE); setVal('inp_cust', item.CUST_NAME);
        setVal('inp_device', item.DEVICE); setVal('inp_pwd', item.PWD);
        setVal('inp_paid', formatMoney(item.PAID));
        setVal('inp_tech', item.TECH);
        setVal('inp_status', item.STATUS); 
        if(item.APPOINT_DATE) setVal('inp_appoint', item.APPOINT_DATE.split(' ')[0]);
        
        qs('#repairItemsBody').innerHTML = '';
        let details = [];
        try { details = JSON.parse(item.DETAILS || '[]'); } catch(e){}
        if(details.length > 0) {
            details.forEach(d => addItemRow(d.name, formatMoney(d.price), formatMoney(d.cost || 0)));
        } else {
            addItemRow(); 
        }
        updateTotal();
    }
    if(type === 'delete') {
        if(confirm("X√≥a phi·∫øu n√†y?")) {
            // Optimistic Delete
            allData = allData.filter(i => i.ID != id);
            renderTable(allData);
            
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete_repair', ID: id }) })
            .catch(e => { alert("L·ªói x√≥a: " + e.message); loadData(); });
        }
    }
}
function closePrint() { qs('#printReceiptModal').classList.add('hidden'); }

async function saveData() {
    const btn = qs('#btnSave');
    const oldText = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang l∆∞u...';
    btn.disabled = true;

    try {
        // Gather Items
        const items = [];
        document.querySelectorAll('.item-row').forEach(row => {
            const name = row.querySelector('.item-name').value.trim();
            const price = parseMoney(row.querySelector('.item-price').value);
            const cost = parseMoney(row.querySelector('.item-cost').value);
            if(name) items.push({ name, price, cost });
        });

        const body = {
            action: 'save_repair',
            ID: getVal('inp_id'),
            CUST_PHONE: getVal('inp_phone'), CUST_NAME: getVal('inp_cust'),
            DEVICE: getVal('inp_device'), PWD: getVal('inp_pwd'), 
            DETAILS: items, 
            TOTAL_COST: parseMoney(qs('#inp_total_cost').innerText), 
            PAID: parseMoney(getVal('inp_paid')),
            TECH: getVal('inp_tech'), STATUS: getVal('inp_status'), APPOINT_DATE: getVal('inp_appoint')
        };
        
        // G·ª≠i request
        const res = await fetch(API_URL, { method: 'POST', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(body) });
        const json = await res.json();

        if(json.success) {
            // Optimistic Update: C·∫≠p nh·∫≠t allData ngay l·∫≠p t·ª©c m√† KH√îNG g·ªçi loadData()
            const newItem = {
                ID: body.ID || json.ID, // ID c≈© ho·∫∑c ID m·ªõi t·ª´ server
                DATE: body.ID ? (allData.find(i=>i.ID==body.ID)?.DATE || 'V·ª´a xong') : 'V·ª´a xong',
                CUST_NAME: body.CUST_NAME, CUST_PHONE: body.CUST_PHONE,
                DEVICE: body.DEVICE, PWD: body.PWD,
                TOTAL_COST: body.TOTAL_COST, PAID: body.PAID,
                STATUS: body.STATUS, TECH: body.TECH, APPOINT_DATE: body.APPOINT_DATE,
                DETAILS: JSON.stringify(body.DETAILS)
            };

            if(body.ID) {
                // Edit
                const idx = allData.findIndex(i => i.ID == body.ID);
                if(idx !== -1) allData[idx] = newItem;
            } else {
                // Add new
                allData.unshift(newItem);
            }
            
            renderTable(allData);
            closeModal();
        } else {
            alert("L·ªói t·ª´ server: " + json.message);
        }
    } catch(e) { 
        alert("L·ªói k·∫øt n·ªëi: " + e.message); 
    } finally {
        btn.innerHTML = oldText;
        btn.disabled = false;
    }
}

qs('#searchInput').addEventListener('input', () => renderTable(allData));
loadData();
</script>
</body>
</html>