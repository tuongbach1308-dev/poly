<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n L√Ω Kho M√°y (Serial)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Times+New+Roman:wght@400;700&display=swap" rel="stylesheet">
   
  <style>
    /* --- CORE STYLES --- */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #15803d; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #14532d; }
    
    body { font-family: 'Roboto', sans-serif; }
    
    .modal-open { opacity: 1; transform: scale(1); pointer-events: auto; }
    .modal-hide { opacity: 0; transform: scale(0.95); pointer-events: none; }
    .sticky-col-shadow { box-shadow: -4px 0 10px -4px rgba(0,0,0,0.1); }

    /* Badges */
    .loc-badge { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; white-space: nowrap; display: inline-flex; align-items: center; gap: 4px; }
    .loc-kho { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
    .loc-cn1 { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
    .loc-cn2 { background: #ffedd5; color: #9a3412; border: 1px solid #fdba74; }
    .coc-badge { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; display: inline-block; white-space: nowrap; margin-right: 5px;}

    .custom-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #15803d; }
    .copy-feedback { animation: flash 0.5s; background-color: #dcfce7 !important; }
    @keyframes flash { 0% { background-color: #dcfce7; } 100% { background-color: transparent; } }

    /* --- CONTRACT PRINT STYLES --- */
    .page-container {
        width: 210mm; margin: 0 auto; background: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 20px;
        min-height: 297mm; padding: 0; box-sizing: border-box; position: relative; overflow: hidden;
    }
    .contract-sheet {
        font-family: 'Times New Roman', serif; width: 100%; height: 100%;
        position: relative; padding: 20mm 20mm; box-sizing: border-box; 
        font-size: 12pt; color: #000; line-height: 1.4;
    }
    .contract-header { text-align: center; font-weight: bold; text-transform: uppercase; margin-bottom: 15px; }
    .section-title { font-weight: bold; text-transform: uppercase; font-size: 11pt; margin-top: 10px; margin-bottom: 5px; background-color: #eee; padding: 4px; }
    .info-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .dotted-input { border-bottom: 1px dotted #000; display: inline-block; min-width: 50px; font-weight: bold; padding: 0 5px; }
    .asset-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 11pt; }
    .asset-table th, .asset-table td { border: 1px solid #000; padding: 6px; text-align: center; vertical-align: middle; }
    .asset-table th { background-color: #f3f4f6; font-weight: bold; }
    
    /* --- PRINT MEDIA QUERY --- */
    @media print {
        @page { size: A4 portrait; margin: 0; }
        body { background-color: white; height: auto !important; overflow: visible !important; }
        #main-layout, #modal, #depositModal, #actionSheet, #contract-toolbar, #contract-mobile-tabs, #reportModal { display: none !important; }
        
        #contractModal { position: static !important; width: 100% !important; height: auto !important; overflow: visible !important; background: white !important; display: block !important; z-index: 9999; }
        #contract-input-panel { display: none !important; }
        #contract-preview-panel { display: block !important; width: 100% !important; padding: 0 !important; margin: 0 !important; background: white !important; }
        #preview-wrapper { transform: none !important; width: 100% !important; }
        .page-container { box-shadow: none !important; margin: 0 !important; width: 210mm !important; height: 290mm !important; page-break-after: always !important; border: none !important; }
        .contract-sheet { padding: 10mm 15mm 5mm 15mm !important; }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen text-sm text-gray-800">

<!-- MAIN LAYOUT: KHO M√ÅY -->
<div id="main-layout" class="p-4 w-full max-w-[1600px] mx-auto pb-20">
  <!-- Header -->
  <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 mb-4">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 border-b border-gray-100 pb-4 gap-4">
      <div>
        <h1 class="text-xl md:text-2xl font-bold text-green-700 flex items-center gap-2">
          <i class="fa-solid fa-mobile-screen-button"></i> Kho M√°y
        </h1>
        <p class="text-gray-500 text-xs mt-1">Qu·∫£n l√Ω t·ªìn kho chi ti·∫øt</p>
      </div>
      <div class="text-right flex flex-col items-end">
        <div class="flex items-center gap-4">
             <div class="hidden">
                <div class="text-xs text-gray-400 uppercase font-bold">T·ªïng V·ªën</div>
                <div id="totalValue" class="text-xl font-bold text-red-600 leading-none">0 ‚Ç´</div>
             </div>
             <div class="md:block border-none pl-0"> 
                <div class="text-xs text-gray-400 uppercase font-bold">S·∫£n ph·∫©m</div>
                <div id="totalCount" class="text-3xl font-bold text-gray-800 leading-none">0</div>
             </div>
        </div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="flex flex-col xl:flex-row gap-3">
        <div class="relative flex-1">
            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input id="searchInput" type="text" oninput="applyFilter()" placeholder="T√¨m ki·∫øm SERI, T√™n m√°y..."
            class="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-all shadow-sm text-gray-700" />
        </div>
        
        <div class="flex gap-2 overflow-x-auto pb-1 xl:pb-0">
            <select id="filterType" onchange="applyFilter()" class="border border-gray-200 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-green-500 text-gray-700 font-bold bg-white cursor-pointer shadow-sm min-w-[120px]">
                <option value="ALL">üì¶ T·∫•t c·∫£ Lo·∫°i</option>
                <option value="PHONE">üì± PHONE</option>
                <option value="IPAD">üìü IPAD</option>
                <option value="PHUKIEN">üéß PHUKIEN (Seri)</option>
            </select>

            <select id="filterLocation" onchange="applyFilter()" class="border border-gray-200 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-green-500 text-gray-700 font-bold bg-white cursor-pointer shadow-sm min-w-[140px]">
                <option value="ALL">üè¢ T·∫•t c·∫£ Kho</option>
                <option value="KHO">üè† Kho T·ªïng</option>
                <option value="CN1">üìç CN 1</option>
                <option value="CN2">üìç CN 2</option>
            </select>
        </div>

        <div class="flex gap-2 shrink-0">
            <button id="btnCopyMulti" onclick="copySelectedItems()" class="hidden px-4 py-2.5 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg hover:bg-blue-100 font-bold transition-colors shadow-sm flex items-center gap-2">
                <i class="fa-regular fa-copy"></i> <span id="lblCopyMulti">Copy (0)</span>
            </button>

            <button onclick="exportToTxt()" class="px-4 py-2.5 bg-gray-100 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-200 font-medium transition-colors shadow-sm flex items-center gap-2" title="Xu·∫•t ra Notepad">
                <i class="fa-solid fa-file-lines"></i> TXT
            </button>
            
            <!-- N√öT T·∫†O PHI·∫æU THU -->
            <button onclick="openContractModal()" class="px-5 py-2.5 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-bold shadow-sm flex items-center gap-2 transition-transform active:scale-95">
                <i class="fa-solid fa-file-invoice"></i> <span class="hidden sm:inline">T·∫°o Phi·∫øu Thu</span>
            </button>

            <button onclick="loadData()" class="px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition-colors flex items-center gap-2 shadow-sm border border-gray-200">
                <i class="fa-solid fa-rotate"></i>
            </button>
        </div>
    </div>
  </div>

  <!-- Table Container -->
  <div class="relative bg-white rounded-xl shadow border border-gray-200 overflow-hidden flex flex-col" style="min-height: 500px;">
    <div id="loading" class="hidden absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-700 mb-3"></div>
        <span class="text-green-700 font-medium text-xs animate-pulse">ƒêang k·∫øt n·ªëi d·ªØ li·ªáu...</span>
    </div>

    <div class="overflow-x-auto custom-scrollbar flex-1">
        <table class="min-w-full text-left border-collapse">
            <thead class="bg-gray-800 text-white text-xs uppercase sticky top-0 z-20 shadow-md">
                <tr>
                    <th class="p-3 w-10 text-center">
                        <input type="checkbox" id="checkAll" onchange="toggleAll(this)" class="custom-checkbox align-middle">
                    </th>
                    <th class="p-3 text-center w-12">#</th>
                    <th class="p-3 w-28 text-center">V·ªä TR√ç</th>
                    <th class="p-3 w-32 font-bold">SERI / IMEI</th>
                    <th class="p-3 min-w-[350px]">TH√îNG TIN M√ÅY <span class="normal-case font-normal text-gray-400 italic ml-1">(Click ƒë·ªÉ copy)</span></th> 
                    <th class="p-3 w-40">GHI CH√ö</th>
                    <th class="p-3 text-center w-16 sticky right-0 bg-gray-800 sticky-col-shadow">X·ª≠ L√Ω</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="divide-y divide-gray-100 text-gray-700 text-sm">
                <!-- Data Render Here -->
            </tbody>
        </table>
    </div>
  </div>
</div>

<!-- ================= MODAL S·ª¨A TH√îNG TIN (Ch·ªâ c√≤n d√πng ƒë·ªÉ S·ª≠a) ================= -->
<div id="modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center transition-opacity duration-200 modal-hide backdrop-blur-sm hidden">
  <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden transform transition-all duration-200 scale-95">
    
    <div class="flex justify-between items-center p-4 border-b shrink-0 bg-green-50">
        <h2 class="text-lg font-bold text-green-800 flex items-center gap-2">
            <i class="fa-solid fa-pen-to-square"></i> <span id="modalTitle">S·ª≠a Th√¥ng Tin M√°y</span>
        </h2>
        <button onclick="closeModal()" class="text-gray-400 hover:text-red-500 text-xl">&times;</button>
    </div>

    <div class="p-6 overflow-y-auto flex-1 space-y-4">
        <input type="hidden" id="item_key">
        <div id="formSingle">
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2 md:col-span-1">
                    <label class="block text-xs font-bold text-green-700 mb-1">SERI / IMEI <span class="text-red-500">*</span></label>
                    <input type="text" id="inp_id" class="w-full border border-gray-300 rounded p-2 focus:border-green-500 outline-none uppercase font-mono font-bold" placeholder="Scan ho·∫∑c nh·∫≠p...">
                </div>
                <div class="col-span-2 md:col-span-1">
                    <label class="block text-xs font-bold text-green-700 mb-1">T√äN M√ÅY <span class="text-red-500">*</span></label>
                    <input type="text" id="inp_name" class="w-full border border-gray-300 rounded p-2 focus:border-green-500 outline-none" placeholder="VD: iPhone 14 Pro Max">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-4">
                 <div><label class="block text-xs font-bold text-gray-600 mb-1">Dung l∆∞·ª£ng</label><input type="text" id="inp_dl" class="w-full border p-2 rounded outline-none focus:border-green-500" list="list_dl"></div>
                 <div><label class="block text-xs font-bold text-gray-600 mb-1">M√†u s·∫Øc</label><input type="text" id="inp_color" class="w-full border p-2 rounded outline-none focus:border-green-500"></div>
                 <div><label class="block text-xs font-bold text-gray-600 mb-1">Sim/Wifi</label><input type="text" id="inp_sim" class="w-full border p-2 rounded outline-none focus:border-green-500"></div>
                 <div><label class="block text-xs font-bold text-gray-600 mb-1">T√¨nh tr·∫°ng</label><input type="text" id="inp_tt" class="w-full border p-2 rounded outline-none focus:border-green-500" placeholder="VD: 99"></div>
                 <div><label class="block text-xs font-bold text-gray-600 mb-1">Pin (%)</label><input type="number" id="inp_pin" class="w-full border p-2 rounded outline-none focus:border-green-500"></div>
                 <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">Lo·∫°i M√°y (Sheet)</label>
                    <select id="inp_type_device" class="w-full border p-2 rounded bg-white outline-none focus:border-green-500">
                        <option value="PHONE">PHONE (ƒêi·ªán tho·∫°i)</option>
                        <option value="IPAD">IPAD (M√°y t√≠nh b·∫£ng)</option>
                        <option value="PHUKIEN">PHUKIEN (C√≥ Seri)</option>
                    </select>
                 </div>
                 <div class="col-span-2 bg-yellow-50 p-2 rounded border border-yellow-200 hidden">
                    <label class="block text-xs font-bold text-yellow-800 mb-1">V·ªä TR√ç NH·∫¨P KHO</label>
                    <select id="inp_location" class="w-full border border-yellow-400 rounded p-2 focus:ring-2 focus:ring-yellow-500 outline-none bg-white font-bold text-gray-700 cursor-pointer">
                        <option value="KHO" selected>üè† KHO T·ªîNG (M·∫∑c ƒë·ªãnh)</option>
                        <option value="CN1">üè¢ CHI NH√ÅNH 1</option>
                        <option value="CN2">üè¢ CHI NH√ÅNH 2</option>
                    </select>
                </div>
            </div>

            <!-- Khung Gi√° B√°n & Gi√° Nh·∫≠p (Lu√¥n ·∫©n khi s·ª≠a, v√¨ ch·ªâ d√πng ƒë·ªÉ s·ª≠a) -->
            <div id="price_container" class="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded mt-4 hidden">
                <div>
                  <label class="block text-xs font-bold text-red-600 mb-1">GI√Å B√ÅN (ngh√¨n) üîí</label>
                  <input type="text" id="inp_giaban" class="w-full border border-red-300 rounded p-2 font-bold text-red-700 bg-gray-100 cursor-not-allowed outline-none" readonly onkeyup="formatCurrency(this)">
                </div>
                <div>
                  <label class="block text-xs font-bold text-green-700 mb-1">GI√Å NH·∫¨P (Gi√° V·ªën)</label>
                  <input type="text" id="inp_gianhap" class="w-full border border-green-300 rounded p-2 outline-none font-bold text-green-800 transition-colors" placeholder="VD: 15.000" onkeyup="formatCurrency(this)">
                </div>
            </div>
            
            <div class="mt-4">
                <label class="block text-xs font-bold text-gray-600 mb-1">Ghi ch√∫</label>
                <textarea id="inp_note" rows="2" class="w-full border border-gray-300 rounded p-2 outline-none focus:border-green-500"></textarea>
            </div>
        </div>
    </div>
    <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end gap-3 shrink-0">
      <button onclick="closeModal()" class="px-5 py-2 border rounded-lg hover:bg-gray-100 text-gray-600">H·ªßy</button>
      <button onclick="saveData()" class="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-lg font-medium transition transform active:scale-95">
        <i class="fa-solid fa-save mr-1"></i> L∆∞u D·ªØ Li·ªáu
      </button>
    </div>
  </div>
</div>

<!-- ================= MODAL T·∫†O & IN H·ª¢P ƒê·ªíNG ================= -->
<div id="contractModal" class="fixed inset-0 bg-white z-[60] hidden flex-col overflow-hidden">
    <!-- Header Modal H·ª£p ƒê·ªìng -->
    <div id="contract-toolbar" class="bg-blue-700 text-white p-3 shadow-md flex justify-between items-center shrink-0">
        <h2 class="text-lg font-bold flex items-center gap-2"><i class="fa-solid fa-file-contract"></i> T·∫°o Phi·∫øu Thu</h2>
        <div class="flex gap-2">
            <!-- N√öT M·ªöI: L∆ØU PHI·∫æU -->
            <button onclick="saveContractToSheet()" id="btnSaveContract" class="bg-green-500 hover:bg-green-600 text-white font-bold px-4 py-1.5 rounded shadow text-sm flex items-center gap-1">
                <i class="fa-solid fa-cloud-arrow-up"></i> <span class="hidden sm:inline">L∆∞u Phi·∫øu</span>
            </button>
            <button onclick="showContractReport()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-3 py-1.5 rounded shadow text-sm flex items-center gap-1"><i class="fa-solid fa-clipboard-list"></i> <span class="hidden sm:inline">B√°o C√°o</span></button>
            <button onclick="window.print()" class="bg-white text-blue-700 hover:bg-blue-50 font-bold px-4 py-1.5 rounded shadow text-sm"><i class="fa-solid fa-print"></i> In Phi·∫øu</button>
            <button onclick="closeContractModal()" class="bg-red-500 hover:bg-red-600 text-white font-bold px-4 py-1.5 rounded shadow text-sm">ƒê√≥ng</button>
        </div>
    </div>

    <!-- TABS MOBILE -->
    <div id="contract-mobile-tabs" class="md:hidden flex border-b border-gray-200 bg-gray-50 shrink-0">
         <button onclick="switchContractTab('input')" id="ctab-input" class="flex-1 py-3 text-sm font-bold text-blue-700 border-b-2 border-blue-700 bg-white transition-colors">Nh·∫≠p Li·ªáu</button>
         <button onclick="switchContractTab('preview')" id="ctab-preview" class="flex-1 py-3 text-sm text-gray-500 font-medium hover:bg-gray-100 transition-colors">Xem Phi·∫øu</button>
    </div>

    <!-- Body Modal H·ª£p ƒê·ªìng -->
    <div class="flex flex-1 overflow-hidden relative bg-gray-100">
        <!-- Panel Nh·∫≠p Li·ªáu -->
        <div id="contract-input-panel" class="w-full md:w-1/3 bg-white border-r border-gray-200 z-10 overflow-y-auto p-4 shadow-lg md:block">
             <div class="mb-4">
                <h3 class="text-blue-700 font-bold border-b pb-1 mb-3 uppercase text-xs">1. Th√¥ng tin Kh√°ch (B√™n B√°n)</h3>
                <div class="space-y-3">
                    <div class="relative">
                        <label class="block text-xs font-bold text-gray-500 mb-1">S·ªë ƒëi·ªán tho·∫°i <span class="text-red-500">*</span></label>
                        <input type="text" id="c_sellerPhone" onchange="autoFillCustomer()" class="w-full border p-2 rounded text-sm outline-none focus:border-blue-500 font-bold text-blue-800 bg-blue-50" placeholder="Nh·∫≠p SƒêT ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn...">
                        <div id="custLoading" class="hidden absolute right-2 top-8 text-xs text-blue-500"><i class="fa-solid fa-spinner fa-spin"></i></div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">H·ªç v√† t√™n</label>
                        <input type="text" id="c_sellerName" class="w-full border p-2 rounded text-sm outline-none focus:border-blue-500 capitalize" oninput="updateContractPreview()">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">S·ªë CCCD</label>
                        <input type="text" id="c_sellerCCCD" class="w-full border p-2 rounded text-sm outline-none focus:border-blue-500" oninput="updateContractPreview()">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ƒê·ªãa ch·ªâ</label>
                        <input type="text" id="c_sellerAddress" class="w-full border p-2 rounded text-sm outline-none focus:border-blue-500" oninput="updateContractPreview()">
                    </div>
                    
                    <!-- CCCD Preview -->
                    <div id="cccd-preview-container" class="hidden mt-2 border-t pt-2 border-gray-100">
                        <p class="text-xs font-bold text-gray-500 mb-1">H√¨nh ·∫£nh CCCD l∆∞u tr·ªØ:</p>
                        <div class="grid grid-cols-2 gap-2">
                            <img id="view_cccd1" class="w-full h-24 object-contain border rounded bg-gray-100">
                            <img id="view_cccd2" class="w-full h-24 object-contain border rounded bg-gray-100">
                        </div>
                        <div class="mt-2 flex items-center">
                             <input type="checkbox" id="chk_print_cccd" class="mr-2 h-4 w-4 text-blue-600" checked onchange="updateContractPreview()">
                             <label for="chk_print_cccd" class="text-xs font-bold text-blue-700 cursor-pointer select-none">In k√®m ·∫£nh CCCD v√†o phi·∫øu</label>
                        </div>
                        <input type="hidden" id="store_cccd1">
                        <input type="hidden" id="store_cccd2">
                    </div>
                </div>
             </div>

             <div class="mb-4">
                <div class="flex justify-between items-center border-b pb-1 mb-3">
                    <h3 class="text-blue-700 font-bold uppercase text-xs">2. Danh s√°ch s·∫£n ph·∫©m</h3>
                    <button onclick="addContractProduct()" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 font-bold">+ Th√™m</button>
                </div>
                <div id="contractProductList" class="space-y-3">
                    <!-- Products will be added here -->
                </div>
             </div>
             
             <div class="border-t pt-3 mt-4">
                 <div class="flex justify-between items-center mb-2">
                     <span class="font-bold text-gray-700">T·ªïng Gi√° Tr·ªã:</span>
                     <input type="text" id="c_totalValue" readonly class="w-1/2 text-right font-bold text-red-600 bg-transparent outline-none" value="0 VNƒê">
                 </div>
                 <div class="flex gap-4 text-xs">
                     <label class="flex items-center"><input type="radio" name="c_payment" value="cash" checked onchange="updateContractPreview()" class="mr-1"> Ti·ªÅn m·∫∑t</label>
                     <label class="flex items-center"><input type="radio" name="c_payment" value="transfer" onchange="updateContractPreview()" class="mr-1"> Chuy·ªÉn kho·∫£n</label>
                 </div>
             </div>
        </div>

        <!-- Panel Xem Tr∆∞·ªõc (Preview) -->
        <div id="contract-preview-panel" class="w-full md:w-2/3 bg-gray-500 p-4 overflow-auto justify-center hidden md:flex">
            <div id="preview-wrapper" class="bg-white shadow-2xl transition-transform origin-top">
                <div id="printable-area">
                    <!-- Content will be rendered here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Modal (B√°o C√°o Thu M√°y) -->
<div id="reportModal" class="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center hidden">
    <div class="bg-white w-full max-w-md rounded-xl shadow-2xl p-5 m-4">
        <div class="flex justify-between items-center border-b pb-2 mb-3">
            <h3 class="font-bold text-lg text-blue-800"><i class="fa-solid fa-list-check"></i> B√°o C√°o Thu M√°y</h3>
            <button onclick="qs('#reportModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500 text-xl">&times;</button>
        </div>
        <textarea id="reportContent" rows="10" class="w-full border p-3 rounded bg-gray-50 text-sm font-mono focus:outline-none mb-3" readonly></textarea>
        <button onclick="copyReport()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded shadow transition"><i class="fa-regular fa-copy"></i> Sao Ch√©p</button>
    </div>
</div>

<!-- Modal Nh·∫≠p C·ªçc (Gi·ªØ nguy√™n) -->
<div id="depositModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center transition-opacity duration-200 modal-hide backdrop-blur-sm hidden">
    <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 relative flex flex-col gap-4">
        <h2 class="font-bold text-lg text-yellow-700 flex items-center gap-2"><i class="fa-solid fa-money-bill-wave"></i> Nh·∫≠n C·ªçc M√°y</h2>
        <input type="hidden" id="dep_seri">
        <div id="dep_name_serial" class="font-bold text-gray-800 text-center bg-gray-50 p-2 rounded text-sm break-all"></div>
        <div>
            <label class="block text-xs font-bold text-gray-500 mb-1">Th√¥ng tin ghi ch√∫ ho·∫∑c s·ªë ti·ªÅn c·ªçc</label>
            <input type="text" id="dep_info" class="w-full border-2 border-yellow-300 rounded p-2 focus:outline-none font-bold text-red-600" placeholder="VD: 500k - A Tu·∫•n SƒêT...">
        </div>
        <div class="flex justify-end gap-2 mt-2">
            <button onclick="closeDepositModal()" class="px-4 py-2 border rounded hover:bg-gray-100">H·ªßy</button>
            <button onclick="confirmDeposit()" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 font-bold shadow">L∆∞u C·ªçc</button>
        </div>
    </div>
</div>

<!-- ACTION SHEET -->
<div id="actionSheet" class="fixed inset-0 bg-black/60 z-50 flex items-end justify-center hidden">
    <div class="bg-white w-full max-w-md rounded-t-2xl shadow-2xl overflow-hidden transform translate-y-full transition-transform duration-200" onclick="event.stopPropagation()">
        <div class="bg-gray-100 p-4 text-center border-b font-bold text-gray-700 truncate" id="mas_title">T√™n M√°y</div>
        <input type="hidden" id="mas_seri">
        <input type="hidden" id="mas_name">
        <div class="p-4 space-y-3">
             <button onclick="triggerAction('deposit')" class="w-full py-3 bg-yellow-50 text-yellow-700 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-yellow-100"><i class="fa-solid fa-money-bill-1-wave text-lg"></i> Ghi Ch√∫</button>
             <button onclick="triggerAction('edit')" class="w-full py-3 bg-blue-50 text-blue-700 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-blue-100"><i class="fa-solid fa-pen text-lg"></i> S·ª≠a Th√¥ng Tin</button>
        </div>
        <div class="p-4 border-t">
            <button onclick="closeActionMenu()" class="w-full py-3 bg-gray-200 text-gray-700 rounded-xl font-bold">H·ªßy B·ªè</button>
        </div>
    </div>
</div>

<datalist id="list_dl"><option>64GB</option><option>128GB</option><option>256GB</option><option>512GB</option><option>1TB</option></datalist>

<script>
// ==========================================
const API_URL = 'https://script.google.com/macros/s/AKfycbw4RBRN3anZlIUAkXj2Q5ww5pPkiYi4Fu3v9IQVwIhT1jxGTq2pP_59arquUV7t5gYq/exec'; 
// API Kh√°ch H√†ng (ƒê·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn)
const API_CUSTOMER = 'https://script.google.com/macros/s/AKfycbx0SlevLfkEkB_b5NDLGqbVVujGxdWKKUU8GXocSdJvXDwxjLK7GOrYBAVeqi0qOFWwww/exec';
// TH√äM: L·∫•y t√™n SALE t·ª´ localStorage
const NV_TEN = localStorage.getItem('NV_TEN') || "NV_KHO";
// ==========================================

let allData = [];
let isEditing = false;
let selectedItems = new Set();
// Contract Products Array
let contractProducts = [{ id: 1, name: '', seri: '', condition: '', price: '' }];

const qs = (s) => document.querySelector(s);
const formatMoney = (n) => n ? Number(String(n).replace(/\D/g, '')).toLocaleString('vi-VN') : '0';
const parseMoney = (n) => n ? Number(String(n).replace(/\D/g, '')) : 0;
function formatCurrency(input) { let val = input.value.replace(/\D/g, ''); input.value = val ? Number(val).toLocaleString('vi-VN') : ''; }
const formatPriceK = (price) => { if(!price) return '0k'; return Number(price).toLocaleString('vi-VN') + 'k'; }

function getItemInfoString(item) {
    const tinhTrangStr = item.TINHTRANG ? (String(item.TINHTRANG).includes('%') ? item.TINHTRANG : item.TINHTRANG + '%') : '';
    const parts = [
        item.NAME, item.DL, item.COLOR ? `m√†u ${item.COLOR}` : '', item.SIM,
        tinhTrangStr ? `T√¨nh tr·∫°ng ${tinhTrangStr}` : '', item.PIN ? `Pin ${item.PIN}%` : '',
        `gi√° ${formatPriceK(item.GIABAN)}`
    ];
    return parts.filter(Boolean).join(' ');
}

// ================= LOGIC KHO M√ÅY =================
async function loadData() {
    qs('#loading').classList.remove('hidden');
    try {
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "get_serialized" }) });
        const json = await res.json();
        if(json.success && Array.isArray(json.data)) {
            allData = json.data.reverse(); 
            selectedItems.clear(); updateSelectionUI(); applyFilter();
        } else { allData = []; renderTable([]); }
    } catch(e) { console.error(e); }
    qs('#loading').classList.add('hidden');
}

function applyFilter() {
    const k = qs('#searchInput').value.toLowerCase().trim();
    const loc = qs('#filterLocation').value;
    const type = qs('#filterType').value;
    let totalValue = 0;
    const filtered = allData.filter(item => {
        const nameStr = item.NAME ? String(item.NAME).toLowerCase() : "";
        const seriStr = item.SERI ? String(item.SERI).toLowerCase() : "";
        const matchText = (nameStr.includes(k) || seriStr.includes(k));
        let matchLoc = (loc === 'ALL') ? true : (item.LOCATION || 'KHO') === loc;
        let matchType = (type === 'ALL') ? true : item.TYPE === type;
        return matchText && matchLoc && matchType;
    });
    filtered.forEach(i => { totalValue += Number(i.GIANHAP) || 0; });
    renderTable(filtered);
    qs('#totalCount').innerText = filtered.length;
    qs('#totalValue').innerText = formatMoney(totalValue) + ' ‚Ç´';
}

function toggleAll(el) {
    document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.checked = el.checked;
        if(el.checked) selectedItems.add(cb.value); else selectedItems.delete(cb.value);
    });
    updateSelectionUI();
}

function toggleRow(seri) {
    if(selectedItems.has(seri)) selectedItems.delete(seri); else selectedItems.add(seri);
    updateSelectionUI();
}

function updateSelectionUI() {
    const count = selectedItems.size;
    const btn = qs('#btnCopyMulti');
    if(count > 0) { btn.classList.remove('hidden'); qs('#lblCopyMulti').innerText = `Copy (${count})`; } 
    else { btn.classList.add('hidden'); }
}

function copySelectedItems() {
    if(selectedItems.size === 0) return;
    const itemsToCopy = allData.filter(i => selectedItems.has(i.SERI));
    const textToCopy = itemsToCopy.map(item => getItemInfoString(item)).join('\n');
    navigator.clipboard.writeText(textToCopy).then(() => {
        alert(`ƒê√£ copy ${itemsToCopy.length} m√°y!`); selectedItems.clear();
        document.querySelectorAll('.custom-checkbox').forEach(cb => cb.checked = false); updateSelectionUI();
    });
}

function copySingleItem(seri, element) {
    const item = allData.find(i => i.SERI === seri); if(!item) return;
    navigator.clipboard.writeText(getItemInfoString(item)).then(() => {
        element.classList.add('copy-feedback'); setTimeout(() => element.classList.remove('copy-feedback'), 500);
    });
}

function exportToTxt() {
    const k = qs('#searchInput').value.toLowerCase().trim();
    const loc = qs('#filterLocation').value;
    const type = qs('#filterType').value;
    const filtered = allData.filter(item => {
        const nameStr = item.NAME ? String(item.NAME).toLowerCase() : "";
        const seriStr = item.SERI ? String(item.SERI).toLowerCase() : "";
        return (nameStr.includes(k) || seriStr.includes(k)) && ((loc === 'ALL') ? true : (item.LOCATION || 'KHO') === loc) && ((type === 'ALL') ? true : item.TYPE === type);
    });
    if(filtered.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!");
    const textContent = filtered.map(item => getItemInfoString(item)).join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([textContent], { type: "text/plain;charset=utf-8" }));
    a.download = `Danh_sach_may_${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
}

function renderTable(data) {
    const tbody = qs('#tableBody'); tbody.innerHTML = '';
    if(data.length === 0) { tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-400 italic">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`; return; }
    data.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-green-50 transition-colors border-b last:border-0 group bg-white';
        const loc = item.LOCATION || 'KHO';
        let locClass = loc === 'CN1' ? 'loc-cn1' : (loc === 'CN2' ? 'loc-cn2' : 'loc-kho');
        let locIcon = loc === 'KHO' ? 'fa-warehouse' : 'fa-store';
        const locBadge = `<span class="loc-badge ${locClass}"><i class="fa-solid ${locIcon}"></i> ${loc === 'KHO' ? 'KHO T·ªîNG' : loc}</span>`;
        const infoString = getItemInfoString(item).replace(item.COC ? '' : '', ''); 
        const displayHtml = infoString.replace(item.NAME, `<strong>${item.NAME}</strong>`).replace(`gi√° ${formatPriceK(item.GIABAN)}`, `<span class="text-red-600 font-bold">gi√° ${formatPriceK(item.GIABAN)}</span>`);
        const cocHtml = item.COC ? `<span class="coc-badge text-[10px] ml-2">${item.COC}</span>` : '';
        const isChecked = selectedItems.has(item.SERI) ? 'checked' : '';
        tr.innerHTML = `
            <td class="p-3 text-center w-10"><input type="checkbox" value="${item.SERI}" onchange="toggleRow('${item.SERI}')" class="custom-checkbox row-checkbox align-middle" ${isChecked}></td>
            <td class="px-3 py-3 text-center text-xs text-gray-400 font-bold">${i + 1}</td>
            <td class="px-3 py-3 text-center">${locBadge}</td>
            <td class="px-3 py-3 font-mono text-xs font-bold text-gray-700 text-center select-all hover:text-green-700 cursor-pointer" onclick="navigator.clipboard.writeText('${item.SERI}')">${item.SERI}</td>
            <td class="px-3 py-3 text-sm text-gray-800 leading-snug cursor-pointer hover:text-green-800" onclick="copySingleItem('${item.SERI}', this)" title="Click ƒë·ªÉ copy">${displayHtml} ${cocHtml}</td>
            <td class="px-3 py-3 text-xs text-gray-500 italic max-w-[150px] truncate" title="${item.GHICHU || ''}">${item.GHICHU || ''}</td>
            <td class="px-2 py-3 text-center sticky right-0 bg-white group-hover:bg-green-50">
                <button onclick="openActionMenu('${item.SERI}')" class="w-8 h-8 rounded-full text-gray-400 hover:text-green-600 hover:bg-green-100 transition inline-flex items-center justify-center"><i class="fa-solid fa-ellipsis-vertical"></i></button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function openActionMenu(seri) {
    const item = allData.find(i => i.SERI === seri);
    qs('#mas_title').innerText = item ? item.NAME : ''; qs('#mas_seri').value = seri; qs('#mas_name').value = item ? item.NAME : '';
    const sheet = qs('#actionSheet'); sheet.classList.remove('hidden');
    setTimeout(() => { sheet.children[0].classList.remove('translate-y-full'); }, 10);
    sheet.onclick = closeActionMenu;
}
function closeActionMenu() {
    const sheet = qs('#actionSheet'); sheet.children[0].classList.add('translate-y-full');
    setTimeout(() => { sheet.classList.add('hidden'); }, 200);
}
function triggerAction(action) {
    const seri = qs('#mas_seri').value;
    const name = qs('#mas_name').value;
    const item = allData.find(i => i.SERI === seri);
    const sheet = qs('#actionSheet'); sheet.children[0].classList.add('translate-y-full');
    setTimeout(() => {
        sheet.classList.add('hidden');
        if(action === 'deposit') openDepositModal(seri, name, item ? item.COC : '');
        if(action === 'edit') openEditModal(seri);
    }, 200);
}

function openDepositModal(seri, name, currentCoc) {
    qs('#depositModal').classList.remove('hidden');
    setTimeout(() => { qs('#depositModal').classList.remove('modal-hide'); qs('#depositModal').classList.add('modal-open'); }, 10);
    qs('#dep_seri').value = seri; qs('#dep_name_serial').innerText = name + " - " + seri; qs('#dep_info').value = currentCoc || '';
}
function closeDepositModal() {
    qs('#depositModal').classList.remove('modal-open'); qs('#depositModal').classList.add('modal-hide');
    setTimeout(() => qs('#depositModal').classList.add('hidden'), 200);
}
async function confirmDeposit() {
    const seri = qs('#dep_seri').value; const info = qs('#dep_info').value.trim();
    const item = allData.find(i => i.SERI === seri); if(item) { item.COC = info; renderTable(allData); }
    closeDepositModal();
    try { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'update_deposit', SERI: seri, COC_INFO: info }) }); } catch(e) { alert("L·ªói: " + e.message); loadData(); }
}

function openModal(mode) {
    qs('#modal').classList.remove('hidden'); setTimeout(() => { qs('#modal').classList.remove('modal-hide'); qs('#modal').classList.add('modal-open'); }, 10);
    if(mode === 'add') {
        isEditing = false; qs('#modalTitle').innerText = 'Nh·∫≠p Kho M√°y'; qs('#item_key').value = '';
        qs('#inp_id').value = ''; qs('#inp_id').disabled = false; qs('#inp_name').value = ''; qs('#inp_dl').value = ''; 
        qs('#inp_color').value = ''; qs('#inp_sim').value = ''; qs('#inp_tt').value = ''; qs('#inp_pin').value = ''; 
        qs('#inp_giaban').value = ''; 
        qs('#price_container').classList.remove('hidden');
        qs('#inp_gianhap').value = ''; qs('#inp_gianhap').readOnly = false;
        qs('#inp_gianhap').classList.remove('bg-gray-100', 'cursor-not-allowed', 'text-gray-500'); qs('#inp_gianhap').classList.add('text-green-800');
        qs('#inp_note').value = ''; qs('#inp_location').value = 'KHO';
    }
}
function openEditModal(seri) {
    const item = allData.find(i => i.SERI === seri); if(!item) return;
    openModal(); isEditing = true; qs('#modalTitle').innerText = 'S·ª≠a Th√¥ng Tin M√°y';
    qs('#item_key').value = seri; qs('#inp_id').value = seri; qs('#inp_id').disabled = true;
    qs('#inp_name').value = item.NAME; qs('#inp_dl').value = item.DL; qs('#inp_color').value = item.COLOR;
    qs('#inp_sim').value = item.SIM; qs('#inp_tt').value = item.TINHTRANG; qs('#inp_pin').value = item.PIN; qs('#inp_note').value = item.GHICHU;
    qs('#price_container').classList.add('hidden');
    qs('#inp_giaban').value = formatMoney(item.GIABAN); qs('#inp_gianhap').value = formatMoney(item.GIANHAP);
    qs('#inp_type_device').value = item.TYPE; qs('#inp_location').value = item.LOCATION || 'KHO';
}
function closeModal() { qs('#modal').classList.remove('modal-open'); qs('#modal').classList.add('modal-hide'); setTimeout(() => qs('#modal').classList.add('hidden'), 200); }

async function saveData() {
    const id = qs('#inp_id').value.trim().toUpperCase(); const name = qs('#inp_name').value.trim();
    if(!id || !name) return alert("Vui l√≤ng nh·∫≠p Seri v√† T√™n m√°y!");
    const item = {
        SERI: id, NAME: name, DL: qs('#inp_dl').value, COLOR: qs('#inp_color').value, 
        SIM: qs('#inp_sim').value, TINHTRANG: qs('#inp_tt').value, PIN: qs('#inp_pin').value, TYPE: qs('#inp_type_device').value,
        GIABAN: parseMoney(qs('#inp_giaban').value), GIANHAP: parseMoney(qs('#inp_gianhap').value), 
        GHICHU: qs('#inp_note').value, LOCATION: qs('#inp_location').value || 'KHO'
    };
    let body = isEditing ? { action: 'edit', ...item } : { action: 'add_multi', items: [item] };
    if(isEditing) { const idx = allData.findIndex(x => x.SERI === id); if(idx !== -1) allData[idx] = item; } else allData.unshift(item);
    applyFilter(); closeModal();
    try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(body) }); setTimeout(loadData, 500); } catch(e) { alert("L·ªói l∆∞u: " + e.message); loadData(); }
}

// ================= LOGIC T·∫†O H·ª¢P ƒê·ªíNG (M·ªöI) =================
function openContractModal() {
    qs('#contractModal').classList.remove('hidden');
    qs('#contractModal').classList.add('flex');
    // Reset form
    contractProducts = [{ id: 1, name: '', seri: '', condition: '', price: '' }];
    renderContractProducts();
    
    // Clear old customer info
    qs('#c_sellerPhone').value = '';
    qs('#c_sellerName').value = '';
    qs('#c_sellerCCCD').value = '';
    qs('#c_sellerAddress').value = '';
    qs('#c_totalValue').value = '0 VNƒê';
    
    // Reset CCCD images
    qs('#store_cccd1').value = '';
    qs('#store_cccd2').value = '';
    qs('#view_cccd1').src = '';
    qs('#view_cccd2').src = '';
    qs('#cccd-preview-container').classList.add('hidden');
    
    updateContractPreview();
    autoScaleContractPreview();
    switchContractTab('input');
}

function closeContractModal() {
    qs('#contractModal').classList.add('hidden');
    qs('#contractModal').classList.remove('flex');
}

function switchContractTab(tab) {
    const inputPanel = qs('#contract-input-panel');
    const previewPanel = qs('#contract-preview-panel');
    const tabInput = qs('#ctab-input');
    const tabPreview = qs('#ctab-preview');

    if (tab === 'input') {
        inputPanel.classList.remove('hidden');
        previewPanel.classList.remove('flex'); 
        previewPanel.classList.add('hidden');
        tabInput.className = "flex-1 py-3 text-sm font-bold text-blue-700 border-b-2 border-blue-700 bg-white transition-colors";
        tabPreview.className = "flex-1 py-3 text-sm text-gray-500 font-medium hover:bg-gray-100 transition-colors";
    } else {
        inputPanel.classList.add('hidden');
        previewPanel.classList.remove('hidden');
        previewPanel.classList.add('flex'); 
        tabInput.className = "flex-1 py-3 text-sm text-gray-500 font-medium hover:bg-gray-100 transition-colors";
        tabPreview.className = "flex-1 py-3 text-sm font-bold text-blue-700 border-b-2 border-blue-700 bg-white transition-colors";
        setTimeout(autoScaleContractPreview, 50); 
    }
}

// 1. T·ª± ƒë·ªông ƒëi·ªÅn kh√°ch h√†ng
async function autoFillCustomer() {
    const phone = qs('#c_sellerPhone').value.trim();
    if (!phone) return;
    
    qs('#custLoading').classList.remove('hidden');
    try {
        const res = await fetch(API_CUSTOMER);
        const json = await res.json();
        if (Array.isArray(json)) {
            const cust = json.find(c => String(c.SDT).includes(phone)); 
            if (cust) {
                qs('#c_sellerName').value = cust.TEN || '';
                qs('#c_sellerCCCD').value = cust.CCCD ? String(cust.CCCD).replace(/'/g, '') : '';
                qs('#c_sellerAddress').value = cust.DIACHI || '';
                qs('#c_sellerPhone').value = cust.SDT ? String(cust.SDT).replace(/'/g, '') : phone;
                
                // Load CCCD images if available
                if (cust.CCCD1 || cust.CCCD2) {
                    qs('#cccd-preview-container').classList.remove('hidden');
                    if(cust.CCCD1) {
                        qs('#view_cccd1').src = cust.CCCD1;
                        qs('#store_cccd1').value = cust.CCCD1;
                    }
                    if(cust.CCCD2) {
                        qs('#view_cccd2').src = cust.CCCD2;
                        qs('#store_cccd2').value = cust.CCCD2;
                    }
                } else {
                    qs('#cccd-preview-container').classList.add('hidden');
                    qs('#store_cccd1').value = '';
                    qs('#store_cccd2').value = '';
                }
                
                updateContractPreview();
            }
        }
    } catch (e) {
        console.error("L·ªói l·∫•y kh√°ch h√†ng:", e);
    }
    qs('#custLoading').classList.add('hidden');
}

// 2. Qu·∫£n l√Ω s·∫£n ph·∫©m trong h·ª£p ƒë·ªìng
function renderContractProducts() {
    const container = qs('#contractProductList');
    container.innerHTML = '';
    contractProducts.forEach((prod, index) => {
        const div = document.createElement('div');
        div.className = "bg-gray-50 p-2 rounded border border-gray-200 shadow-sm relative text-xs";
        div.innerHTML = `
            <div class="flex justify-between items-center mb-1">
                <span class="font-bold text-gray-500">S·∫£n ph·∫©m #${index + 1}</span>
                ${contractProducts.length > 1 ? `<button onclick="removeContractProduct(${prod.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>` : ''}
            </div>
            <div class="space-y-2">
                <input type="text" class="w-full border p-1.5 rounded focus:border-blue-500 outline-none font-bold" placeholder="T√™n SP & Model" value="${prod.name}" oninput="updateCP(${prod.id}, 'name', this.value)">
                <div class="flex gap-2">
                    <input type="text" class="w-2/3 border p-1.5 rounded focus:border-blue-500 outline-none uppercase font-mono" placeholder="IMEI/Serial" value="${prod.seri}" oninput="updateCP(${prod.id}, 'seri', this.value)">
                    <input type="text" class="w-1/3 border p-1.5 rounded focus:border-blue-500 outline-none" placeholder="T√¨nh tr·∫°ng" value="${prod.condition}" oninput="updateCP(${prod.id}, 'condition', this.value)">
                </div>
                <input type="text" class="w-full border p-1.5 rounded font-bold text-red-600 focus:border-blue-500 outline-none" placeholder="Gi√° mua (VNƒê)" value="${prod.price}" oninput="formatCurrency(this); updateCP(${prod.id}, 'price', this.value)">
            </div>
        `;
        container.appendChild(div);
    });
}

function updateCP(id, field, val) {
    const p = contractProducts.find(x => x.id === id);
    if(p) { 
        p[field] = val; 
        if(field === 'price') updateContractTotal();
        updateContractPreview(); 
    }
}

function addContractProduct() {
    const newId = contractProducts.length > 0 ? Math.max(...contractProducts.map(p => p.id)) + 1 : 1;
    contractProducts.push({ id: newId, name: '', seri: '', condition: '', price: '' });
    renderContractProducts();
    updateContractPreview();
}

function removeContractProduct(id) {
    contractProducts = contractProducts.filter(p => p.id !== id);
    renderContractProducts();
    updateContractTotal();
    updateContractPreview();
}

function updateContractTotal() {
    let total = 0;
    contractProducts.forEach(p => {
        const price = parseInt(String(p.price).replace(/\./g, '')) || 0;
        total += price;
    });
    qs('#c_totalValue').value = new Intl.NumberFormat('vi-VN').format(total) + " VNƒê";
    updateContractPreview();
}

// 3. Render Preview
function updateContractPreview() {
    const today = new Date();
    const dateStr = `Ng√†y ${today.getDate()} th√°ng ${today.getMonth() + 1} nƒÉm ${today.getFullYear()}`;
    const totalPriceVal = qs('#c_totalValue').value.replace(' VNƒê', '');
    const paymentVal = document.querySelector('input[name="c_payment"]:checked')?.value || 'cash';
    
    // Get CCCD images
    const cccd1 = qs('#store_cccd1').value;
    const cccd2 = qs('#store_cccd2').value;
    const printCCCD = qs('#chk_print_cccd').checked;

    const data = {
        date: dateStr,
        sellerName: qs('#c_sellerName').value.toUpperCase(),
        sellerCCCD: qs('#c_sellerCCCD').value,
        sellerPhone: qs('#c_sellerPhone').value,
        sellerAddress: qs('#c_sellerAddress').value,
        totalPrice: totalPriceVal,
        payment: paymentVal,
        cccd1: printCCCD ? cccd1 : '',
        cccd2: printCCCD ? cccd2 : ''
    };

    const printableArea = qs('#printable-area');
    printableArea.innerHTML = '';

    const rows = contractProducts.map((prod, idx) => `
        <tr>
            <td>${idx + 1}</td>
            <td>${prod.name}</td>
            <td class="font-bold">${prod.seri}</td>
            <td>${prod.condition}</td>
            <td class="font-bold">${prod.price}</td>
        </tr>
    `).join('');

    const checkCash = data.payment === 'cash' ? '<i class="fas fa-check-square"></i>' : '‚ñ¢';
    const checkTransfer = data.payment === 'transfer' ? '<i class="fas fa-check-square"></i>' : '‚ñ¢';

    // RENDER TRANG H·ª¢P ƒê·ªíNG
    printableArea.appendChild(createPage(`
        <div class="contract-sheet">
            <div class="contract-header" style="margin-bottom: 5px;">
                <h1 class="text-2xl font-bold">H·ª¢P ƒê·ªíNG MUA B√ÅN T√ÄI S·∫¢N</h1>
                <p class="text-sm font-normal italic mt-0">${data.date}</p>
            </div>
            ${renderBuyerSellerInfo(data)}
            <div class="mb-2">
                <div class="section-title">DANH M·ª§C T√ÄI S·∫¢N</div>
                <table class="asset-table">
                    <thead><tr><th style="width:5%">STT</th><th style="width:35%">S·∫£n ph·∫©m & Model</th><th style="width:25%">IMEI/SERIAL</th><th style="width:15%">T√¨nh tr·∫°ng</th><th style="width:20%">Gi√° (VNƒê)</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
            <div class="space-y-1 mt-2 text-sm">
                <div class="flex justify-between font-bold text-base border-b border-gray-300 pb-1">
                    <span>T·ªîNG GI√Å TR·ªä: ${data.totalPrice} VNƒê</span>
                    <span class="font-normal text-sm">Thanh to√°n: ${checkCash} Ti·ªÅn m·∫∑t &nbsp; ${checkTransfer} CK</span>
                </div>
                <div>
                    <div class="font-bold underline">CAM K·∫æT & HI·ªÜU L·ª∞C</div>
                    <ul class="list-disc pl-5 text-justify" style="margin-bottom: 0;">
                        <li>Kh√¥ng b·ªã kh√≥a iCloud, kh√¥ng tr·∫£ g√≥p. T√†i s·∫£n h·ª£p ph√°p, kh√¥ng tranh ch·∫•p.</li>
                        <li>Cam k·∫øt kh√¥ng ch·ªânh s·ª≠a IMEI/Serial. B√™n mua ƒë√£ ki·ªÉm tra & ƒë·ªìng √Ω t√¨nh tr·∫°ng.</li>
                        <li>Hai b√™n ch·ªãu tr√°ch nhi·ªám tr∆∞·ªõc ph√°p lu·∫≠t v·ªÅ th√¥ng tin. Hƒê l·∫≠p 02 b·∫£n gi√° tr·ªã nh∆∞ nhau.</li>
                    </ul>
                </div>
            </div>
            <div class="mt-4">
                <div class="font-bold text-center mb-2 uppercase underline decoration-2 underline-offset-4">CH·ªÆ K√ù X√ÅC NH·∫¨N</div>
                <div class="flex justify-between px-8 text-center">
                    <div><p class="font-bold mb-24">B√äN B√ÅN</p><p class="font-bold uppercase">${data.sellerName}</p></div>
                    <div><p class="font-bold mb-24">B√äN MUA ‚Äì H·ªò KINH DOANH</p><p class="font-bold uppercase">Phan Th·ªã Qu·ª≥nh H∆∞∆°ng</p></div>
                </div>
            </div>
        </div>
    `));

    // RENDER BI√äN NH·∫¨N
    const reason = "Thanh to√°n ti·ªÅn mua m√°y" + (contractProducts.length > 0 ? ` - ${contractProducts[0].name}...` : '');
    printableArea.appendChild(createPage(`
        <div class="contract-sheet">
            <div class="contract-header"><h1 class="text-2xl font-bold">BI√äN NH·∫¨N THANH TO√ÅN</h1><p class="text-sm font-normal italic mt-1">${data.date}</p></div>
            <div class="mb-4">
                <div class="section-title">TH√îNG TIN B√äN NH·∫¨N TI·ªÄN (B√äN B√ÅN)</div>
                <div class="info-row mb-1"><div class="w-full">- H·ªç v√† t√™n: <span class="dotted-input uppercase w-2/3">${data.sellerName}</span></div></div>
                <div class="info-row mb-1"><div class="w-full">- S·ªë CCCD: <span class="dotted-input w-2/3">${data.sellerCCCD}</span></div></div>
                <div class="info-row mb-1"><div class="w-full">- ƒê·ªãa ch·ªâ: <span class="dotted-input w-2/3">${data.sellerAddress}</span></div></div>
                <div class="info-row mb-1"><div class="w-full">- S·ªë ƒëi·ªán tho·∫°i: <span class="dotted-input w-2/3">${data.sellerPhone}</span></div></div>
            </div>
            <div class="mb-4">
                <div class="section-title">N·ªòI DUNG THANH TO√ÅN</div>
                <div class="space-y-2 text-lg">
                    <p>- S·ªë ti·ªÅn: <span class="font-bold text-xl">${data.totalPrice} VNƒê</span></p>
                    <p style="word-wrap: break-word;">- L√Ω do: <span class="dotted-input w-3/4">${reason}</span></p>
                    <p>- H√¨nh th·ª©c: <span class="ml-4 font-bold">${checkCash} Ti·ªÅn m·∫∑t &nbsp;&nbsp; ${checkTransfer} Chuy·ªÉn kho·∫£n</span></p>
                </div>
            </div>
            <div class="mb-2"><div class="font-bold underline mb-1">X√ÅC NH·∫¨N C·ª¶A B√äN NH·∫¨N TI·ªÄN</div><p class="italic">T√¥i ƒë√£ nh·∫≠n ƒë·ªß s·ªë ti·ªÅn ghi tr√™n v√† kh√¥ng c√≤n khi·∫øu n·∫°i.</p></div>
            <div class="mt-4">
                <div class="font-bold text-center mb-4 uppercase underline decoration-2 underline-offset-4">CH·ªÆ K√ù X√ÅC NH·∫¨N</div>
                <div class="flex justify-between px-8 text-center">
                    <div><p class="font-bold mb-24">NG∆Ø·ªúI NH·∫¨N TI·ªÄN</p><p class="font-bold uppercase">${data.sellerName}</p></div>
                    <div><p class="font-bold mb-24">NG∆Ø·ªúI L·∫¨P PHI·∫æU</p><p class="font-bold uppercase">Phan Th·ªã Qu·ª≥nh H∆∞∆°ng</p></div>
                </div>
            </div>
        </div>
    `));
}

function createPage(html) {
    const div = document.createElement('div'); div.className = 'page-container'; div.innerHTML = html; return div;
}

function renderBuyerSellerInfo(data) {
    // Generate CCCD images HTML if available
    let cccdImagesHtml = '';
    if (data.cccd1 || data.cccd2) {
        cccdImagesHtml = `<div class="flex gap-4 mt-2 justify-center">`;
        if (data.cccd1) cccdImagesHtml += `<img src="${data.cccd1}" style="height: 40mm; max-width: 48%; object-fit: contain; border: 1px solid #ccc;">`;
        if (data.cccd2) cccdImagesHtml += `<img src="${data.cccd2}" style="height: 40mm; max-width: 48%; object-fit: contain; border: 1px solid #ccc;">`;
        cccdImagesHtml += `</div>`;
    }

    return `
        <div class="mb-2 text-sm">
            <div class="section-title" style="margin: 2px 0;">B√äN B√ÅN (C√Å NH√ÇN)</div>
            <div class="flex justify-between mb-1"><div class="w-1/2">H·ªç t√™n: <span class="font-bold uppercase">${data.sellerName}</span></div><div class="w-1/2">CCCD: <span class="font-bold">${data.sellerCCCD}</span></div></div>
            <div class="flex justify-between"><div class="w-1/2">SƒêT: <span class="font-bold">${data.sellerPhone}</span></div><div class="w-1/2">ƒê/c: <span class="font-bold">${data.sellerAddress}</span></div></div>
            ${cccdImagesHtml}
        </div>
        <div class="mb-2 text-sm">
            <div class="section-title" style="margin: 2px 0;">B√äN MUA (H·ªò KINH DOANH)</div>
            <div class="flex justify-between mb-1"><div class="w-7/12"><strong>H·ªò KINH DOANH POLY STORE B√åNH TH·∫†NH</strong></div><div class="w-5/12 text-right">MST: <strong>060197005285</strong></div></div>
            <div class="mb-1">ƒê/c: 170/4/2 B√πi ƒê√¨nh T√∫y, Ph∆∞·ªùng B√¨nh Th·∫°nh, TP. HCM</div>
            <div class="flex justify-between"><div>ƒê·∫°i di·ªán: <strong>Phan Th·ªã Qu·ª≥nh H∆∞∆°ng</strong></div><div>SƒêT: <strong>0367185451</strong></div></div>
        </div>
    `;
}

// --- LOGIC B√ÅO C√ÅO THU M√ÅY (NEW) ---
function showContractReport() {
    const sellerName = qs('#c_sellerName').value || '(Ch∆∞a nh·∫≠p t√™n)';
    const sellerPhone = qs('#c_sellerPhone').value || '(Ch∆∞a nh·∫≠p SƒêT)';
    const sellerCCCD = qs('#c_sellerCCCD').value || '(Ch∆∞a nh·∫≠p CCCD)';
    const sellerAddress = qs('#c_sellerAddress').value || '(Ch∆∞a nh·∫≠p ƒê/c)';
    const totalVal = qs('#c_totalValue').value || '0 VNƒê';
    
    let productText = '';
    contractProducts.forEach((p, idx) => {
        productText += `${idx + 1}. ${p.name || 'SP Tr·ªëng'} - ${p.seri || 'No IMEI'} - ${p.condition || 'TT Tr·ªëng'} - ${p.price || '0'} VNƒê\n`;
    });

    const report = `*B√ÅO C√ÅO THU MUA M√ÅY*\n` +
        `--------------------------\n` +
        `üë§ Kh√°ch: ${sellerName}\n` +
        `üìû SƒêT: ${sellerPhone}\n` +
        `üÜî CCCD: ${sellerCCCD}\n` +
        `üè† ƒê·ªãa ch·ªâ: ${sellerAddress}\n` + 
        `--------------------------\n` +
        `üì¶ DANH S√ÅCH M√ÅY:\n${productText}` +
        `--------------------------\n` +
        `üí∞ T·ªîNG TI·ªÄN: ${totalVal}`;

    qs('#reportContent').value = report;
    qs('#reportModal').classList.remove('hidden');
}

function copyReport() {
    const content = qs('#reportContent');
    content.select();
    document.execCommand('copy');
    alert('ƒê√£ sao ch√©p b√°o c√°o!');
    qs('#reportModal').classList.add('hidden');
}

// --- L∆ØU PHI·∫æU V√ÄO GOOGLE SHEET (NEW FUNCTION) ---
async function saveContractToSheet() {
    const btn = qs('#btnSaveContract');
    
    // Validate
    const sellerName = qs('#c_sellerName').value.trim();
    if(!sellerName) return alert("Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng!");
    if(contractProducts.length === 0) return alert("Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o!");

    // Data payload
    const payload = {
        action: 'save_contract',
        DATE: new Date().toISOString().split('T')[0], // YYYY-MM-DD
        SELLER_NAME: sellerName,
        SELLER_PHONE: qs('#c_sellerPhone').value.trim(),
        SELLER_CCCD: qs('#c_sellerCCCD').value.trim(),
        SELLER_ADDRESS: qs('#c_sellerAddress').value.trim(),
        TOTAL_VALUE: qs('#c_totalValue').value,
        PRODUCTS: JSON.stringify(contractProducts), // G·ª≠i m·∫£ng SP d∆∞·ªõi d·∫°ng string
        SALE: NV_TEN // TH√äM: T√™n nh√¢n vi√™n t·∫°o phi·∫øu
    };

    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang l∆∞u...'; btn.disabled = true;

    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(payload)
        });
        const json = await res.json();
        if(json.success) {
            alert("‚úÖ ƒê√£ l∆∞u phi·∫øu th√†nh c√¥ng!");
        } else {
            alert("‚ùå L·ªói: " + json.message);
        }
    } catch(e) {
        alert("‚ùå L·ªói k·∫øt n·ªëi: " + e.message);
    } finally {
        btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> <span class="hidden sm:inline">L∆∞u Phi·∫øu</span>'; btn.disabled = false;
    }
}

function autoScaleContractPreview() {
    if (window.innerWidth < 768) {
        const wrapper = qs('#preview-wrapper');
        const containerWidth = qs('#contract-preview-panel').offsetWidth;
        const scale = (containerWidth - 40) / 830; 
        if(wrapper) wrapper.style.transform = `scale(${Math.min(scale, 1)})`;
    }
}
window.addEventListener('resize', autoScaleContractPreview);

qs('#searchInput').addEventListener('input', applyFilter);
loadData();
</script>
</body>
</html>