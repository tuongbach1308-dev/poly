<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n L√Ω Kho M√°y (Serial)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
   
  <style>
    /* T√πy ch·ªânh thanh cu·ªôn */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #15803d; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #14532d; }
    
    body { font-family: 'Roboto', sans-serif; }
    
    /* Animation Modal */
    .modal-open { opacity: 1; transform: scale(1); pointer-events: auto; }
    .modal-hide { opacity: 0; transform: scale(0.95); pointer-events: none; }
    
    /* C·ªë ƒë·ªãnh c·ªôt h√†nh ƒë·ªông b√™n ph·∫£i */
    .sticky-col-shadow { box-shadow: -4px 0 10px -4px rgba(0,0,0,0.1); }

    /* Location Badge */
    .loc-badge { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; white-space: nowrap; display: inline-flex; align-items: center; gap: 4px; }
    .loc-kho { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
    .loc-cn1 { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
    .loc-cn2 { background: #ffedd5; color: #9a3412; border: 1px solid #fdba74; }

    /* C·ªçc Badge */
    .coc-badge { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; display: inline-block; white-space: nowrap; margin-right: 5px;}

    /* Checkbox custom */
    .custom-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #15803d; }
    
    /* Hi·ªáu ·ª©ng khi click copy */
    .copy-feedback { animation: flash 0.5s; background-color: #dcfce7 !important; }
    @keyframes flash { 0% { background-color: #dcfce7; } 100% { background-color: transparent; } }
  </style>
</head>
<body class="bg-gray-50 min-h-screen text-sm text-gray-800">

<div class="p-4 w-full max-w-[1600px] mx-auto pb-20">
  <!-- Header -->
  <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 mb-4">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 border-b border-gray-100 pb-4 gap-4">
      <div>
        <h1 class="text-xl md:text-2xl font-bold text-green-700 flex items-center gap-2">
          <i class="fa-solid fa-mobile-screen-button"></i> Kho M√°y
        </h1>
        <p class="text-gray-500 text-xs mt-1">Qu·∫£n l√Ω t·ªìn kho chi ti·∫øt</p>
      </div>
      <div class="text-right flex flex-col items-end">
        <div class="flex items-center gap-4">
             <!-- ƒê√É ·∫®N T·ªîNG V·ªêN -->
             <div class="hidden">
                <div class="text-xs text-gray-400 uppercase font-bold">T·ªïng V·ªën</div>
                <div id="totalValue" class="text-xl font-bold text-red-600 leading-none">0 ‚Ç´</div>
             </div>
             <div class="border-l pl-4 hidden md:block border-none pl-0"> <!-- B·ªè border do ·∫©n v·ªën -->
                <div class="text-xs text-gray-400 uppercase font-bold">S·∫£n ph·∫©m</div>
                <div id="totalCount" class="text-3xl font-bold text-gray-800 leading-none">0</div>
             </div>
        </div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="flex flex-col xl:flex-row gap-3">
        <div class="relative flex-1">
            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input id="searchInput" type="text" oninput="applyFilter()" placeholder="T√¨m ki·∫øm SERI, T√™n m√°y..."
            class="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-all shadow-sm text-gray-700" />
        </div>
        
        <div class="flex gap-2 overflow-x-auto pb-1 xl:pb-0">
            <select id="filterType" onchange="applyFilter()" class="border border-gray-200 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-green-500 text-gray-700 font-bold bg-white cursor-pointer shadow-sm min-w-[120px]">
                <option value="ALL">üì¶ T·∫•t c·∫£ Lo·∫°i</option>
                <option value="PHONE">üì± PHONE</option>
                <option value="IPAD">üìü IPAD</option>
                <option value="PHUKIEN">üéß PHUKIEN (Seri)</option>
            </select>

            <select id="filterLocation" onchange="applyFilter()" class="border border-gray-200 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-green-500 text-gray-700 font-bold bg-white cursor-pointer shadow-sm min-w-[140px]">
                <option value="ALL">üè¢ T·∫•t c·∫£ Kho</option>
                <option value="KHO">üè† Kho T·ªïng</option>
                <option value="CN1">üìç CN 1</option>
                <option value="CN2">üìç CN 2</option>
            </select>
        </div>

        <div class="flex gap-2 shrink-0">
            <!-- N√∫t Copy Nhi·ªÅu -->
            <button id="btnCopyMulti" onclick="copySelectedItems()" class="hidden px-4 py-2.5 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg hover:bg-blue-100 font-bold transition-colors shadow-sm flex items-center gap-2">
                <i class="fa-regular fa-copy"></i> <span id="lblCopyMulti">Copy (0)</span>
            </button>

            <!-- N√∫t Xu·∫•t TXT -->
            <button onclick="exportToTxt()" class="px-4 py-2.5 bg-gray-100 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-200 font-medium transition-colors shadow-sm flex items-center gap-2" title="Xu·∫•t ra Notepad">
                <i class="fa-solid fa-file-lines"></i> TXT
            </button>

            <button onclick="loadData()" class="px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition-colors flex items-center gap-2 shadow-sm border border-gray-200">
                <i class="fa-solid fa-rotate"></i>
            </button>
            <button onclick="openModal('add')" class="px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition-colors shadow-sm flex items-center gap-2">
                <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">Th√™m M√°y</span>
            </button>
        </div>
    </div>
  </div>

  <!-- Table Container -->
  <div class="relative bg-white rounded-xl shadow border border-gray-200 overflow-hidden flex flex-col" style="min-height: 500px;">
    <div id="loading" class="hidden absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-700 mb-3"></div>
        <span class="text-green-700 font-medium text-xs animate-pulse">ƒêang k·∫øt n·ªëi d·ªØ li·ªáu...</span>
    </div>

    <div class="overflow-x-auto custom-scrollbar flex-1">
        <table class="min-w-full text-left border-collapse">
            <thead class="bg-gray-800 text-white text-xs uppercase sticky top-0 z-20 shadow-md">
                <tr>
                    <th class="p-3 w-10 text-center">
                        <input type="checkbox" id="checkAll" onchange="toggleAll(this)" class="custom-checkbox align-middle">
                    </th>
                    <th class="p-3 text-center w-12">#</th>
                    <th class="p-3 w-28 text-center">V·ªä TR√ç</th>
                    <th class="p-3 w-32 font-bold">SERI / IMEI</th>
                    <th class="p-3 min-w-[350px]">TH√îNG TIN M√ÅY <span class="normal-case font-normal text-gray-400 italic ml-1">(Click ƒë·ªÉ copy)</span></th> 
                    <th class="p-3 w-40">GHI CH√ö</th>
                    <th class="p-3 text-center w-16 sticky right-0 bg-gray-800 sticky-col-shadow">X·ª≠ L√Ω</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="divide-y divide-gray-100 text-gray-700 text-sm">
                <!-- Data Render Here -->
            </tbody>
        </table>
    </div>
  </div>
</div>

<!-- ================= MODAL ADD/EDIT ================= -->
<div id="modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center transition-opacity duration-200 modal-hide backdrop-blur-sm hidden">
  <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden transform transition-all duration-200 scale-95">
    
    <div class="flex justify-between items-center p-4 border-b shrink-0 bg-green-50">
        <h2 class="text-lg font-bold text-green-800 flex items-center gap-2">
            <i class="fa-solid fa-mobile"></i> <span id="modalTitle">Nh·∫≠p Kho M√°y</span>
        </h2>
        <button onclick="closeModal()" class="text-gray-400 hover:text-red-500 text-xl">&times;</button>
    </div>

    <!-- Tabs cho ch·∫ø ƒë·ªô Nh·∫≠p -->
    <div id="addTabs" class="flex border-b text-sm bg-white shrink-0">
        <button onclick="switchAddTab('single')" id="tabSingle" class="flex-1 py-3 font-bold text-green-700 border-b-2 border-green-700 bg-green-50 transition-colors">Nh·∫≠p L·∫ª</button>
        <button onclick="switchAddTab('bulk')" id="tabBulk" class="flex-1 py-3 text-gray-500 font-medium hover:bg-gray-50 transition-colors">Nh·∫≠p L√¥ (Excel)</button>
    </div>

    <div class="p-6 overflow-y-auto flex-1 space-y-4">
        <input type="hidden" id="item_key"> <!-- Key s·ª≠a (SERI) -->

        <!-- Form Nh·∫≠p L·∫ª -->
        <div id="formSingle">
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2 md:col-span-1">
                    <label class="block text-xs font-bold text-green-700 mb-1">SERI / IMEI <span class="text-red-500">*</span></label>
                    <input type="text" id="inp_id" class="w-full border border-gray-300 rounded p-2 focus:border-green-500 outline-none uppercase font-mono font-bold" placeholder="Scan ho·∫∑c nh·∫≠p...">
                </div>
                <div class="col-span-2 md:col-span-1">
                    <label class="block text-xs font-bold text-green-700 mb-1">T√äN M√ÅY <span class="text-red-500">*</span></label>
                    <input type="text" id="inp_name" class="w-full border border-gray-300 rounded p-2 focus:border-green-500 outline-none" placeholder="VD: iPhone 14 Pro Max">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-4">
                 <div><label class="block text-xs font-bold text-gray-600 mb-1">Dung l∆∞·ª£ng</label><input type="text" id="inp_dl" class="w-full border p-2 rounded outline-none focus:border-green-500" list="list_dl"></div>
                 <div><label class="block text-xs font-bold text-gray-600 mb-1">M√†u s·∫Øc</label><input type="text" id="inp_color" class="w-full border p-2 rounded outline-none focus:border-green-500"></div>
                 <div><label class="block text-xs font-bold text-gray-600 mb-1">Sim/Wifi</label><input type="text" id="inp_sim" class="w-full border p-2 rounded outline-none focus:border-green-500"></div>
                 <div><label class="block text-xs font-bold text-gray-600 mb-1">T√¨nh tr·∫°ng</label><input type="text" id="inp_tt" class="w-full border p-2 rounded outline-none focus:border-green-500" placeholder="VD: 99"></div>
                 <div><label class="block text-xs font-bold text-gray-600 mb-1">Pin (%)</label><input type="number" id="inp_pin" class="w-full border p-2 rounded outline-none focus:border-green-500"></div>
                 
                 <!-- Ch·ªçn Sheet l∆∞u -->
                 <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">Lo·∫°i M√°y (Sheet)</label>
                    <select id="inp_type_device" class="w-full border p-2 rounded bg-white outline-none focus:border-green-500">
                        <option value="PHONE">PHONE (ƒêi·ªán tho·∫°i)</option>
                        <option value="IPAD">IPAD (M√°y t√≠nh b·∫£ng)</option>
                        <option value="PHUKIEN">PHUKIEN (C√≥ Seri)</option>
                    </select>
                 </div>
                 
                 <!-- Ch·ªçn V·ªã tr√≠ nh·∫≠p (M·∫∑c ƒë·ªãnh Kho T·ªïng) -->
<div class="col-span-2 bg-yellow-50 p-2 rounded border border-yellow-200 hidden">
    <label class="block text-xs font-bold text-yellow-800 mb-1">V·ªä TR√ç NH·∫¨P KHO</label>
    <select id="inp_location" class="w-full border border-yellow-400 rounded p-2 focus:ring-2 focus:ring-yellow-500 outline-none bg-white font-bold text-gray-700 cursor-pointer">
        <option value="KHO" selected>üè† KHO T·ªîNG (M·∫∑c ƒë·ªãnh)</option>
        <option value="CN1">üè¢ CHI NH√ÅNH 1</option>
        <option value="CN2">üè¢ CHI NH√ÅNH 2</option>
    </select>
</div>

            </div>

            <div class="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded mt-4">
<div>
  <label class="block text-xs font-bold text-red-600 mb-1">
    GI√Å B√ÅN (ngh√¨n) üîí
  </label>
  <input 
    type="text"
    id="inp_giaban"
    class="w-full border border-red-300 rounded p-2 font-bold text-red-700 bg-gray-100 cursor-not-allowed outline-none"
    readonly
    onkeyup="formatCurrency(this)"
  >
</div>

                <!-- ·∫®N GI√Å V·ªêN -->
                <div class="hidden">
                  <label class="block text-xs font-bold text-gray-600 mb-1">GI√Å V·ªêN</label>
                  <input type="text" id="inp_gianhap" class="w-full border border-gray-300 rounded p-2 outline-none" onkeyup="formatCurrency(this)">
                </div>
            </div>
            
            <div class="mt-4">
                <label class="block text-xs font-bold text-gray-600 mb-1">Ghi ch√∫</label>
                <textarea id="inp_note" rows="2" class="w-full border border-gray-300 rounded p-2 outline-none focus:border-green-500"></textarea>
            </div>
        </div>

        <!-- Form Nh·∫≠p L√¥ -->
        <div id="formBulk" class="hidden h-full flex flex-col">
            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4 text-xs text-blue-700">
                <p class="font-bold">C√∫ ph√°p nh·∫≠p (ph√¢n c√°ch |):</p>
                <code class="block mt-1 bg-white p-1 rounded border overflow-x-auto whitespace-nowrap">SERI | T√äN | DL | M√ÄU | SIM | TT | PIN | GHI CH√ö | GI√Å B√ÅN | GI√Å NH·∫¨P</code>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                 <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">Lo·∫°i M√°y</label>
                    <select id="bulk_type" class="w-full border p-2 rounded bg-white"><option value="PHONE">PHONE</option><option value="IPAD">IPAD</option></select>
                 </div>
                 <div>
                    <label class="block text-xs font-bold text-yellow-800 mb-1">Nh·∫≠p v√†o</label>
                    <select id="bulk_location" class="w-full border border-yellow-400 rounded p-2 font-bold text-gray-700 bg-white">
                        <option value="KHO" selected>üè† KHO T·ªîNG</option>
                        <option value="CN1">üè¢ CHI NH√ÅNH 1</option>
                        <option value="CN2">üè¢ CHI NH√ÅNH 2</option>
                    </select>
                 </div>
            </div>

            <textarea id="bulkInput" rows="10" 
              class="w-full border border-gray-300 rounded-lg p-3 font-mono text-sm focus:ring-2 focus:ring-green-500 outline-none flex-1"
              placeholder="Paste d·ªØ li·ªáu t·ª´ Excel v√†o ƒë√¢y..."></textarea>
        </div>
    </div>

    <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end gap-3 shrink-0">
      <button onclick="closeModal()" class="px-5 py-2 border rounded-lg hover:bg-gray-100 text-gray-600">H·ªßy</button>
      <button onclick="saveData()" class="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-lg font-medium transition transform active:scale-95">
        <i class="fa-solid fa-save mr-1"></i> L∆∞u D·ªØ Li·ªáu
      </button>
    </div>
  </div>
</div>

<!-- Modal Nh·∫≠p C·ªçc -->
<div id="depositModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center transition-opacity duration-200 modal-hide backdrop-blur-sm hidden">
    <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 relative flex flex-col gap-4">
        <h2 class="font-bold text-lg text-yellow-700 flex items-center gap-2"><i class="fa-solid fa-money-bill-wave"></i> Nh·∫≠n C·ªçc M√°y</h2>
        <input type="hidden" id="dep_seri">
        <div id="dep_name_serial" class="font-bold text-gray-800 text-center bg-gray-50 p-2 rounded text-sm break-all"></div>
        
        <div>
            <label class="block text-xs font-bold text-gray-500 mb-1">Th√¥ng tin ghi ch√∫ ho·∫∑c s·ªë ti·ªÅn c·ªçc</label>
            <input type="text" id="dep_info" class="w-full border-2 border-yellow-300 rounded p-2 focus:outline-none font-bold text-red-600" placeholder="VD: 500k - A Tu·∫•n SƒêT...">
        </div>
        
        <div class="flex justify-end gap-2 mt-2">
            <button onclick="closeDepositModal()" class="px-4 py-2 border rounded hover:bg-gray-100">H·ªßy</button>
            <button onclick="confirmDeposit()" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 font-bold shadow">L∆∞u C·ªçc</button>
        </div>
    </div>
</div>

<!-- ACTION SHEET (MENU 3 CH·∫§M) -->
<div id="actionSheet" class="fixed inset-0 bg-black/60 z-50 flex items-end justify-center hidden">
    <div class="bg-white w-full max-w-md rounded-t-2xl shadow-2xl overflow-hidden transform translate-y-full transition-transform duration-200" onclick="event.stopPropagation()">
        <div class="bg-gray-100 p-4 text-center border-b font-bold text-gray-700 truncate" id="mas_title">T√™n M√°y</div>
        <input type="hidden" id="mas_seri">
        <input type="hidden" id="mas_name">
        <div class="p-4 space-y-3">
             <button onclick="triggerAction('deposit')" class="w-full py-3 bg-yellow-50 text-yellow-700 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-yellow-100"><i class="fa-solid fa-money-bill-1-wave text-lg"></i> Ghi Ch√∫</button>
             <button onclick="triggerAction('edit')" class="w-full py-3 bg-blue-50 text-blue-700 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-blue-100"><i class="fa-solid fa-pen text-lg"></i> S·ª≠a Th√¥ng Tin</button>
             <!-- ƒê√É B·ªé N√öT X√ìA M√ÅY -->
        </div>
        <div class="p-4 border-t">
            <button onclick="closeActionMenu()" class="w-full py-3 bg-gray-200 text-gray-700 rounded-xl font-bold">H·ªßy B·ªè</button>
        </div>
    </div>
</div>

<datalist id="list_dl"><option>64GB</option><option>128GB</option><option>256GB</option><option>512GB</option><option>1TB</option></datalist>

<script>
// ==========================================
// ‚ö†Ô∏è Thay link Web App Backend (Code.gs)
const API_URL = 'https://script.google.com/macros/s/AKfycbz0wygOHQKBXHIRQvUMnyE0GygUKwVfovJu6dxRzIOYdBukyB-k7JGO3xRtzqfUxN8W/exec'; 
// ==========================================

let allData = [];
let currentAddTab = 'single';
let isEditing = false;
let selectedItems = new Set(); // Stores selected SERIs

const qs = (s) => document.querySelector(s);
const formatMoney = (n) => n ? Number(String(n).replace(/\D/g, '')).toLocaleString('vi-VN') : '0';
const parseMoney = (n) => n ? Number(String(n).replace(/\D/g, '')) : 0;
function formatCurrency(input) { let val = input.value.replace(/\D/g, ''); input.value = val ? Number(val).toLocaleString('vi-VN') : ''; }

// Helper ƒë·ªÉ ƒë·ªãnh d·∫°ng gi√° theo ki·ªÉu 20.000k (Input l√† 4400 -> Output 4.400k)
const formatPriceK = (price) => {
    if(!price) return '0k';
    return Number(price).toLocaleString('vi-VN') + 'k';
}

// H√†m t·∫°o chu·ªói th√¥ng tin chu·∫©n ƒë·ªÉ copy/xu·∫•t
function getItemInfoString(item) {
    const tinhTrangStr = item.TINHTRANG ? (String(item.TINHTRANG).includes('%') ? item.TINHTRANG : item.TINHTRANG + '%') : '';
    const parts = [
        item.NAME,
        item.DL,
        item.COLOR ? `m√†u ${item.COLOR}` : '',
        item.SIM,
        tinhTrangStr ? `T√¨nh tr·∫°ng ${tinhTrangStr}` : '',
        item.PIN ? `Pin ${item.PIN}%` : '',
        `gi√° ${formatPriceK(item.GIABAN)}`
    ];
    return parts.filter(Boolean).join(' ');
}

// C·∫¨P NH·∫¨T LOAD DATA
async function loadData() {
    qs('#loading').classList.remove('hidden');
    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ action: "get_serialized" })
        });
        const json = await res.json();
        
        if(json.success && Array.isArray(json.data)) {
            allData = json.data.reverse(); 
            selectedItems.clear(); // Reset selection
            updateSelectionUI();
            applyFilter();
        } else {
            console.error("D·ªØ li·ªáu l·ªói:", json.message);
            allData = [];
            renderTable([]);
        }
    } catch(e) { console.error(e); }
    qs('#loading').classList.add('hidden');
}

// LOGIC FILTER
function applyFilter() {
    const k = qs('#searchInput').value.toLowerCase().trim();
    const loc = qs('#filterLocation').value;
    const type = qs('#filterType').value;

    let totalValue = 0;

    const filtered = allData.filter(item => {
        const nameStr = item.NAME ? String(item.NAME).toLowerCase() : "";
        const seriStr = item.SERI ? String(item.SERI).toLowerCase() : "";
        
        const matchText = (nameStr.includes(k) || seriStr.includes(k));
        let matchLoc = (loc === 'ALL') ? true : (item.LOCATION || 'KHO') === loc;
        let matchType = (type === 'ALL') ? true : item.TYPE === type;

        return matchText && matchLoc && matchType;
    });

    // V·∫´n t√≠nh to√°n nh∆∞ng kh√¥ng hi·ªÉn th·ªã
    filtered.forEach(i => {
        totalValue += Number(i.GIANHAP) || 0;
    });

    renderTable(filtered);
    qs('#totalCount').innerText = filtered.length;
    qs('#totalValue').innerText = formatMoney(totalValue) + ' ‚Ç´';
}

// MULTI-SELECT & COPY LOGIC
function toggleAll(el) {
    const visibleRows = document.querySelectorAll('.row-checkbox');
    visibleRows.forEach(cb => {
        cb.checked = el.checked;
        if(el.checked) selectedItems.add(cb.value);
        else selectedItems.delete(cb.value);
    });
    updateSelectionUI();
}

function toggleRow(seri) {
    if(selectedItems.has(seri)) selectedItems.delete(seri);
    else selectedItems.add(seri);
    updateSelectionUI();
}

function updateSelectionUI() {
    const count = selectedItems.size;
    const btn = qs('#btnCopyMulti');
    const lbl = qs('#lblCopyMulti');
    
    if(count > 0) {
        btn.classList.remove('hidden');
        lbl.innerText = `Copy (${count})`;
    } else {
        btn.classList.add('hidden');
    }
}

function copySelectedItems() {
    if(selectedItems.size === 0) return;
    
    // T√¨m c√°c item trong allData kh·ªõp v·ªõi SERI ƒë√£ ch·ªçn v√† gi·ªØ th·ª© t·ª±
    const itemsToCopy = allData.filter(i => selectedItems.has(i.SERI));
    
    const textToCopy = itemsToCopy.map(item => getItemInfoString(item)).join('\n');
    
    navigator.clipboard.writeText(textToCopy).then(() => {
        alert(`ƒê√£ copy ${itemsToCopy.length} m√°y v√†o clipboard!`);
        selectedItems.clear();
        document.querySelectorAll('.custom-checkbox').forEach(cb => cb.checked = false);
        updateSelectionUI();
    });
}

function copySingleItem(seri, element) {
    const item = allData.find(i => i.SERI === seri);
    if(!item) return;
    
    const text = getItemInfoString(item);
    navigator.clipboard.writeText(text).then(() => {
        // Visual feedback
        element.classList.add('copy-feedback');
        setTimeout(() => element.classList.remove('copy-feedback'), 500);
    });
}

function exportToTxt() {
    const k = qs('#searchInput').value.toLowerCase().trim();
    const loc = qs('#filterLocation').value;
    const type = qs('#filterType').value;

    // L·∫•y d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã (ƒë√£ filter)
    const filtered = allData.filter(item => {
        const nameStr = item.NAME ? String(item.NAME).toLowerCase() : "";
        const seriStr = item.SERI ? String(item.SERI).toLowerCase() : "";
        const matchText = (nameStr.includes(k) || seriStr.includes(k));
        let matchLoc = (loc === 'ALL') ? true : (item.LOCATION || 'KHO') === loc;
        let matchType = (type === 'ALL') ? true : item.TYPE === type;
        return matchText && matchLoc && matchType;
    });

    if(filtered.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");

    const textContent = filtered.map(item => getItemInfoString(item)).join('\n');
    
    const blob = new Blob([textContent], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Danh_sach_may_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function renderTable(data) {
    const tbody = qs('#tableBody');
    tbody.innerHTML = '';
    
    if(data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-400 italic">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
        return;
    }

    data.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-green-50 transition-colors border-b last:border-0 group bg-white';
        
        // Badge V·ªã Tr√≠
        const loc = item.LOCATION || 'KHO';
        let locClass = 'loc-kho';
        let locIcon = 'fa-warehouse';
        if(loc === 'CN1') { locClass = 'loc-cn1'; locIcon = 'fa-store'; }
        if(loc === 'CN2') { locClass = 'loc-cn2'; locIcon = 'fa-store'; }
        const locBadge = `<span class="loc-badge ${locClass}"><i class="fa-solid ${locIcon}"></i> ${loc === 'KHO' ? 'KHO T·ªîNG' : loc}</span>`;

        // Chu·ªói hi·ªÉn th·ªã
        const infoString = getItemInfoString(item).replace(item.COC ? '' : '', ''); // Hacky way to use existing var
        const displayHtml = infoString.replace(item.NAME, `<strong>${item.NAME}</strong>`)
                                      .replace(`gi√° ${formatPriceK(item.GIABAN)}`, `<span class="text-red-600 font-bold">gi√° ${formatPriceK(item.GIABAN)}</span>`);

        const cocHtml = item.COC ? `<span class="coc-badge text-[10px] ml-2">${item.COC}</span>` : '';

        // Check state
        const isChecked = selectedItems.has(item.SERI) ? 'checked' : '';

        tr.innerHTML = `
            <td class="p-3 text-center w-10">
                <input type="checkbox" value="${item.SERI}" onchange="toggleRow('${item.SERI}')" class="custom-checkbox row-checkbox align-middle" ${isChecked}>
            </td>
            <td class="px-3 py-3 text-center text-xs text-gray-400 font-bold">${i + 1}</td>
            
            <td class="px-3 py-3 text-center">
                ${locBadge}
            </td>

            <td class="px-3 py-3 font-mono text-xs font-bold text-gray-700 text-center select-all hover:text-green-700 cursor-pointer" onclick="navigator.clipboard.writeText('${item.SERI}')">
                ${item.SERI}
            </td>

            <td class="px-3 py-3 text-sm text-gray-800 leading-snug cursor-pointer hover:text-green-800" onclick="copySingleItem('${item.SERI}', this)" title="Click ƒë·ªÉ copy">
                ${displayHtml} ${cocHtml}
            </td>

            <td class="px-3 py-3 text-xs text-gray-500 italic max-w-[150px] truncate" title="${item.GHICHU || ''}">
                ${item.GHICHU || ''}
            </td>

            <td class="px-2 py-3 text-center sticky right-0 bg-white group-hover:bg-green-50">
                <button onclick="openActionMenu('${item.SERI}')" class="w-8 h-8 rounded-full text-gray-400 hover:text-green-600 hover:bg-green-100 transition inline-flex items-center justify-center">
                    <i class="fa-solid fa-ellipsis-vertical"></i>
                </button>
            </td>
        `;

        tbody.appendChild(tr);
    });
}

// === ACTION SHEET LOGIC (MENU 3 CH·∫§M) ===
function openActionMenu(seri) {
    const item = allData.find(i => i.SERI === seri);
    const name = item ? item.NAME : '';

    qs('#mas_title').innerText = name;
    qs('#mas_seri').value = seri;
    qs('#mas_name').value = name;
    const sheet = qs('#actionSheet');
    sheet.classList.remove('hidden');
    setTimeout(() => { sheet.children[0].classList.remove('translate-y-full'); }, 10);
    sheet.onclick = closeActionMenu;
}

function closeActionMenu() {
    const sheet = qs('#actionSheet');
    sheet.children[0].classList.add('translate-y-full');
    setTimeout(() => { sheet.classList.add('hidden'); }, 200);
}

function triggerAction(action) {
    const seri = qs('#mas_seri').value;
    const name = qs('#mas_name').value;
    const item = allData.find(i => i.SERI === seri);
    
    const sheet = qs('#actionSheet');
    sheet.children[0].classList.add('translate-y-full');
    
    setTimeout(() => {
        sheet.classList.add('hidden');
        if(action === 'deposit') openDepositModal(seri, name, item ? item.COC : '');
        if(action === 'edit') openEditModal(seri);
    }, 200);
}

// === DEPOSIT LOGIC ===
function openDepositModal(seri, name, currentCoc) {
    qs('#depositModal').classList.remove('hidden');
    setTimeout(() => { qs('#depositModal').classList.remove('modal-hide'); qs('#depositModal').classList.add('modal-open'); }, 10);
    qs('#dep_seri').value = seri;
    qs('#dep_name_serial').innerText = name + " - " + seri;
    qs('#dep_info').value = currentCoc || '';
}

function closeDepositModal() {
    qs('#depositModal').classList.remove('modal-open'); 
    qs('#depositModal').classList.add('modal-hide');
    setTimeout(() => qs('#depositModal').classList.add('hidden'), 200);
}

async function confirmDeposit() {
    const seri = qs('#dep_seri').value;
    const info = qs('#dep_info').value.trim();
    
    const item = allData.find(i => i.SERI === seri);
    if(item) {
        item.COC = info;
        renderTable(allData); // Refresh table optimistic
    }
    closeDepositModal();

    const body = { action: 'update_deposit', SERI: seri, COC_INFO: info };
    try {
        await fetch(API_URL, { method: 'POST', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(body) });
    } catch(e) { alert("L·ªói: " + e.message); loadData(); }
}

// === ACTIONS ===
function openModal(mode) {
    qs('#modal').classList.remove('hidden'); setTimeout(() => { qs('#modal').classList.remove('modal-hide'); qs('#modal').classList.add('modal-open'); }, 10);
    if(mode === 'add') {
        isEditing = false; qs('#modalTitle').innerText = 'Nh·∫≠p Kho M√°y'; qs('#item_key').value = '';
        qs('#inp_id').value = ''; qs('#inp_id').disabled = false; qs('#inp_name').value = ''; qs('#inp_dl').value = ''; qs('#inp_color').value = ''; 
        qs('#inp_sim').value = ''; qs('#inp_tt').value = ''; qs('#inp_pin').value = ''; qs('#inp_giaban').value = ''; qs('#inp_gianhap').value = ''; qs('#inp_note').value = '';
        qs('#inp_location').value = 'KHO'; qs('#bulk_location').value = 'KHO';
        qs('#addTabs').classList.remove('hidden'); switchAddTab('single');
    }
}
function openEditModal(seri) {
    const item = allData.find(i => i.SERI === seri);
    if(!item) return;
    openModal(); isEditing = true; qs('#modalTitle').innerText = 'S·ª≠a Th√¥ng Tin M√°y'; qs('#addTabs').classList.add('hidden'); switchAddTab('single');
    qs('#item_key').value = seri; qs('#inp_id').value = seri; qs('#inp_id').disabled = true;
    qs('#inp_name').value = item.NAME; qs('#inp_dl').value = item.DL; qs('#inp_color').value = item.COLOR;
    qs('#inp_sim').value = item.SIM; qs('#inp_tt').value = item.TINHTRANG; qs('#inp_pin').value = item.PIN; qs('#inp_note').value = item.GHICHU;
    qs('#inp_giaban').value = formatMoney(item.GIABAN); qs('#inp_gianhap').value = formatMoney(item.GIANHAP);
    qs('#inp_type_device').value = item.TYPE; qs('#inp_location').value = item.LOCATION || 'KHO';
}
function closeModal() { qs('#modal').classList.remove('modal-open'); qs('#modal').classList.add('modal-hide'); setTimeout(() => qs('#modal').classList.add('hidden'), 200); }
function switchAddTab(tab) {
    currentAddTab = tab;
    const btnSingle = qs('#tabSingle'); const btnBulk = qs('#tabBulk'); const formSingle = qs('#formSingle'); const formBulk = qs('#formBulk');
    if(tab === 'single') {
        btnSingle.className = "flex-1 py-3 font-bold text-green-700 border-b-2 border-green-700 bg-green-50 transition-colors";
        btnBulk.className = "flex-1 py-3 text-gray-500 font-medium hover:bg-gray-50 transition-colors";
        formSingle.classList.remove('hidden'); formBulk.classList.add('hidden');
    } else {
        btnSingle.className = "flex-1 py-3 text-gray-500 font-medium hover:bg-gray-50 transition-colors";
        btnBulk.className = "flex-1 py-3 font-bold text-green-700 border-b-2 border-green-700 bg-green-50 transition-colors";
        formSingle.classList.add('hidden'); formBulk.classList.remove('hidden');
    }
}
async function saveData() {
    let body = {};
    if (currentAddTab === 'single' || isEditing) {
        const id = qs('#inp_id').value.trim().toUpperCase(); const name = qs('#inp_name').value.trim();
        if(!id || !name) return alert("Vui l√≤ng nh·∫≠p Seri v√† T√™n m√°y!");
        const item = {
            SERI: id, NAME: name, DL: qs('#inp_dl').value, COLOR: qs('#inp_color').value, 
            SIM: qs('#inp_sim').value, TINHTRANG: qs('#inp_tt').value, PIN: qs('#inp_pin').value, TYPE: qs('#inp_type_device').value,
            GIABAN: parseMoney(qs('#inp_giaban').value), GIANHAP: parseMoney(qs('#inp_gianhap').value), 
            GHICHU: qs('#inp_note').value, LOCATION: qs('#inp_location').value || 'KHO'
        };
        if(isEditing) {
            body = { action: 'edit', ...item };
            const idx = allData.findIndex(x => x.SERI === id);
            if(idx !== -1) { item._STYLE = allData[idx]._STYLE; allData[idx] = item; }
        } else {
            body = { action: 'add_multi', items: [item] };
            allData.unshift(item);
        }
    } else { 
        const rawText = qs('#bulkInput').value.trim();
        if(!rawText) return alert("Vui l√≤ng nh·∫≠p d·ªØ li·ªáu!");
        const type = qs('#bulk_type').value; const location = qs('#bulk_location').value || 'KHO'; const items = [];
        rawText.split('\n').forEach(line => {
            const p = line.split('|').map(t => t.trim());
            if (p.length >= 2) {
                items.push({
                    SERI: p[0], NAME: p[1], DL: p[2]||'', COLOR: p[3]||'', SIM: p[4]||'',
                    TINHTRANG: p[5]||'', PIN: p[6]||'', GHICHU: p[7]||'',
                    GIABAN: parseMoney(p[8]), GIANHAP: parseMoney(p[9]), TYPE: type, LOCATION: location
                });
            }
        });
        if(items.length===0) return alert("D·ªØ li·ªáu l·ªói!");
        body = { action: 'add_multi', items: items };
        allData = [...items.reverse(), ...allData];
    }
    applyFilter(); closeModal();
    try { await fetch(API_URL, { method: 'POST', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(body) }); setTimeout(loadData, 500); } catch(e) { alert("L·ªói l∆∞u: " + e.message); loadData(); }
}
async function deleteProduct(seri) {
  if(!confirm(`X√≥a m√°y Seri: ${seri}?`)) return;
  const oldData = [...allData]; allData = allData.filter(i => i.SERI !== seri); qs('#totalCount').innerText = allData.length; applyFilter();
  try { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', SERI: seri }) }); } catch(e) { alert("L·ªói x√≥a: " + e.message); allData = oldData; applyFilter(); }
}

qs('#searchInput').addEventListener('input', applyFilter);
loadData();
</script>
</body>
</html>