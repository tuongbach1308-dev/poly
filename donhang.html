<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n L√Ω ƒê∆°n H√†ng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
  <!-- Font cho phi·∫øu in -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Times+New+Roman:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    /* Base Settings */
    :root { --primary: #4f46e5; --primary-hover: #4338ca; --success: #16a34a; --danger: #dc2626; --warning: #ca8a04; }
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    /* Utility Classes */
    .font-mono { font-family: 'Roboto Mono', monospace; }
    .modal-open { opacity: 1; transform: scale(1); pointer-events: auto; }
    .modal-hide { opacity: 0; transform: scale(0.95); pointer-events: none; }
    
    /* Responsive Helpers */
    .desktop-cell { display: none; }
    @media (min-width: 1024px) { .desktop-cell { display: table-cell; } }

    /* Sticky Columns Shadow */
    .sticky-right { position: sticky; right: 0; z-index: 20; }
    .shadow-left { box-shadow: -4px 0 8px -2px rgba(0,0,0,0.1); }

    /* Print Styles (FIXED for Multi-page) */
    @media print {
        body * { visibility: hidden; }
        #printModal, #printModal * { visibility: visible; }
        #printModal { 
            position: absolute; left: 0; top: 0; width: 100%; height: auto; 
            background: white; z-index: 9999; overflow: visible !important; 
            display: block !important;
        }
        #print-editor, #print-mobile-tabs, .no-print { display: none !important; }
        
        #print-preview { 
            display: block !important; 
            width: 100% !important; 
            height: auto !important; 
            overflow: visible !important; 
            padding: 0 !important; 
            margin: 0 !important; 
        }
        
        #preview-wrapper { 
            transform: none !important; 
            box-shadow: none !important; 
            margin: 0 !important; 
            width: 100% !important; 
        }
        
        .page-container { 
            width: 100% !important; 
            /* Remove fixed height to prevent cutting */
            height: auto !important; 
            min-height: 290mm; /* Ensure approx A4 height */
            margin: 0 !important; 
            padding: 0 !important; 
            border: none !important; 
            display: block !important; 
            page-break-after: always !important; /* Force page break */
            break-after: page;
            overflow: visible !important;
        }
        
        .page-container:last-child { 
            page-break-after: auto !important; 
            break-after: auto;
        }
        
        .warranty-card { 
            padding: 10mm 15mm !important; 
            height: 100% !important; 
        }
        
        * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    }
    
    /* A4 Paper Preview */
    .page-container { width: 210mm; height: 296mm; background: white; margin: 0 auto 20px; padding: 0; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); box-sizing: border-box; overflow: hidden; position: relative; }
    .warranty-card { font-family: 'Times New Roman', serif; width: 100%; height: 100%; padding: 10mm 15mm; font-size: 11pt; color: #000; line-height: 1.4; position: relative; box-sizing: border-box; }
    .dotted-line { border-bottom: 1px dotted #000; flex-grow: 1; margin-left: 5px; position: relative; height: 1.4em; display: inline-block; }
    .input-value { position: absolute; bottom: 2px; left: 0; font-weight: bold; font-family: 'Roboto', sans-serif; white-space: nowrap; width: 100%; }
    
    .tech-check { font-weight: bold; margin-left: 10px; }
    .tech-check.replaced { color: #dc2626; } 
    .tech-check.original { color: #166534; }
    
    .section-title { font-weight: bold; text-transform: uppercase; font-size: 12pt; margin-top: 15px; margin-bottom: 8px; text-decoration: underline; }
    .policy-text { text-align: justify; margin-bottom: 6px; line-height: 1.3; font-size: 10.5pt; }
  </style>
</head>
<body class="text-gray-800">

<div class="p-3 md:p-6 w-full max-w-[1600px] mx-auto pb-24 no-print">
  
  <!-- DASHBOARD STATS & HEADER -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="md:col-span-4 lg:col-span-1 flex flex-col justify-center">
          <h1 class="text-2xl font-bold text-indigo-700 flex items-center gap-2">
            <span class="bg-indigo-100 p-2 rounded-lg"><i class="fa-solid fa-file-invoice-dollar"></i></span>
            Qu·∫£n L√Ω ƒê∆°n H√†ng
          </h1>
          <p class="text-gray-500 text-xs mt-1 ml-1">H·ªá th·ªëng b·∫£o h√†nh & doanh thu</p>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
          <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-lg"><i class="fa-solid fa-sack-dollar"></i></div>
          <div>
              <div class="text-xs text-gray-500 font-medium uppercase">Doanh Thu</div>
              <div id="totalRevenue" class="text-xl font-bold text-gray-800">0 ‚Ç´</div>
          </div>
      </div>

      <!-- ·∫®N L·ª¢I NHU·∫¨N THEO Y√äU C·∫¶U -->
      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4 hidden">
          <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-lg"><i class="fa-solid fa-chart-line"></i></div>
          <div>
              <div class="text-xs text-gray-500 font-medium uppercase">L·ª£i Nhu·∫≠n</div>
              <div id="totalProfit" class="text-xl font-bold text-gray-800">0 ‚Ç´</div>
          </div>
      </div>

      <!-- M√ÅY B√ÅN RA (CH·ªà ƒê·∫æM SERI, KH√îNG ƒê·∫æM SKU PH·ª§ KI·ªÜN) -->
      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
          <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-lg"><i class="fa-solid fa-mobile-screen"></i></div>
          <div>
              <div class="text-xs text-gray-500 font-medium uppercase">M√°y B√°n Ra</div>
              <div id="totalSeriCount" class="text-xl font-bold text-gray-800">0</div>
          </div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
          <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-lg"><i class="fa-solid fa-receipt"></i></div>
          <div>
              <div class="text-xs text-gray-500 font-medium uppercase">ƒê∆°n H√†ng</div>
              <div id="totalCount" class="text-xl font-bold text-gray-800">0</div>
          </div>
      </div>
  </div>

  <!-- TOOLBAR & FILTERS -->
  <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4 flex flex-col md:flex-row gap-3 items-center z-30">
        <!-- B·ªò L·ªåC NG√ÄY V√Ä LO·∫†I ƒê∆†N -->
        <div class="flex gap-2 bg-gray-50 p-1.5 rounded-lg border border-gray-200 shrink-0 overflow-x-auto w-full md:w-auto items-center">
            <!-- M·ªöI: B·ªò L·ªåC LO·∫†I ƒê∆†N H√ÄNG -->
            <select id="filterCategory" onchange="filterData()" class="bg-white border border-gray-300 rounded px-2 py-1.5 text-xs outline-none focus:border-indigo-500 text-gray-600 font-bold h-[30px] cursor-pointer">
                <option value="ALL">üì¶ T·∫•t c·∫£</option>
                <option value="MACHINE">üì± M√°y (Serial)</option>
                <option value="ACCESSORY">üéß Ph·ª• Ki·ªán</option>
            </select>
            
            <div class="w-px h-4 bg-gray-300 mx-1"></div>

            <!-- CH·ªà C√íN CH·ªåN TH√ÅNG (M·∫∑c ƒë·ªãnh TH√ÅNG N√ÄY) -->
            <select id="filterTime" onchange="filterData()" class="bg-white border border-gray-300 rounded px-2 py-1.5 text-xs outline-none focus:border-indigo-500 text-indigo-700 font-bold h-[30px] cursor-pointer min-w-[120px]">
                <option value="THIS_MONTH" selected>üìÖ Th√°ng N√†y</option>
                <option value="LAST_MONTH">‚èÆÔ∏è Th√°ng Tr∆∞·ªõc</option>
            </select>
        </div>

        <div class="relative flex-1 w-full">
            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input id="searchInput" type="text" oninput="filterData()" placeholder="T√¨m t√™n kh√°ch, s·ªë seri, t√™n m√°y..."
            class="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all text-gray-700 placeholder-gray-400" />
        </div>

        <div class="flex gap-2 shrink-0 w-full md:w-auto">
            <button onclick="loadData()" class="px-4 py-2.5 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors border border-gray-200">
                <i class="fa-solid fa-rotate"></i>
            </button>
            <button onclick="openModal('add')" class="flex-1 md:flex-none px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-sm flex items-center justify-center gap-2 active:scale-95 transform duration-150">
                <i class="fa-solid fa-plus-circle"></i> <span>T·∫°o ƒê∆°n</span>
            </button>
        </div>
  </div>

  <!-- TABLE DATA -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col relative" style="min-height: 500px;">
    <div id="loading" class="hidden absolute inset-0 bg-white/80 backdrop-blur-[2px] z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-100 border-t-indigo-600 mb-3 shadow-lg"></div>
        <span class="text-indigo-700 font-bold text-sm animate-pulse">ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu...</span>
    </div>

    <div class="overflow-x-auto custom-scrollbar flex-1">
        <table class="min-w-full text-left border-collapse w-full">
            <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold sticky top-0 z-20 shadow-sm">
                <tr>
                    <th class="p-4 w-14 text-center desktop-cell">#</th>
                    <th class="p-4 w-28 text-center desktop-cell">Ng√†y B√°n</th>
                    <th class="p-4 min-w-[250px]">S·∫£n Ph·∫©m & Seri</th>
                    <th class="p-4 w-48 desktop-cell">Kh√°ch H√†ng</th>
                    <th class="p-4 w-32 text-center desktop-cell">B·∫£o H√†nh</th>
                    <th class="p-4 w-36 text-right desktop-cell">T√†i Ch√≠nh</th>
                    <th class="p-4 w-16 text-center sticky right-0 bg-gray-50 shadow-left">X·ª≠ L√Ω</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="divide-y divide-gray-100 text-sm text-gray-700"></tbody>
        </table>
    </div>
  </div>
</div>

<!-- MODAL ADD/EDIT (FULL SCREEN ON MOBILE) -->
<div id="modal" class="fixed inset-0 bg-black/60 z-40 flex items-center justify-center transition-opacity duration-200 modal-hide backdrop-blur-sm no-print hidden">
  <!-- Thay ƒë·ªïi class: Full screen mobile (w-full h-full), Popup desktop (md:h-auto md:max-w-4xl) -->
  <div class="bg-white w-full h-full md:h-auto md:max-w-4xl md:max-h-[90vh] md:rounded-2xl shadow-2xl flex flex-col overflow-hidden transform transition-all duration-200">
    <div class="bg-indigo-600 p-4 flex justify-between items-center text-white shrink-0">
        <h2 class="text-lg font-bold flex items-center gap-2"><i class="fa-solid fa-file-signature"></i> <span id="modalTitle">Th√¥ng Tin ƒê∆°n H√†ng</span></h2>
        <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-indigo-500 transition text-white text-xl">&times;</button>
    </div>
    
    <div class="p-6 overflow-y-auto grow bg-gray-50 space-y-6">
        <input type="hidden" id="seri_key">
        
        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm relative overflow-hidden">
             <div class="absolute top-0 left-0 bg-indigo-100 text-indigo-700 text-[10px] font-bold px-3 py-1 rounded-br-lg uppercase tracking-wider">Th√¥ng tin kh√°ch h√†ng</div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mt-3">
                 <div>
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">S·ªë ƒëi·ªán tho·∫°i <span class="text-red-500">*</span></label>
                     <input type="text" id="inp_sdt" onchange="lookupCustomer()" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 font-mono font-bold text-indigo-700 bg-indigo-50/30" placeholder="Nh·∫≠p SƒêT ƒë·ªÉ t√¨m...">
                 </div>
                 <div>
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">H·ªç T√™n Kh√°ch</label>
                     <input type="text" id="cust_name_display" class="w-full border border-gray-300 rounded-lg p-2.5 bg-gray-50 text-gray-600 font-medium cursor-not-allowed" readonly placeholder="(T·ª± ƒë·ªông hi·ªÉn th·ªã)">
                 </div>
             </div>
        </div>

        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm relative overflow-hidden">
             <div class="absolute top-0 left-0 bg-green-100 text-green-700 text-[10px] font-bold px-3 py-1 rounded-br-lg uppercase tracking-wider">Th√¥ng tin s·∫£n ph·∫©m</div>
             <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mt-3">
                 <div class="md:col-span-2">
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Seri / IMEI <span class="text-red-500">*</span></label>
                     <input type="text" id="inp_seri" onchange="lookupProduct()" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500 uppercase font-mono font-bold bg-green-50/30" placeholder="Qu√©t ho·∫∑c nh·∫≠p Seri...">
                 </div>
                 <div class="md:col-span-2">
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">T√™n M√°y / S·∫£n Ph·∫©m</label>
                     <input type="text" id="inp_name" class="w-full border border-gray-300 rounded-lg p-2.5 bg-gray-50 font-bold text-gray-700 cursor-not-allowed" readonly>
                 </div>
                 <div class="hidden"><input id="inp_dl"><input id="inp_color"><input id="inp_pin"><input id="inp_tt"><input id="inp_sim"></div>
             </div>
        </div>

        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm relative overflow-hidden">
             <div class="absolute top-0 left-0 bg-orange-100 text-orange-700 text-[10px] font-bold px-3 py-1 rounded-br-lg uppercase tracking-wider">Thanh to√°n & B·∫£o h√†nh</div>
             <div class="grid grid-cols-2 md:grid-cols-4 gap-5 mt-3">
                 <div>
                     <label class="block text-xs font-bold text-red-600 uppercase mb-1">Gi√° B√°n</label>
                     <input type="text" id="inp_giaban" onkeyup="formatCurrencyInput(this)" class="w-full border border-red-200 rounded-lg p-2.5 outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 font-bold text-red-600 bg-red-50/30 text-lg">
                 </div>
                 <!-- ·∫®N GI√Å V·ªêN THEO Y√äU C·∫¶U -->
                 <div class="hidden">
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Gi√° V·ªën</label>
                     <input type="text" id="inp_gianhap" class="w-full border border-gray-200 rounded-lg p-2.5 bg-gray-100 text-gray-400 text-sm font-mono cursor-not-allowed" readonly>
                 </div>
                 <div>
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ng√†y B√°n</label>
                     <input type="date" id="inp_date" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-indigo-500 text-sm font-medium text-gray-700">
                 </div>
                 <div>
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">H√¨nh Th·ª©c TT</label>
                     <!-- C·∫¨P NH·∫¨T LIST PTTT: CK, TM, G√ìP, TH·∫∫, N·ª¢ -->
                     <select id="inp_pttt" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none bg-white text-sm font-medium">
                         <option>CK</option>
                         <option>TM</option>
                         <option>G√ìP</option>
                         <option>TH·∫∫</option>
                         <option>N·ª¢</option>
                     </select>
                 </div>
                 <div>
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Bao Test</label>
                     <input type="text" id="inp_baotest" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" placeholder="7 ng√†y">
                 </div>
                 <div>
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">B·∫£o H√†nh</label>
                     <input type="text" id="inp_baohanh" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" placeholder="6 th√°ng">
                 </div>
                 <div class="col-span-2">
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nh√¢n Vi√™n Sale</label>
                     <!-- ƒê√£ ƒë·ªïi sang Select -->
                     <select id="inp_sale" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm font-bold text-indigo-700 bg-white outline-none focus:border-indigo-500">
                        <!-- Options s·∫Ω ƒë∆∞·ª£c JS th√™m v√†o -->
                     </select>
                 </div>
                 <div class="col-span-2 md:col-span-4">
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ghi Ch√∫ ƒê∆°n H√†ng</label>
                     <textarea id="inp_ghichu" rows="2" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-indigo-500 text-sm" placeholder="Ghi ch√∫ th√™m..."></textarea>
                 </div>
             </div>
        </div>
    </div>

    <div class="p-4 border-t bg-white flex justify-end gap-3 shrink-0">
      <button onclick="closeModal()" class="px-6 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-100 text-gray-600 font-bold transition">H·ªßy</button>
      <button id="btnSave" onclick="saveData()" class="px-6 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-lg font-bold transition flex items-center gap-2 transform active:scale-95">
        <i class="fa-solid fa-floppy-disk"></i> L∆∞u ƒê∆°n H√†ng
      </button>
    </div>
  </div>
</div>

<!-- PRINT PREVIEW MODAL -->
<div id="printModal" class="fixed inset-0 bg-white z-50 hidden flex-col md:flex-row overflow-hidden">
    <div id="print-mobile-tabs" class="md:hidden flex border-b border-gray-200 bg-gray-50 shrink-0 no-print">
         <button onclick="switchPrintTab('editor')" id="ptab-editor" class="flex-1 py-3 text-sm font-bold text-indigo-700 border-b-2 border-indigo-700 bg-white transition-colors">Nh·∫≠p Li·ªáu</button>
         <button onclick="switchPrintTab('preview')" id="ptab-preview" class="flex-1 py-3 text-sm text-gray-500 font-medium hover:bg-gray-100 transition-colors">Xem Phi·∫øu</button>
         <button onclick="closePrintModal()" class="px-4 text-red-500 hover:bg-red-50"><i class="fa-solid fa-times text-lg"></i></button>
    </div>

    <div id="print-editor" class="w-full md:w-1/3 bg-gray-50 border-r border-gray-200 p-5 h-full overflow-y-auto no-print md:block custom-scrollbar">
        <div class="hidden md:flex justify-between items-center mb-6 border-b pb-3">
            <h3 class="font-bold text-indigo-800 uppercase flex items-center gap-2"><i class="fa-solid fa-print"></i> So·∫°n Phi·∫øu In</h3>
            <button onclick="closePrintModal()" class="text-gray-400 hover:text-red-500 w-8 h-8 rounded-full hover:bg-gray-100 transition flex items-center justify-center text-xl">&times;</button>
        </div>
        
        <div class="space-y-4 text-sm">
            <div class="space-y-2">
                <p class="font-bold text-indigo-600 border-b border-indigo-100 pb-1 text-xs uppercase">1. Th√¥ng tin kh√°ch h√†ng</p>
                <input type="text" id="print_custName" class="w-full border p-2 rounded-lg font-bold" placeholder="H·ªç t√™n kh√°ch" oninput="updatePrintPreview()">
                <input type="text" id="print_custPhone" class="w-full border p-2 rounded-lg" placeholder="S·ªë ƒëi·ªán tho·∫°i" oninput="updatePrintPreview()">
                <input type="text" id="print_custAddr" class="w-full border p-2 rounded-lg" placeholder="ƒê·ªãa ch·ªâ" oninput="updatePrintPreview()">
                <input type="text" id="print_custCCCD" class="w-full border p-2 rounded-lg" placeholder="CCCD" oninput="updatePrintPreview()">
            </div>
            
            <div class="space-y-2">
                <p class="font-bold text-green-600 border-b border-green-100 pb-1 text-xs uppercase">2. Th√¥ng tin s·∫£n ph·∫©m</p>
                <input type="text" id="print_prodType" class="w-full border p-2 rounded-lg font-bold" placeholder="Lo·∫°i (VD: iPad)" oninput="updatePrintPreview()">
                <input type="text" id="print_prodModel" class="w-full border p-2 rounded-lg" placeholder="Model (VD: Air 4 64G)" oninput="updatePrintPreview()">
                <input type="text" id="print_prodIMEI" class="w-full border p-2 rounded-lg font-mono uppercase font-bold text-gray-700" placeholder="IMEI/Seri" oninput="updatePrintPreview()">
                <input type="text" id="print_prodAcc" class="w-full border p-2 rounded-lg" placeholder="Ph·ª• ki·ªán k√®m theo" oninput="updatePrintPreview()">
                <input type="text" id="print_prodCond" class="w-full border p-2 rounded-lg" placeholder="T√¨nh tr·∫°ng" oninput="updatePrintPreview()">
            </div>
            
            <div class="space-y-2">
                <p class="font-bold text-orange-600 border-b border-orange-100 pb-1 text-xs uppercase">3. B·∫£o h√†nh & Qu√† t·∫∑ng</p>
                <!-- NEW BAO TEST FIELD -->
                <input type="text" id="print_baotest" class="w-full border p-2 rounded-lg" placeholder="Th·ªùi gian Bao Test (VD: 7 Ng√†y)" oninput="updatePrintPreview()">
                
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="print_warRepair" class="w-full border p-2 rounded-lg col-span-2" placeholder="Th·ªùi h·∫°n B·∫£o H√†nh (VD: 6 Th√°ng)" oninput="updatePrintPreview()">
                </div>
                <input type="text" id="print_warBattery" class="w-full border p-2 rounded-lg" placeholder="BH Pin" oninput="updatePrintPreview()">
                <input type="text" id="print_gift" class="w-full border p-2 rounded-lg" placeholder="Qu√† t·∫∑ng" oninput="updatePrintPreview()">
            </div>
            
            <div class="border p-3 rounded-lg bg-white mt-2 shadow-sm">
                <p class="font-bold mb-2 text-xs uppercase text-gray-500">Check List L·ªói:</p>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="chk_lung" class="mr-2 accent-indigo-600" onchange="updatePrintPreview()"> Thay L∆∞ng</label>
                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="chk_suon" class="mr-2 accent-indigo-600" onchange="updatePrintPreview()"> Thay Khung</label>
                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="chk_epkinh" class="mr-2 accent-indigo-600" onchange="updatePrintPreview()"> √âp K√≠nh</label>
                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="chk_manzin" class="mr-2 accent-indigo-600" onchange="updatePrintPreview()"> M√†n Zin</label>
                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="chk_manlk" class="mr-2 accent-indigo-600" onchange="updatePrintPreview()"> M√†n LK</label>
                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="chk_pinzin" class="mr-2 accent-indigo-600" onchange="updatePrintPreview()"> Pin Zin</label>
                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="chk_pinchu" class="mr-2 accent-indigo-600" onchange="updatePrintPreview()"> Pin Chu·∫©n</label>
                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="chk_pincao" class="mr-2 accent-indigo-600" onchange="updatePrintPreview()"> Pin Cao</label>
                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="chk_camtr" class="mr-2 accent-indigo-600" onchange="updatePrintPreview()"> Thay Cam Tr</label>
                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="chk_camsau" class="mr-2 accent-indigo-600" onchange="updatePrintPreview()"> Thay Cam Sau</label>
                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="chk_main" class="mr-2 accent-indigo-600" onchange="updatePrintPreview()"> S·ª≠a Main</label>
                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" id="chk_cloud" class="mr-2 accent-indigo-600" checked onchange="updatePrintPreview()"> iCloud OK</label>
                </div>
            </div>
            <textarea id="print_notes" class="w-full border p-2 rounded-lg mt-2 text-sm" rows="2" placeholder="Ghi ch√∫ in..." oninput="updatePrintPreview()"></textarea>
        </div>
        
        <button onclick="window.print()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 mt-6 rounded-lg shadow-lg flex items-center justify-center gap-2 transition active:scale-95">
            <i class="fa-solid fa-print"></i> IN PHI·∫æU NGAY
        </button>
    </div>

    <div id="print-preview" class="w-full md:w-2/3 bg-gray-200 p-4 md:p-8 overflow-auto h-full hidden md:flex justify-center items-start custom-scrollbar">
        <div id="preview-wrapper" class="bg-white shadow-2xl origin-top transition-transform duration-300">
            <!-- PAGE 1 -->
            <div class="page-container">
                <div class="warranty-card text-black relative h-full">
                    <div class="mb-8">
                        <div class="flex justify-between items-start border-b-2 border-green-700 pb-2 mb-4">
                            <div><h1 class="text-4xl font-black text-green-700 tracking-wider">POLY Store</h1></div>
                            <div class="text-right text-sm">
                                <p>ƒê/c: 170/4/2 B√πi ƒê√¨nh T√∫y, P.12, Q. B√¨nh Th·∫°nh, TP. HCM</p>
                                <p class="font-bold text-green-800">Hotline: 0902.96.0804</p>
                            </div>
                        </div>
                        <div class="text-center">
                            <h1 class="text-3xl font-bold uppercase text-green-700 underline decoration-2 underline-offset-4">PHI·∫æU B·∫¢O H√ÄNH</h1>
                            <p class="italic text-sm">(Ki√™m bi√™n nh·∫≠n)</p>
                        </div>
                    </div>

                    <div class="section-title text-green-800">1. TH√îNG TIN KH√ÅCH H√ÄNG</div>
                    <div class="flex items-baseline mb-1"><span class="w-24 shrink-0 font-bold">H·ªç v√† t√™n:</span><div class="dotted-line"><span class="input-value uppercase" id="prev_custName"></span></div></div>
                    <div class="flex items-baseline mb-1"><span class="w-24 shrink-0 font-bold">S·ªë ƒëi·ªán tho·∫°i:</span><div class="dotted-line"><span class="input-value" id="prev_custPhone"></span></div></div>
                    <div class="flex items-baseline mb-1"><span class="w-24 shrink-0 font-bold">ƒê·ªãa ch·ªâ:</span><div class="dotted-line"><span class="input-value" id="prev_custAddr"></span></div></div>
                    <div class="flex items-baseline mb-1"><span class="w-24 shrink-0 font-bold">S·ªë CCCD:</span><div class="dotted-line"><span class="input-value" id="prev_custCCCD"></span></div></div>

                    <div class="section-title text-green-800">2. TH√îNG TIN S·∫¢N PH·∫®M</div>
                    <div class="flex items-baseline mb-1"><span class="w-40 shrink-0 font-bold">Lo·∫°i s·∫£n ph·∫©m:</span><div class="dotted-line"><span class="input-value" id="prev_prodType"></span></div></div>
                    <div class="flex items-baseline mb-1"><span class="w-40 shrink-0 font-bold">Model/M√†u:</span><div class="dotted-line"><span class="input-value" id="prev_prodModel"></span></div></div>
                    <div class="flex items-baseline mb-1"><span class="w-40 shrink-0 font-bold">S·ªë IMEI/SN:</span><div class="dotted-line"><span class="input-value font-bold" id="prev_prodIMEI"></span></div></div>
                    <div class="flex items-baseline mb-1"><span class="w-40 shrink-0 font-bold">Ph·ª• ki·ªán k√®m theo:</span><div class="dotted-line"><span class="input-value" id="prev_prodAcc"></span></div></div>
                    <div class="flex items-baseline mb-1"><span class="w-40 shrink-0 font-bold">T√¨nh tr·∫°ng khi nh·∫≠n:</span><div class="dotted-line"><span class="input-value" id="prev_prodCond"></span></div></div>

                    <div class="section-title text-green-800">3. CH√çNH S√ÅCH B·∫¢O H√ÄNH</div>
                    <!-- NEW BAO TEST LINE -->
                    <div class="flex items-baseline mb-1">
                        <span class="shrink-0 mr-2 font-bold">Th·ªùi gian bao test:</span>
                        <div class="dotted-line"><span class="input-value" id="prev_baotest"></span></div>
                    </div>
                    
                    <div class="flex items-baseline mb-1">
                        <span class="shrink-0 mr-2 font-bold">Th·ªùi h·∫°n b·∫£o h√†nh:</span>
                        <span class="mr-1 font-bold">(‚úì) 1 ƒë·ªïi 1</span>
                        <span class="mx-2"></span>
                        <span class="mr-1 font-bold">(‚úì) S·ª≠a ch·ªØa</span><div class="dotted-line grow"><span class="input-value" id="prev_warRepair"></span></div>
                    </div>
                    <div class="flex items-baseline mb-1"><span class="shrink-0 mr-2 font-bold">Th·ªùi h·∫°n b·∫£o h√†nh PIN :</span><div class="dotted-line"><span class="input-value" id="prev_warBattery"></span></div></div>
                    <div class="flex items-baseline mb-3"><span class="shrink-0 mr-2 font-bold">Lo·∫°i ph·ª• ki·ªán t·∫∑ng :</span><div class="dotted-line"><span class="input-value" id="prev_gift"></span></div></div>
                    
                    <div class="font-bold mb-2 underline text-green-800">ƒê·ªß ƒëi·ªÅu ki·ªán b·∫£o h√†nh khi s·∫£n ph·∫©m kh√¥ng b·ªã c√°c l·ªói nh∆∞ sau:</div>
                    <div class="text-sm space-y-1">
                        <p class="policy-text">- S·∫£n ph·∫©m va ƒë·∫≠p, c·∫•n m√≥p ho·∫∑c c√≥ d·∫•u hi·ªáu t√°c ƒë·ªông v·∫≠t l√Ω</p>
                        <p class="policy-text">- S·∫£n ph·∫©m b·ªã ch√°y n·ªï, ch·∫≠p v·ªâ, ch√¢n s·∫°c ch√°y</p>
                        <p class="policy-text">- S·∫£n ph·∫©m b·ªã v√†o n∆∞·ªõc, ·∫©m n∆∞·ªõc, vi·ªÅn s√©t ƒë·ªè</p>
                        <p class="policy-text">- C√°c l·ªói ph·∫ßn m·ªÅm b√™n th·ª© 3</p>
                        <p class="policy-text">- Kh√°ch h√†ng qu√™n t√†i kho·∫£n iCloud</p>
                        <p class="policy-text">- M√†n h√¨nh b·ªã s·ªçc, ƒë·ªëm ƒëen, v√†ng, tr·∫Øng</p>
                        <p class="policy-text">- Kh√¥ng c√≤n tem b·∫£o h√†nh.</p>
                    </div>

                    <div class="section-title text-green-800">4. CAM K·∫æT</div>
                    <p class="mb-1 text-sm">- Ho√†n ti·ªÅn 100% n·∫øu kh√¥ng ƒë√∫ng cam k·∫øt.</p>
                    <p class="mb-8 text-sm italic text-gray-500">(Vui l√≤ng ki·ªÉm tra chi ti·∫øt linh ki·ªán v√† k√Ω x√°c nh·∫≠n ·ªü trang sau)</p>
                </div>
            </div>
            
            <!-- PAGE 2 -->
            <div class="page-container mt-4">
                <div class="warranty-card text-black relative h-full">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold uppercase underline decoration-2 underline-offset-4">CAM K·∫æT CH·∫§T L∆Ø·ª¢NG S·∫¢N PH·∫®M</h2>
                    </div>
                    <div class="flex justify-end mb-4 font-bold text-sm border-b pb-2">
                        <span class="mr-6 text-red-600">(‚úì) = ƒê√£ thay</span><span class="text-green-700">(‚úó) = Nguy√™n b·∫£n</span>
                    </div>
                    <div class="flex items-baseline mb-6">
                        <span class="w-32 shrink-0 font-bold">IMEI / SERIAL :</span><div class="dotted-line"><span class="input-value font-bold text-lg" id="prev_page2IMEI"></span></div>
                    </div>

                    <div class="space-y-3 text-base">
                        <div>
                            <div class="font-bold uppercase text-sm border-b border-gray-300 mb-2">Ngo·∫°i h√¨nh ‚Äì Khung ‚Äì L∆∞ng</div>
                            <div class="flex justify-between pl-4"><span>- Thay m·∫∑t l∆∞ng</span><span class="tech-check" id="v_lung"></span></div>
                            <div class="flex justify-between pl-4"><span>- Thay khung / s∆∞·ªùn</span><span class="tech-check" id="v_suon"></span></div>
                        </div>
                        <div>
                            <div class="font-bold uppercase text-sm border-b border-gray-300 mb-2 mt-2">M√†n h√¨nh</div>
                            <div class="flex justify-between pl-4"><span>- ƒê√£ qua √©p k√≠nh</span><span class="tech-check" id="v_epkinh"></span></div>
                            <div class="flex justify-between pl-4"><span>- Thay m√†n h√¨nh zin</span><span class="tech-check" id="v_manzin"></span></div>
                            <div class="flex justify-between pl-4"><span>- Thay m√†n linh ki·ªán</span><span class="tech-check" id="v_manlk"></span></div>
                        </div>
                        <div>
                            <div class="font-bold uppercase text-sm border-b border-gray-300 mb-2 mt-2">Pin</div>
                            <div class="flex justify-between pl-4"><span>- Pin zin theo m√°y</span><span class="tech-check" id="v_pinzin"></span></div>
                            <div class="flex justify-between pl-4"><span>- Thay pin chu·∫©n</span><span class="tech-check" id="v_pinchu"></span></div>
                            <div class="flex justify-between pl-4"><span>- Thay pin cao</span><span class="tech-check" id="v_pincao"></span></div>
                        </div>
                        <div>
                            <div class="font-bold uppercase text-sm border-b border-gray-300 mb-2 mt-2">Mainboard ‚Äì Ch·ª©c nƒÉng</div>
                            <div class="flex justify-between pl-4"><span>- Main ƒë√£ qua s·ª≠a ch·ªØa</span><span class="tech-check" id="v_main"></span></div>
                            <div class="flex justify-between pl-4"><span>- iCloud OK</span><span class="tech-check" id="v_cloud"></span></div>
                        </div>
                        <div class="mt-4">
                            <div class="dotted-line w-full mb-6 relative"><span class="input-value" id="prev_notes" style="top:-5px; font-weight:normal;"></span></div>
                            <div class="dotted-line w-full mb-6"></div>
                        </div>
                    </div>

                    <div class="flex justify-end mt-4 px-12 text-center">
                        <div class="flex flex-col items-center">
                            <p class="italic text-sm mb-1" id="prev_date"></p>
                            <p class="font-bold">Kh√°ch h√†ng x√°c nh·∫≠n</p>
                            <p class="text-xs italic mb-24">(ƒê√£ nghe t∆∞ v·∫•n & ƒë·ªìng √Ω)</p>
                            <p class="font-bold uppercase text-lg" id="prev_signName"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ACTION SHEET (MENU 3 CH·∫§M) -->
<div id="actionSheet" class="fixed inset-0 bg-black/60 z-50 flex items-end justify-center hidden no-print" onclick="closeActionMenu()">
    <div class="bg-white w-full max-w-md rounded-t-2xl shadow-2xl overflow-hidden transform translate-y-full transition-transform duration-200" id="mas_content" onclick="event.stopPropagation()">
        <div class="bg-gray-100 p-4 text-center border-b font-bold text-gray-700 truncate" id="mas_title">T√™n M√°y</div>
        <input type="hidden" id="mas_seri">
        <div class="p-4 space-y-3">
             <button onclick="triggerAction('copy')" class="w-full py-3 bg-indigo-50 text-indigo-700 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-indigo-100 active:scale-95 transition"><i class="fa-regular fa-copy text-xl"></i> Copy B√°o C√°o</button>
             <button onclick="triggerAction('print')" class="w-full py-3 bg-green-50 text-green-700 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-green-100 active:scale-95 transition"><i class="fa-solid fa-print text-xl"></i> In Phi·∫øu B·∫£o H√†nh</button>
             <button onclick="triggerAction('edit')" class="w-full py-3 bg-blue-50 text-blue-700 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-blue-100 active:scale-95 transition"><i class="fa-solid fa-pen text-xl"></i> S·ª≠a ƒê∆°n H√†ng</button>
             <!-- B·ªé N√öT X√ìA ƒê∆†N H√ÄNG -->
        </div>
        <div class="p-4 border-t bg-white">
            <button onclick="closeActionMenu()" class="w-full py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition">H·ªßy B·ªè</button>
        </div>
    </div>
</div>

<script>
// ================= CONFIG =================
const API_URL = 'https://script.google.com/macros/s/AKfycbxWoqnSMsi-2gNiA_lGlqDkuYEnv7kqoFvkkVY7DY-JIHPuROYwfdobCJ6kX8SHZk1_Jg/exec'; 
// ==========================================

let allData = [];
let isEditing = false;
const qs = (s) => document.querySelector(s);
const getVal = (id) => document.getElementById(id).value;
const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
const formatMoney = (n) => n ? Number(String(n).replace(/\D/g, '')).toLocaleString('vi-VN') : '0';
const formatCurrencyInput = (input) => { let value = input.value.replace(/\D/g, ''); input.value = value ? Number(value).toLocaleString('vi-VN') : ''; };
const convertToISO = (d) => { if(!d) return ''; const m = d.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); return m ? `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}` : d; };
const formatDateForDisplay = (d) => { if(!d) return ''; const m = d.match(/^(\d{4})-(\d{2})-(\d{2})$/); return m ? `${m[3]}/${m[2]}/${m[1]}` : d; };
const formatDateToInput = (d) => { let m = ''+(d.getMonth()+1), dy = ''+d.getDate(), y = d.getFullYear(); if(m.length<2) m='0'+m; if(dy.length<2) dy='0'+dy; return [y,m,dy].join('-'); };

// --- SALE SELECT INIT ---
function initSaleSelect(targetValue) {
    const sel = qs('#inp_sale');
    sel.innerHTML = '';
    const nv = localStorage.getItem("NV_TEN") || "";
    
    // Create options: NV and SHOP
    const opts = new Set();
    if(nv) opts.add(nv);
    opts.add("SHOP");
    
    // If editing and value exists (even if old employee), add it to list
    if(targetValue) opts.add(targetValue); 

    opts.forEach(v => {
        const el = document.createElement('option');
        el.value = v; el.innerText = v;
        sel.appendChild(el);
    });
    
    // Set selected
    if(targetValue && opts.has(targetValue)) sel.value = targetValue;
    else if(nv) sel.value = nv;
}

// --- DATE FILTERS (UPDATED LOGIC) ---
function initDateFilters() {
    // Initial load: Set filter to THIS_MONTH
    const filterSelect = qs('#filterTime');
    if (filterSelect) filterSelect.value = 'THIS_MONTH';
}

function loadMoreMonth() {
    // Deprecated function, but keeping structure if referenced elsewhere, 
    // now we rely on filterTime select change
    filterData();
}

// --- API ---
async function fetchData(bodyData = null) {
    try {
        const options = { 
          method: bodyData ? 'POST' : 'GET', 
          headers: bodyData ? { "Content-Type": "text/plain;charset=utf-8" } : undefined, 
          body: bodyData ? JSON.stringify(bodyData) : undefined 
        };
        const res = await fetch(API_URL, options);
        return await res.json();
    } catch (e) {
        if(!bodyData) alert("L·ªói k·∫øt n·ªëi: " + e.message);
        return null;
    }
}

// --- LOOKUPS ---
async function lookupProduct() {
    const seri = getVal('inp_seri').trim();
    if(!seri) return;
    qs('#inp_seri').classList.add('input-loading');
    const res = await fetchData({ action: 'lookup_product', SERI: seri });
    qs('#inp_seri').classList.remove('input-loading');
    if(res && res.success) {
        const d = res.data;
        setVal('inp_name', d.NAME); setVal('inp_dl', d.DL); setVal('inp_color', d.COLOR); setVal('inp_sim', d.SIM);
        setVal('inp_tt', d.TINHTRANG); setVal('inp_pin', d.PIN); setVal('inp_giaban', formatMoney(d.GIABAN)); 
        setVal('inp_gianhap', formatMoney(d.GIANHAP)); if(d.GHICHU) setVal('inp_ghichu', d.GHICHU);
    } else { setVal('inp_name', ''); alert("Kh√¥ng t√¨m th·∫•y Seri trong kho!"); }
}

async function lookupCustomer() {
    const sdt = getVal('inp_sdt').trim();
    if(!sdt) { qs('#cust_name_display').value = ''; return; }
    qs('#inp_sdt').classList.add('input-loading');
    const res = await fetchData({ action: 'lookup_customer', SDT: sdt });
    qs('#inp_sdt').classList.remove('input-loading');
    if(res && res.success) qs('#cust_name_display').value = res.data.TEN;
    else qs('#cust_name_display').value = "Kh√°ch h√†ng m·ªõi (C·∫ßn t·∫°o tr∆∞·ªõc)";
}

// --- CORE ---
async function loadData() {
    qs('#loading').classList.remove('hidden'); 
    initDateFilters(); 
    const data = await fetchData();
    if(data) { allData = data; filterData(); }
    qs('#loading').classList.add('hidden'); 
}

function filterData() {
    const k = qs('#searchInput').value.toLowerCase();
    const typeVal = qs('#filterCategory').value; // Get select value
    const timeVal = qs('#filterTime').value; // Get time filter

    // --- DATE FILTER LOGIC ---
    const now = new Date();
    let fromDate, toDate;

    if (timeVal === 'THIS_MONTH') {
        // Start: First day of current month
        fromDate = new Date(now.getFullYear(), now.getMonth(), 1);
        // End: Last day of current month (effectively covers up to now)
        toDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    } else { // LAST_MONTH
        // Start: First day of previous month
        fromDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        // End: Last day of previous month
        toDate = new Date(now.getFullYear(), now.getMonth(), 0);
    }
    
    // Convert to YYYY-MM-DD strings for comparison
    // Use local time conversion to avoid timezone offsets messing up the date
    const fromStr = formatDateToInput(fromDate);
    const toStr = formatDateToInput(toDate);

    const currentUser = localStorage.getItem("NV_TEN") || ""; 

    let totalRev = 0;
    let totalProf = 0;
    let countSeri = 0;

    const filtered = allData.filter(r => {
        // Sale filter
        if (currentUser) {
             const rowSale = (r.SALE || "").trim().toLowerCase();
             const loginSale = currentUser.trim().toLowerCase();
             if (rowSale !== loginSale) return false;
        }

        // Type Filter logic (Modified logic)
        const seriStr = (r.SERI || '').toString().toUpperCase();
        const isAccessory = seriStr.startsWith('PK');
        
        if (typeVal === 'MACHINE') {
            if (isAccessory || !seriStr) return false; // Hide if PK or no seri
        } else if (typeVal === 'ACCESSORY') {
            if (!isAccessory) return false; // Hide if NOT PK
        }

        // Text & Date filter
        const textMatch = (r.SERI||'').toLowerCase().includes(k) || (r.NAME||'').toLowerCase().includes(k) || (r.SDTKHACH && r.SDTKHACH.includes(k));
        let dateMatch = false; 
        
        if (r.DATE) {
            const rDateISO = convertToISO(r.DATE);
            // Check if within range
            if (rDateISO >= fromStr && rDateISO <= toStr) {
                dateMatch = true;
            }
        }
        
        return textMatch && dateMatch;
    });

    filtered.forEach(r => {
        const sell = Number(r.GIABAN) || 0;
        const buy = Number(r.GIANHAP) || 0;
        totalRev += sell;
        totalProf += (sell - buy);

        if (r.SERI && !r.SERI.toString().toUpperCase().startsWith('PK')) {
            countSeri++;
        }
    });

    qs('#totalRevenue').innerText = formatMoney(totalRev) + ' ‚Ç´';
    qs('#totalProfit').innerText = formatMoney(totalProf) + ' ‚Ç´';
    qs('#totalCount').innerText = filtered.length;
    qs('#totalSeriCount').innerText = countSeri;

    renderTable(filtered);
}

function renderTable(data) {
    const tbody = qs('#tableBody');
    tbody.innerHTML = '';
    if(data.length === 0) { tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-400 italic">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`; return; }

    data.forEach((row, i) => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-indigo-50 border-b border-gray-100 transition-colors group bg-white";
        let dateDisplay = formatDateForDisplay(row.DATE); 
        let productDetails = [row.DL, row.COLOR, row.SIM].filter(Boolean).join(' | ');
        let statusDetails = [row.TINHTRANG, row.PIN ? `Pin ${row.PIN}%` : ''].filter(Boolean).join(' - ');

        const mobileView = `
            <div class="md:hidden mt-2 space-y-1">
                <div class="flex items-center gap-2 text-xs font-mono text-gray-500">
                    <span class="bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200">${dateDisplay}</span>
                    <span class="select-all text-indigo-600 font-bold">${row.SERI}</span>
                </div>
                <div class="text-sm font-bold text-gray-800">${row.NAME}</div>
                <div class="flex flex-wrap gap-2 text-xs text-gray-600">
                    ${productDetails ? `<span class="bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded">${productDetails}</span>` : ''}
                </div>
                <div class="flex justify-between items-center pt-2 mt-2 border-t border-gray-100">
                    <div class="font-bold text-red-600 font-mono">${formatMoney(row.GIABAN)}</div>
                    <div class="text-xs text-gray-500">${row.SDTKHACH || 'Kh√°ch l·∫ª'}</div>
                </div>
                <div class="text-xs text-green-600 font-bold mt-1 text-right">BH: ${row.BAOHANH || '-'} <span class="text-blue-700 ml-1">(${row.BAOTEST || '-'})</span></div>
            </div>
        `;

        // FIXED: Only pass ID to onclick to avoid special char issues (e.g. 12.9' M1)
        tr.innerHTML = `
            <td class="p-4 text-center text-gray-400 text-xs hidden md:table-cell">${i + 1}</td>
            <td class="p-4 align-top w-28 text-center font-mono text-gray-600 text-xs hidden md:table-cell">${dateDisplay}</td>
            
            <td class="p-4 align-top whitespace-normal">
                <div class="hidden md:block">
                    <div class="flex items-center justify-between mb-1">
                        <div class="font-bold text-gray-800 text-sm">${row.NAME}</div>
                        <div class="font-mono text-xs text-indigo-600 font-bold cursor-pointer select-all">${row.SERI}</div>
                    </div>
                    <div class="flex gap-2 text-xs text-gray-500">
                         ${productDetails ? `<span class="bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200">${productDetails}</span>` : ''}
                         ${statusDetails ? `<span class="bg-green-50 text-green-700 px-1.5 py-0.5 rounded border border-green-100">${statusDetails}</span>` : ''}
                    </div>
                    ${row.GHICHU ? `<div class="text-xs text-gray-400 italic mt-1 truncate max-w-[250px]"><i class="fa-regular fa-note-sticky mr-1"></i>${row.GHICHU}</div>` : ''}
                </div>
                ${mobileView}
            </td>
            
            <td class="p-4 align-top hidden md:table-cell">
                <div class="font-bold text-gray-700 text-sm">${row.SDTKHACH || '-'}</div>
                <div class="text-[10px] text-gray-400 mt-0.5 uppercase">Sale: ${row.SALE || '-'}</div>
            </td>
            
            <td class="p-4 text-center hidden md:table-cell">
                <div class="text-[10px] text-blue-700 font-bold mb-1">${row.BAOTEST || '-'}</div>
                <div class="text-xs font-bold text-green-600">${row.BAOHANH || '-'}</div>
            </td>
            
            <td class="p-4 text-right align-top hidden md:table-cell">
                <div class="font-mono font-bold text-red-600">${formatMoney(row.GIABAN)}</div>
                <div class="text-[10px] bg-indigo-50 text-indigo-700 inline-block px-1.5 py-0.5 rounded border border-indigo-100 mt-1 font-bold">${row.PTTT}</div>
            </td>

            <td class="p-4 text-center align-middle sticky right-0 z-10 bg-white group-hover:bg-indigo-50 shadow-left">
                <button onclick="openActionMenu('${row.SERI}')" class="text-gray-400 hover:text-indigo-600 p-2 rounded-full hover:bg-indigo-100 transition"><i class="fa-solid fa-ellipsis-vertical text-lg"></i></button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// === ACTION SHEET LOGIC ===
function openActionMenu(seri) {
    // FIX: Retrieve item by seri to get name safely
    const item = allData.find(r => r.SERI == seri);
    const name = item ? item.NAME : '';
    
    qs('#mas_title').innerText = name;
    qs('#mas_seri').value = seri;
    const sheet = qs('#actionSheet');
    sheet.classList.remove('hidden');
    setTimeout(() => { qs('#mas_content').classList.remove('translate-y-full'); }, 10);
}

function closeActionMenu() {
    qs('#mas_content').classList.add('translate-y-full');
    setTimeout(() => { qs('#actionSheet').classList.add('hidden'); }, 200);
}

function triggerAction(type) {
    const seri = qs('#mas_seri').value;
    closeActionMenu();
    setTimeout(() => {
        if(type === 'copy') copyOrderReport(seri);
        if(type === 'print') printWarranty(seri);
        if(type === 'edit') openEdit(seri);
        if(type === 'delete') deleteRow(seri);
    }, 200);
}

function openModal(mode) {
    qs('#modal').classList.remove('hidden'); 
    setTimeout(() => { qs('#modal').classList.remove('modal-hide'); qs('#modal').classList.add('modal-open'); }, 10);
    if(mode === 'add') {
        isEditing = false; qs('#modalTitle').innerHTML = '<i class="fa-solid fa-file-circle-plus"></i> T·∫°o ƒê∆°n H√†ng M·ªõi';
        setVal('seri_key', ''); setVal('inp_date', new Date().toISOString().split('T')[0]);
        setVal('inp_seri', ''); setVal('inp_name', ''); setVal('inp_dl', '');
        setVal('inp_color', ''); setVal('inp_sim', ''); setVal('inp_tt', '');
        setVal('inp_pin', ''); setVal('inp_ghichu', ''); setVal('inp_giaban', ''); setVal('inp_gianhap', '');
        setVal('inp_baotest', ''); setVal('inp_baohanh', ''); setVal('inp_sdt', ''); setVal('inp_pttt', 'CK');
        qs('#cust_name_display').value = '';
        
        // Auto-fill Sale Name with Select
        initSaleSelect(localStorage.getItem("NV_TEN"));
    }
}

function openEdit(seri) {
    const item = allData.find(r => r.SERI == seri);
    if(!item) return;
    openModal(); isEditing = true; qs('#modalTitle').innerHTML = '<i class="fa-solid fa-pen-to-square"></i> S·ª≠a ƒê∆°n H√†ng';
    setVal('seri_key', item.SERI); setVal('inp_date', convertToISO(item.DATE));
    setVal('inp_seri', item.SERI); setVal('inp_name', item.NAME); setVal('inp_dl', item.DL);
    setVal('inp_color', item.COLOR); setVal('inp_sim', item.SIM); setVal('inp_tt', item.TINHTRANG);
    setVal('inp_pin', item.PIN); setVal('inp_ghichu', item.GHICHU);
    setVal('inp_giaban', formatMoney(item.GIABAN)); setVal('inp_gianhap', formatMoney(item.GIANHAP));
    setVal('inp_baotest', item.BAOTEST); setVal('inp_baohanh', item.BAOHANH);
    // setVal('inp_sale', item.SALE); -> Removed
    setVal('inp_sdt', item.SDTKHACH ? item.SDTKHACH.replace(/'/g, '') : '');
    setVal('inp_pttt', item.PTTT);
    
    // Set Sale Select for Edit
    initSaleSelect(item.SALE);
    
    lookupCustomer();
}

function closeModal() { 
    qs('#modal').classList.remove('modal-open'); qs('#modal').classList.add('modal-hide');
    setTimeout(() => qs('#modal').classList.add('hidden'), 200);
}

async function saveData() {
    const btn = qs('#btnSave');
    const seri = getVal('inp_seri').trim();
    const sdtRaw = getVal('inp_sdt').trim();
    if(!seri || !sdtRaw) return alert("Vui l√≤ng nh·∫≠p Seri v√† SƒêT!");
    
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang l∆∞u...'; btn.disabled = true;

    const item = {
        DATE: getVal('inp_date'), SERI: seri, NAME: getVal('inp_name'), DL: getVal('inp_dl'),
        COLOR: getVal('inp_color'), SIM: getVal('inp_sim'), TINHTRANG: getVal('inp_tt'), PIN: getVal('inp_pin'),
        GHICHU: getVal('inp_ghichu'), GIABAN: getVal('inp_giaban').replace(/\./g, ''), GIANHAP: getVal('inp_gianhap').replace(/\./g, ''),
        BAOTEST: getVal('inp_baotest'), BAOHANH: getVal('inp_baohanh'), SALE: getVal('inp_sale'),
        SDTKHACH: sdtRaw, PTTT: getVal('inp_pttt')
    };

    const body = { action: isEditing ? 'edit' : 'add', ...item, SDTKHACH: "'" + sdtRaw };
    if(isEditing) body.SERI_KEY = getVal('seri_key');

    try {
        const res = await fetchData(body);
        if(res && res.success) {
            closeModal();
            loadData();
            if(!isEditing) printWarranty(seri);
        } else alert("L·ªói: " + (res ? res.message : 'K·∫øt n·ªëi th·∫•t b·∫°i'));
    } catch(e) { alert("L·ªói: " + e.message); }
    finally { btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> L∆∞u ƒê∆°n H√†ng'; btn.disabled = false; }
}

async function deleteRow(seri) {
    if(!confirm("X√≥a h·ªì s∆°: " + seri + "?")) return;
    const res = await fetchData({ action: 'delete', SERI: seri });
    if(res && res.success) loadData();
    else alert("L·ªói x√≥a: " + (res ? res.message : ''));
}

async function printWarranty(seri) {
    const row = allData.find(r => r.SERI === seri);
    if(!row) return;

    qs('#printModal').classList.remove('hidden');
    qs('#printModal').classList.add('flex');
    switchPrintTab('editor');

    setVal('print_prodType', row.NAME);
    setVal('print_prodModel', `${row.DL || ''} ${row.COLOR || ''} ${row.SIM || ''}`.trim());
    setVal('print_prodIMEI', row.SERI);
    setVal('print_prodCond', `${row.TINHTRANG || ''} ${row.PIN ? '- Pin '+row.PIN+'%' : ''}`.trim());
    setVal('print_custPhone', row.SDTKHACH ? row.SDTKHACH.replace(/'/g, '') : '');
    
    // UPDATED MAPPING
    setVal('print_baotest', row.BAOTEST || '');
    setVal('print_warRepair', row.BAOHANH || '');

    if(row.SDTKHACH) {
        const res = await fetchData({ action: 'lookup_customer', SDT: row.SDTKHACH.replace(/'/g, '') });
        if(res && res.success) {
            setVal('print_custName', res.data.TEN || '');
            setVal('print_custAddr', res.data.DIACHI || '');
            setVal('print_custCCCD', res.data.CCCD ? res.data.CCCD.replace(/'/g, '') : '');
        }
    }
    
    const today = new Date();
    document.getElementById('prev_date').innerText = `Ng√†y ${today.getDate()} th√°ng ${today.getMonth() + 1} nƒÉm ${today.getFullYear()}`;
    updatePrintPreview();
}

function updatePrintPreview() {
    const getTxt = (id) => document.getElementById(id).value;
    const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
    const setCheck = (id, targetId) => {
        const checked = document.getElementById(id).checked;
        const el = document.getElementById(targetId);
        if(el) {
            el.innerText = checked ? "(‚úì) ƒê√£ thay" : "(‚úó) Nguy√™n b·∫£n";
            el.className = checked ? "tech-check replaced" : "tech-check original";
        }
    }
    
    setTxt('prev_custName', getTxt('print_custName').toUpperCase());
    setTxt('prev_signName', getTxt('print_custName').toUpperCase());
    setTxt('prev_custPhone', getTxt('print_custPhone'));
    setTxt('prev_custAddr', getTxt('print_custAddr'));
    setTxt('prev_custCCCD', getTxt('print_custCCCD'));
    setTxt('prev_prodType', getTxt('print_prodType'));
    setTxt('prev_prodModel', getTxt('print_prodModel'));
    setTxt('prev_prodIMEI', getTxt('print_prodIMEI'));
    setTxt('prev_page2IMEI', getTxt('print_prodIMEI'));
    setTxt('prev_prodAcc', getTxt('print_prodAcc'));
    setTxt('prev_prodCond', getTxt('print_prodCond'));
    
    setTxt('prev_baotest', getTxt('print_baotest'));
    setTxt('prev_warRepair', getTxt('print_warRepair'));
    
    setTxt('prev_warBattery', getTxt('print_warBattery'));
    setTxt('prev_gift', getTxt('print_gift'));
    setTxt('prev_notes', getTxt('print_notes'));

    setCheck('chk_lung', 'v_lung');
    setCheck('chk_suon', 'v_suon');
    setCheck('chk_epkinh', 'v_epkinh');
    setCheck('chk_manzin', 'v_manzin');
    setCheck('chk_manlk', 'v_manlk');
    setCheck('chk_pinzin', 'v_pinzin');
    setCheck('chk_pinchu', 'v_pinchu');
    setCheck('chk_pincao', 'v_pincao');
    setCheck('chk_camtr', 'v_camtr');
    setCheck('chk_camsau', 'v_camsau');
    setCheck('chk_main', 'v_main');
    
    const cloudEl = document.getElementById('v_cloud');
    if(document.getElementById('chk_cloud').checked) {
        cloudEl.innerText = "(‚úì) OK"; cloudEl.className = "tech-check original";
    } else {
        cloudEl.innerText = "(‚úó) C√≥ iCloud"; cloudEl.className = "tech-check replaced";
    }
}

// --- NEW FUNCTION: Auto Scale Print Preview ---
function autoScalePrintPreview() {
    const wrapper = qs('#preview-wrapper');
    const container = qs('#print-preview');
    if (!wrapper || !container) return;

    // Ch·ªâ scale n·∫øu m√†n h√¨nh nh·ªè (Mobile)
    if (window.innerWidth < 768) {
        // Chi·ªÅu r·ªông g·ªëc c·ªßa A4 (210mm) x·∫•p x·ªâ 800px trong CSS
        const originalWidth = 800; 
        // Tr·ª´ padding c·ªßa container (32px = p-4 * 2)
        const availableWidth = container.offsetWidth - 32; 
        
        const scale = availableWidth / originalWidth;
        // Gi·ªõi h·∫°n scale t·ªëi ƒëa l√† 1
        const finalScale = Math.min(scale, 1);
        
        wrapper.style.transform = `scale(${finalScale})`;
        wrapper.style.transformOrigin = 'top center'; // Ho·∫∑c 'top left' t√πy s·ªü th√≠ch
        
        // ƒêi·ªÅu ch·ªânh chi·ªÅu cao c·ªßa container cha ƒë·ªÉ kh√¥ng b·ªã kho·∫£ng tr·∫Øng th·ª´a qu√° nhi·ªÅu
        // (Optional: N·∫øu c·∫ßn thi·∫øt)
    } else {
        wrapper.style.transform = 'none';
    }
}

async function copyOrderReport(seri) {
    const row = allData.find(r => r.SERI === seri);
    if (!row) return;

    let custName = "Kh√°ch h√†ng", custAddr = "", custCCCD = "";
    if (row.SDTKHACH) {
        const res = await fetchData({ action: 'lookup_customer', SDT: row.SDTKHACH.replace(/'/g, '') });
        if (res && res.success) {
            custName = res.data.TEN || custName;
            custAddr = res.data.DIACHI || "";
            custCCCD = res.data.CCCD ? res.data.CCCD.replace(/'/g, '') : "";
        }
    }

    const today = new Date();
    const dateStr = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;
    const reportText = `*B√ÅO C√ÅO B√ÅN H√ÄNG*\nüìÖ Ng√†y: ${dateStr}\n--------------------------\nüë§ Kh√°ch: ${custName}\nüìû SƒêT: ${row.SDTKHACH ? row.SDTKHACH.replace(/'/g, '') : ''}\nüì± M√°y: ${row.NAME} ${row.DL||''} ${row.COLOR||''}\nüî¢ IMEI: ${row.SERI}\nüõ°Ô∏è B·∫£o h√†nh: ${row.BAOHANH || '-'}`;

    navigator.clipboard.writeText(reportText).then(() => alert("‚úÖ ƒê√£ copy b√°o c√°o!"));
}

function switchPrintTab(tabName) {
    const editor = qs('#print-editor'), preview = qs('#print-preview');
    const bE = qs('#ptab-editor'), bP = qs('#ptab-preview');
    if (tabName === 'editor') {
        editor.classList.remove('hidden'); preview.classList.add('hidden');
        bE.className = "flex-1 py-3 text-sm font-bold text-indigo-700 border-b-2 border-indigo-700 bg-white";
        bP.className = "flex-1 py-3 text-sm text-gray-500 font-medium hover:bg-gray-100";
    } else {
        editor.classList.add('hidden'); preview.classList.remove('hidden'); preview.classList.add('flex');
        bE.className = "flex-1 py-3 text-sm text-gray-500 font-medium hover:bg-gray-100";
        bP.className = "flex-1 py-3 text-sm font-bold text-indigo-700 border-b-2 border-indigo-700 bg-white";
        
        // Trigger auto scale immediately after showing
        setTimeout(autoScalePrintPreview, 50);
    }
}

function closePrintModal() { qs('#printModal').classList.add('hidden'); qs('#printModal').classList.remove('flex'); }

// Listen for resize
window.addEventListener('resize', autoScalePrintPreview);

loadData();
</script>
</body>
</html>