<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Qu·∫£n L√Ω ƒê∆°n H√†ng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
  <!-- Font cho phi·∫øu in -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Times+New+Roman:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    /* Base Settings */
    :root { --primary: #4f46e5; }
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    /* Utility Classes */
    .font-mono { font-family: 'Roboto Mono', monospace; }
    .modal-open { opacity: 1; transform: scale(1); pointer-events: auto; }
    .modal-hide { opacity: 0; transform: scale(0.95); pointer-events: none; }
    
    /* Responsive Helpers */
    .desktop-row { display: none; }
    .mobile-card { display: block; }
    .desktop-cell { display: none; }
    
    @media (min-width: 1024px) { 
        .desktop-row { display: table-row; }
        .mobile-card { display: none; }
        .desktop-cell { display: table-cell; }
    }

    /* Sticky Columns Shadow */
    .sticky-right { position: sticky; right: 0; z-index: 20; }
    .shadow-left { box-shadow: -4px 0 8px -2px rgba(0,0,0,0.1); }

    /* Print Styles */
    @media print {
        body * { visibility: hidden; }
        #printModal, #printModal * { visibility: visible; }
        #printModal { position: absolute; left: 0; top: 0; width: 100%; height: auto; background: white; z-index: 9999; display: block !important; }
        #print-editor, #print-mobile-tabs, .no-print { display: none !important; }
        #print-preview { display: block !important; width: 100% !important; height: auto !important; overflow: visible !important; padding: 0 !important; margin: 0 !important; }
        #preview-wrapper { transform: none !important; box-shadow: none !important; margin: 0 !important; width: 100% !important; }
        .page-container { width: 100% !important; height: auto !important; min-height: 290mm; margin: 0 !important; padding: 0 !important; border: none !important; display: block !important; page-break-after: always !important; break-after: page; }
        .page-container:last-child { page-break-after: auto !important; break-after: auto; }
        .warranty-card { padding: 10mm 15mm !important; height: 100% !important; }
        * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    }
    
    /* A4 Paper Preview */
    .page-container { width: 210mm; height: 296mm; background: white; margin: 0 auto 20px; padding: 0; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); box-sizing: border-box; overflow: hidden; position: relative; }
    .warranty-card { font-family: 'Times New Roman', serif; width: 100%; height: 100%; padding: 10mm 15mm; font-size: 11pt; color: #000; line-height: 1.4; position: relative; box-sizing: border-box; }
    .dotted-line { border-bottom: 1px dotted #000; flex-grow: 1; margin-left: 5px; position: relative; height: 1.4em; display: inline-block; }
    .input-value { position: absolute; bottom: 2px; left: 0; font-weight: bold; font-family: 'Roboto', sans-serif; white-space: nowrap; width: 100%; }
    .tech-check { font-weight: bold; margin-left: 10px; }
    .tech-check.replaced { color: #dc2626; } 
    .tech-check.original { color: #166534; }
    .section-title { font-weight: bold; text-transform: uppercase; font-size: 12pt; margin-top: 15px; margin-bottom: 8px; text-decoration: underline; }
    .policy-text { text-align: justify; margin-bottom: 6px; line-height: 1.3; font-size: 10.5pt; }

    /* Gift Tag Styles */
    .gift-tag { display: inline-flex; align-items: center; background: #fff7ed; border: 1px solid #ffedd5; color: #c2410c; padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: bold; margin-right: 4px; margin-bottom: 4px; }
    .gift-tag button { margin-left: 4px; color: #ea580c; cursor: pointer; }
    .gift-tag button:hover { color: #9a3412; }
  </style>
</head>
<body class="min-h-screen text-sm text-gray-800 bg-gray-50">

<div class="p-2 md:p-6 w-full max-w-[1600px] mx-auto pb-24 no-print">
  
  <!-- DASHBOARD STATS & HEADER -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
      <div class="md:col-span-4 lg:col-span-1 flex flex-col justify-center mb-2 md:mb-0">
          <h1 class="text-xl md:text-2xl font-bold text-indigo-700 flex items-center gap-2">
            <span class="bg-indigo-100 p-2 rounded-lg"><i class="fa-solid fa-file-invoice-dollar"></i></span>
            Qu·∫£n L√Ω ƒê∆°n H√†ng
          </h1>
          <p class="text-gray-500 text-xs mt-1 ml-1">H·ªá th·ªëng b·∫£o h√†nh & doanh thu</p>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
          <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-lg"><i class="fa-solid fa-sack-dollar"></i></div>
          <div>
              <div class="text-[10px] text-gray-500 font-bold uppercase">Doanh Thu</div>
              <div id="totalRevenue" class="text-lg font-bold text-gray-800">0 ‚Ç´</div>
          </div>
      </div>

      <!-- ·∫®N L·ª¢I NHU·∫¨N THEO Y√äU C·∫¶U C≈® -->
      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4 hidden">
          <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-lg"><i class="fa-solid fa-chart-line"></i></div>
          <div>
              <div class="text-[10px] text-gray-500 font-bold uppercase">L·ª£i Nhu·∫≠n</div>
              <div id="totalProfit" class="text-lg font-bold text-gray-800">0 ‚Ç´</div>
          </div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
          <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-lg"><i class="fa-solid fa-mobile-screen"></i></div>
          <div>
              <div class="text-[10px] text-gray-500 font-bold uppercase">M√°y B√°n Ra</div>
              <div id="totalSeriCount" class="text-lg font-bold text-gray-800">0</div>
          </div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
          <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-lg"><i class="fa-solid fa-receipt"></i></div>
          <div>
              <div class="text-[10px] text-gray-500 font-bold uppercase">ƒê∆°n H√†ng</div>
              <div id="totalCount" class="text-lg font-bold text-gray-800">0</div>
          </div>
      </div>
  </div>

  <!-- TOOLBAR & FILTERS -->
  <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4 flex flex-col md:flex-row gap-3 items-center z-30">
        <!-- B·ªò L·ªåC K·∫æT H·ª¢P -->
        <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
            <!-- Lo·∫°i ƒë∆°n -->
            <select id="filterCategory" onchange="filterData()" class="bg-white border border-gray-300 rounded-lg px-3 py-2.5 text-sm outline-none focus:border-indigo-500 text-gray-700 font-medium h-[42px]">
                <option value="ALL">üì¶ T·∫•t c·∫£ lo·∫°i</option>
                <option value="MACHINE">üì± M√°y (Serial)</option>
                <option value="ACCESSORY">üéß Ph·ª• Ki·ªán</option>
            </select>

            <!-- Th·ªùi gian (M·ªöI) -->
            <select id="filterTime" onchange="filterData()" class="bg-white border border-gray-300 rounded-lg px-3 py-2.5 text-sm outline-none focus:border-indigo-500 text-indigo-700 font-bold h-[42px]">
                <option value="THIS_MONTH" selected>üìÖ Th√°ng n√†y</option>
                <option value="LAST_MONTH">‚èÆÔ∏è Th√°ng tr∆∞·ªõc</option>
                <option value="THIS_QUARTER">üìä Qu√Ω n√†y</option>
                <option value="ALL">üóìÔ∏è To√†n th·ªùi gian</option>
            </select>
            
            <!-- ƒê√É B·ªé B·ªò L·ªåC SALE V√å USER CH·ªà XEM ƒê∆Ø·ª¢C C·ª¶A M√åNH -->
        </div>

        <div class="relative flex-1 w-full">
            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input id="searchInput" type="text" oninput="filterData()" placeholder="T√¨m t√™n kh√°ch, s·ªë seri, t√™n m√°y..."
            class="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-gray-700 placeholder-gray-400" />
        </div>

        <div class="flex gap-2 shrink-0 w-full md:w-auto">
            <button onclick="loadData()" class="px-4 py-2.5 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors border border-gray-200 shadow-sm">
                <i class="fa-solid fa-rotate"></i>
            </button>
            <button onclick="openModal('add')" class="flex-1 md:flex-none px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-md flex items-center justify-center gap-2 active:scale-95 transform duration-150">
                <i class="fa-solid fa-plus-circle"></i> <span>T·∫°o ƒê∆°n</span>
            </button>
        </div>
  </div>

  <!-- DATA CONTAINER -->
  <div class="relative bg-white rounded-xl shadow border border-gray-200 overflow-hidden flex flex-col min-h-[500px] bg-gray-50 md:bg-white">
    <div id="loading" class="hidden absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-3"></div>
        <span class="text-indigo-700 font-medium text-xs animate-pulse">ƒêang t·∫£i d·ªØ li·ªáu...</span>
    </div>

    <div class="overflow-x-auto custom-scrollbar flex-1">
        <!-- DESKTOP TABLE -->
        <table class="min-w-full text-left border-collapse hidden md:table">
            <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold sticky top-0 z-20 shadow-sm">
                <tr>
                    <th class="p-4 w-14 text-center">#</th>
                    <th class="p-4 w-28 text-center">Ng√†y B√°n</th>
                    <th class="p-4 min-w-[250px]">S·∫£n Ph·∫©m & Seri</th>
                    <th class="p-4 w-48">Kh√°ch H√†ng</th>
                    <th class="p-4 w-32 text-center">B·∫£o H√†nh</th>
                    <th class="p-4 w-36 text-right">T√†i Ch√≠nh</th>
                    <!-- ƒê√É ·∫®N C·ªòT SALE -->
                    <th class="p-4 w-16 text-center sticky right-0 bg-gray-50 shadow-left">X·ª≠ L√Ω</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="divide-y divide-gray-100 text-sm text-gray-700"></tbody>
        </table>

        <!-- MOBILE CARD LIST -->
        <div id="mobileList" class="md:hidden p-3 space-y-3">
            <!-- Cards will be injected here -->
        </div>
    </div>
  </div>
</div>

<!-- MODAL ADD/EDIT (FULL SCREEN ON MOBILE) -->
<div id="modal" class="fixed inset-0 bg-black/60 z-40 flex items-center justify-center transition-opacity duration-200 modal-hide backdrop-blur-sm no-print hidden">
  <div class="bg-white w-full h-[100dvh] md:h-auto md:max-w-4xl md:max-h-[90vh] md:rounded-2xl shadow-2xl flex flex-col overflow-hidden transform transition-all duration-200">
    
    <div class="bg-indigo-600 p-4 flex justify-between items-center text-white shrink-0 shadow-md z-10">
        <h2 class="text-lg font-bold flex items-center gap-2"><i class="fa-solid fa-file-signature"></i> <span id="modalTitle">Th√¥ng Tin ƒê∆°n H√†ng</span></h2>
        <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-indigo-500 transition text-white text-xl">&times;</button>
    </div>
    
    <div class="p-6 overflow-y-auto flex-1 bg-gray-50 space-y-6">
        <input type="hidden" id="seri_key">
        
        <!-- Th√¥ng tin kh√°ch -->
        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm relative overflow-hidden">
             <div class="absolute top-0 left-0 bg-indigo-100 text-indigo-700 text-[10px] font-bold px-3 py-1 rounded-br-lg uppercase tracking-wider">Th√¥ng tin kh√°ch h√†ng</div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mt-3">
                 <div>
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">S·ªë ƒëi·ªán tho·∫°i <span class="text-red-500">*</span></label>
                     <input type="text" id="inp_sdt" onchange="lookupCustomer()" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 font-mono font-bold text-indigo-700 bg-indigo-50/30" placeholder="Nh·∫≠p SƒêT ƒë·ªÉ t√¨m...">
                 </div>
                 <div>
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">H·ªç T√™n Kh√°ch</label>
                     <input type="text" id="cust_name_display" class="w-full border border-gray-300 rounded-lg p-2.5 bg-gray-50 text-gray-600 font-medium cursor-not-allowed" readonly placeholder="(T·ª± ƒë·ªông hi·ªÉn th·ªã)">
                 </div>
             </div>
        </div>

        <!-- Th√¥ng tin s·∫£n ph·∫©m -->
        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm relative overflow-hidden">
             <div class="absolute top-0 left-0 bg-green-100 text-green-700 text-[10px] font-bold px-3 py-1 rounded-br-lg uppercase tracking-wider">Th√¥ng tin s·∫£n ph·∫©m</div>
             <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mt-3">
                 <div class="md:col-span-2">
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Seri / IMEI <span class="text-red-500">*</span></label>
                     <input type="text" id="inp_seri" onchange="lookupProduct()" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500 uppercase font-mono font-bold bg-green-50/30" placeholder="Qu√©t ho·∫∑c nh·∫≠p Seri...">
                 </div>
                 <div class="md:col-span-2">
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">T√™n M√°y / S·∫£n Ph·∫©m</label>
                     <input type="text" id="inp_name" class="w-full border border-gray-300 rounded-lg p-2.5 bg-gray-50 font-bold text-gray-700 cursor-not-allowed" readonly>
                 </div>
                 <div class="hidden"><input id="inp_dl"><input id="inp_color"><input id="inp_pin"><input id="inp_tt"><input id="inp_sim"></div>
             </div>
        </div>

        <!-- Thanh to√°n & B·∫£o h√†nh -->
        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm relative overflow-hidden">
             <div class="absolute top-0 left-0 bg-orange-100 text-orange-700 text-[10px] font-bold px-3 py-1 rounded-br-lg uppercase tracking-wider">Thanh to√°n & B·∫£o h√†nh</div>
             <div class="grid grid-cols-2 md:grid-cols-4 gap-5 mt-3">
                 <div>
                     <label class="block text-xs font-bold text-red-600 uppercase mb-1">Gi√° B√°n</label>
                     <input type="text" id="inp_giaban" onkeyup="formatCurrencyInput(this)" class="w-full border border-red-200 rounded-lg p-2.5 outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 font-bold text-red-600 bg-red-50/30 text-lg">
                 </div>
                 <!-- ·∫®n Gi√° V·ªën nh∆∞ng v·∫´n d√πng ƒë·ªÉ t√≠nh to√°n -->
                 <div class="hidden">
                     <input type="text" id="inp_gianhap">
                 </div>
                 <div>
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ng√†y B√°n</label>
                     <input type="date" id="inp_date" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-indigo-500 text-sm font-medium text-gray-700">
                 </div>
                 
                 <!-- PTTT N√ÇNG C·∫§P (CHO PH√âP CHIA NH·ªé) -->
                 <div class="col-span-1 relative">
                     <div class="flex justify-between items-center mb-1">
                         <label class="block text-xs font-bold text-gray-500 uppercase">H√¨nh Th·ª©c TT</label>
                         <button type="button" onclick="togglePtttMode()" id="btnPtttToggle" class="text-[10px] text-indigo-600 font-bold hover:underline hover:text-indigo-800 cursor-pointer transition">
                             <i class="fa-solid fa-code-branch mr-1"></i>Chia nh·ªè
                         </button>
                     </div>
                     
                     <!-- Mode 1: Simple (Default) -->
                     <select id="inp_pttt_simple" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none bg-white text-sm font-medium">
                         <option>CK</option>
                         <option>TM</option>
                         <option>G√ìP</option>
                         <option>TH·∫∫</option>
                         <option>N·ª¢</option>
                     </select>

                     <!-- Mode 2: Split (Hidden) -->
                     <div id="div_pttt_split" class="hidden space-y-2 bg-gray-50 p-2 rounded-lg border border-gray-200 shadow-inner">
                        <div class="flex gap-1 items-center">
                            <select id="pttt_method_1" class="w-16 border border-gray-300 rounded p-1.5 text-xs font-bold bg-white"><option>TM</option><option>CK</option><option>TH·∫∫</option></select>
                            <input type="text" id="pttt_amount_1" onkeyup="formatCurrencyInput(this)" class="flex-1 border border-gray-300 rounded p-1.5 text-xs font-mono" placeholder="S·ªë ti·ªÅn...">
                        </div>
                        <div class="flex gap-1 items-center">
                            <select id="pttt_method_2" class="w-16 border border-gray-300 rounded p-1.5 text-xs font-bold bg-white"><option>CK</option><option>TM</option><option>G√ìP</option></select>
                            <input type="text" id="pttt_amount_2" onkeyup="formatCurrencyInput(this)" class="flex-1 border border-gray-300 rounded p-1.5 text-xs font-mono" placeholder="S·ªë ti·ªÅn...">
                        </div>
                     </div>
                 </div>

                 <div>
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Bao Test</label>
                     <input type="text" id="inp_baotest" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" placeholder="7 ng√†y">
                 </div>
                 <div>
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">B·∫£o H√†nh</label>
                     <input type="text" id="inp_baohanh" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" placeholder="6 th√°ng">
                 </div>
                 
                 <div class="hidden">
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nh√¢n Vi√™n Sale</label>
                     <input type="text" id="inp_sale" value="SHOP" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm font-bold text-indigo-700 bg-white">
                 </div>
                 
                 <!-- M·ªöI: T√çNH NƒÇNG CH·ªåN QU√Ä T·ª™ KHO -->
                 <div class="col-span-2 md:col-span-4 bg-orange-50 p-3 rounded-lg border border-orange-100 relative">
                     <label class="block text-xs font-bold text-orange-600 uppercase mb-2 flex items-center justify-between">
                         <span><i class="fa-solid fa-gift mr-1"></i>Qu√† T·∫∑ng K√®m (T·ª± ƒë·ªông tr·ª´ kho)</span>
                         <button onclick="openGiftSelect()" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-xs transition shadow-sm font-bold"><i class="fa-solid fa-plus mr-1"></i>Ch·ªçn Qu√†</button>
                     </label>
                     
                     <!-- V√πng hi·ªÉn th·ªã qu√† ƒë√£ ch·ªçn -->
                     <div id="selected-gifts-container" class="min-h-[40px] border border-dashed border-orange-300 rounded bg-white p-2 flex flex-wrap gap-2 text-sm text-gray-500 italic">
                         (Ch∆∞a c√≥ qu√† t·∫∑ng)
                     </div>
                 </div>

                 <div class="col-span-2 md:col-span-4">
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ghi Ch√∫ ƒê∆°n H√†ng</label>
                     <textarea id="inp_ghichu" rows="2" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-indigo-500 text-sm" placeholder="Ghi ch√∫ th√™m..."></textarea>
                 </div>
             </div>
        </div>
    </div>

    <div class="p-4 border-t bg-white flex justify-end gap-3 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
      <button onclick="closeModal()" class="px-6 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-100 text-gray-600 font-bold transition">H·ªßy</button>
      <button id="btnSave" onclick="saveData()" class="px-6 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-lg font-bold transition flex items-center gap-2 transform active:scale-95">
        <i class="fa-solid fa-floppy-disk"></i> L∆∞u ƒê∆°n H√†ng
      </button>
    </div>
  </div>
</div>

<!-- MODAL CH·ªåN QU√Ä (GIFT SELECTION) -->
<div id="giftModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center hidden modal-hide backdrop-blur-sm">
    <div class="bg-white w-full max-w-lg md:rounded-xl h-full md:h-[80vh] flex flex-col shadow-2xl overflow-hidden">
        <div class="bg-orange-600 p-4 text-white flex justify-between items-center shrink-0">
             <h3 class="font-bold flex items-center gap-2"><i class="fa-solid fa-gifts"></i> Ch·ªçn Qu√† T·∫∑ng</h3>
             <button onclick="closeGiftModal()" class="w-8 h-8 rounded-full hover:bg-orange-500 flex items-center justify-center text-xl">&times;</button>
        </div>
        
        <div class="p-3 bg-gray-50 border-b flex gap-2 shrink-0">
             <input type="text" id="giftSearch" onkeyup="renderGiftList()" placeholder="T√¨m t√™n ph·ª• ki·ªán..." class="flex-1 border p-2 rounded outline-none focus:border-orange-500 text-sm">
        </div>

        <div id="giftLoading" class="hidden p-10 text-center text-gray-500"><i class="fa-solid fa-spinner fa-spin mr-2"></i>ƒêang t·∫£i kho ph·ª• ki·ªán...</div>

        <div class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-100" id="giftListBody">
             <!-- List items injected by JS -->
        </div>
        
        <div class="p-3 bg-white border-t shrink-0 text-right">
             <button onclick="closeGiftModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded font-bold">ƒê√≥ng</button>
        </div>
    </div>
</div>

<!-- ACTION SHEET (MENU 3 CH·∫§M - ƒê√É B·ªé N√öT X√ìA) -->
<div id="actionSheet" class="fixed inset-0 bg-black/60 z-50 flex items-end justify-center hidden no-print" onclick="closeActionMenu()">
    <div class="bg-white w-full max-w-md rounded-t-2xl shadow-2xl overflow-hidden transform translate-y-full transition-transform duration-200" id="mas_content" onclick="event.stopPropagation()">
        <div class="bg-gray-100 p-4 text-center border-b font-bold text-gray-700 truncate" id="mas_title">T√™n M√°y</div>
        <input type="hidden" id="mas_seri">
        <div class="p-4 space-y-3">
             <button onclick="triggerAction('copy')" class="w-full py-3 bg-indigo-50 text-indigo-700 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-indigo-100 active:scale-95 transition"><i class="fa-regular fa-copy text-xl"></i> Copy B√°o C√°o</button>
             <button onclick="triggerAction('print')" class="w-full py-3 bg-green-50 text-green-700 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-green-100 active:scale-95 transition"><i class="fa-solid fa-print text-xl"></i> In Phi·∫øu B·∫£o H√†nh</button>
             <button onclick="triggerAction('edit')" class="w-full py-3 bg-blue-50 text-blue-700 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-blue-100 active:scale-95 transition"><i class="fa-solid fa-pen text-xl"></i> S·ª≠a ƒê∆°n H√†ng</button>
             <!-- ƒê√É X√ìA N√öT DELETE CHO B·∫¢N USER -->
        </div>
        <div class="p-4 border-t bg-white">
            <button onclick="closeActionMenu()" class="w-full py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition">H·ªßy B·ªè</button>
        </div>
    </div>
</div>

<script>
// ================= CONFIG =================
const API_URL = 'https://script.google.com/macros/s/AKfycbxWoqnSMsi-2gNiA_lGlqDkuYEnv7kqoFvkkVY7DY-JIHPuROYwfdobCJ6kX8SHZk1_Jg/exec'; 
// API Ph·ª• Ki·ªán (ƒê·ªÉ tr·ª´ kho & t√≠nh v·ªën)
const API_ACC_URL = 'https://script.google.com/macros/s/AKfycbz0wygOHQKBXHIRQvUMnyE0GygUKwVfovJu6dxRzIOYdBukyB-k7JGO3xRtzqfUxN8W/exec';
// ==========================================

let allData = [];
let accData = []; // Store accessory data
let selectedGifts = []; // Selected gifts
let isEditing = false;
let isSplitPttt = false; // Flag for PTTT mode

const qs = (s) => document.querySelector(s);
const getVal = (id) => document.getElementById(id).value;
const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
const formatMoney = (n) => n ? Number(String(n).replace(/\D/g, '')).toLocaleString('vi-VN') : '0';
const formatCurrencyInput = (input) => { let value = input.value.replace(/\D/g, ''); input.value = value ? Number(value).toLocaleString('vi-VN') : ''; };
const convertToISO = (d) => { if(!d) return ''; const m = d.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); return m ? `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}` : d; };
const formatDateForDisplay = (d) => { if(!d) return ''; const m = d.match(/^(\d{4})-(\d{2})-(\d{2})$/); return m ? `${m[3]}/${m[2]}/${m[1]}` : d; };
const formatDateToInput = (d) => { let m = ''+(d.getMonth()+1), dy = ''+d.getDate(), y = d.getFullYear(); if(m.length<2) m='0'+m; if(dy.length<2) dy='0'+dy; return [y,m,dy].join('-'); };

// --- PTTT LOGIC ---
function togglePtttMode() {
    isSplitPttt = !isSplitPttt;
    const btn = qs('#btnPtttToggle');
    const simple = qs('#inp_pttt_simple');
    const split = qs('#div_pttt_split');
    
    if (isSplitPttt) {
        btn.innerHTML = '<i class="fa-solid fa-arrow-left mr-1"></i>C∆° b·∫£n';
        simple.classList.add('hidden');
        split.classList.remove('hidden');
    } else {
        btn.innerHTML = '<i class="fa-solid fa-code-branch mr-1"></i>Chia nh·ªè';
        simple.classList.remove('hidden');
        split.classList.add('hidden');
    }
}

function getPtttValue() {
    if (!isSplitPttt) return getVal('inp_pttt_simple');
    
    const m1 = getVal('pttt_method_1');
    const a1 = getVal('pttt_amount_1').trim();
    const m2 = getVal('pttt_method_2');
    const a2 = getVal('pttt_amount_2').trim();
    
    // Construct string like: "TM 500.000 + CK 1.000.000"
    let parts = [];
    if(a1) parts.push(`${m1} ${a1}`);
    if(a2) parts.push(`${m2} ${a2}`);
    
    return parts.length > 0 ? parts.join(' + ') : getVal('inp_pttt_simple'); // Fallback if empty
}

// --- API ---
async function fetchData(bodyData = null) {
    try {
        const options = { 
          method: bodyData ? 'POST' : 'GET', 
          headers: bodyData ? { "Content-Type": "text/plain;charset=utf-8" } : undefined, 
          body: bodyData ? JSON.stringify(bodyData) : undefined 
        };
        const res = await fetch(API_URL, options);
        return await res.json();
    } catch (e) {
        if(!bodyData) alert("L·ªói k·∫øt n·ªëi: " + e.message);
        return null;
    }
}

// NEW: FETCH ACCESSORIES
async function fetchAccessories() {
    try {
        const res = await fetch(API_ACC_URL, {
            method: 'POST',
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ action: "get_accessories" })
        });
        const json = await res.json();
        if(json.success) return json.data;
        return [];
    } catch(e) { console.error(e); return []; }
}

// --- LOOKUPS ---
async function lookupProduct() {
    const seri = getVal('inp_seri').trim();
    if(!seri) return;
    qs('#inp_seri').classList.add('input-loading');
    const res = await fetchData({ action: 'lookup_product', SERI: seri });
    qs('#inp_seri').classList.remove('input-loading');
    if(res && res.success) {
        const d = res.data;
        setVal('inp_name', d.NAME); setVal('inp_dl', d.DL); setVal('inp_color', d.COLOR); setVal('inp_sim', d.SIM);
        setVal('inp_tt', d.TINHTRANG); setVal('inp_pin', d.PIN); setVal('inp_giaban', formatMoney(d.GIABAN)); 
        setVal('inp_gianhap', formatMoney(d.GIANHAP)); if(d.GHICHU) setVal('inp_ghichu', d.GHICHU);
    } else { setVal('inp_name', ''); alert("Kh√¥ng t√¨m th·∫•y Seri trong kho!"); }
}

async function lookupCustomer() {
    const sdt = getVal('inp_sdt').trim();
    if(!sdt) { qs('#cust_name_display').value = ''; return; }
    qs('#inp_sdt').classList.add('input-loading');
    const res = await fetchData({ action: 'lookup_customer', SDT: sdt });
    qs('#inp_sdt').classList.remove('input-loading');
    if(res && res.success) qs('#cust_name_display').value = res.data.TEN;
    else qs('#cust_name_display').value = "Kh√°ch h√†ng m·ªõi (C·∫ßn t·∫°o tr∆∞·ªõc)";
}

// --- CORE ---
async function loadData() {
    qs('#loading').classList.remove('hidden'); 
    const data = await fetchData();
    if(data) { 
        allData = data; 
        filterData(); 
    }
    qs('#loading').classList.add('hidden'); 
}

function filterData() {
    const k = qs('#searchInput').value.toLowerCase();
    const typeVal = qs('#filterCategory').value;
    const timeVal = qs('#filterTime').value;
    
    // T·ª± ƒë·ªông l·∫•y NV_TEN ƒë·ªÉ l·ªçc
    const currentUser = localStorage.getItem("NV_TEN"); 

    const now = new Date();
    let fromDate, toDate;
    if (timeVal === 'THIS_MONTH') {
        fromDate = new Date(now.getFullYear(), now.getMonth(), 1);
        toDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    } else if (timeVal === 'LAST_MONTH') {
        fromDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        toDate = new Date(now.getFullYear(), now.getMonth(), 0);
    } else if (timeVal === 'THIS_QUARTER') {
        const quarter = Math.floor((now.getMonth() / 3));
        fromDate = new Date(now.getFullYear(), quarter * 3, 1);
        toDate = new Date(now.getFullYear(), quarter * 3 + 3, 0);
    }
    const fromStr = fromDate ? formatDateToInput(fromDate) : '';
    const toStr = toDate ? formatDateToInput(toDate) : '';

    let totalRev = 0, totalProf = 0, countSeri = 0;

    let filtered = allData.filter(r => {
        // --- LOGIC L·ªåC THEO SALE C·ª¶A USER ---
        if (currentUser && (r.SALE || '').trim().toLowerCase() !== currentUser.trim().toLowerCase()) return false;
        // -------------------------------------

        const seriStr = (r.SERI || '').toString().toUpperCase();
        const isAccessory = seriStr.startsWith('PK');
        if (typeVal === 'MACHINE' && (isAccessory || !seriStr)) return false;
        if (typeVal === 'ACCESSORY' && !isAccessory) return false;
        const textMatch = (r.SERI||'').toLowerCase().includes(k) || (r.NAME||'').toLowerCase().includes(k) || (r.SDTKHACH && r.SDTKHACH.includes(k));
        let dateMatch = true;
        if (timeVal !== 'ALL' && r.DATE) {
            const rDateISO = convertToISO(r.DATE);
            if (rDateISO < fromStr || rDateISO > toStr) dateMatch = false;
        }
        return textMatch && dateMatch;
    });

    // M·ªöI: S·∫Øp x·∫øp theo ng√†y gi·∫£m d·∫ßn (M·ªõi nh·∫•t l√™n ƒë·∫ßu)
    filtered.sort((a, b) => {
        const dateA = new Date(convertToISO(a.DATE) || '1970-01-01');
        const dateB = new Date(convertToISO(b.DATE) || '1970-01-01');
        return dateB - dateA;
    });

    filtered.forEach(r => {
        const sell = Number(r.GIABAN) || 0;
        const buy = Number(r.GIANHAP) || 0;
        totalRev += sell;
        totalProf += (sell - buy);
        if (r.SERI && !r.SERI.toString().toUpperCase().startsWith('PK')) countSeri++;
    });

    qs('#totalRevenue').innerText = formatMoney(totalRev) + ' ‚Ç´';
    qs('#totalProfit').innerText = formatMoney(totalProf) + ' ‚Ç´';
    qs('#totalCount').innerText = filtered.length;
    qs('#totalSeriCount').innerText = countSeri;
    renderTable(filtered);
}

function renderTable(data) {
    const tbody = qs('#tableBody');
    const mobileList = qs('#mobileList');
    tbody.innerHTML = '';
    mobileList.innerHTML = '';

    if(data.length === 0) { 
        const emptyMsg = `<div class="p-8 text-center text-gray-400 italic">Kh√¥ng c√≥ d·ªØ li·ªáu</div>`;
        tbody.innerHTML = `<tr><td colspan="7">${emptyMsg}</td></tr>`; 
        mobileList.innerHTML = emptyMsg;
        return; 
    }

    data.forEach((row, i) => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-indigo-50 border-b border-gray-100 transition-colors group bg-white desktop-row";
        
        let dateDisplay = formatDateForDisplay(row.DATE); 
        let productDetails = [row.DL, row.COLOR, row.SIM].filter(Boolean).join(' | ');
        let statusDetails = [row.TINHTRANG, row.PIN ? `Pin ${row.PIN}%` : ''].filter(Boolean).join(' - ');

        tr.innerHTML = `
            <td class="p-4 text-center text-gray-400 text-xs hidden md:table-cell">${i + 1}</td>
            <td class="p-4 align-top w-28 text-center font-mono text-gray-600 text-xs hidden md:table-cell">${dateDisplay}</td>
            <td class="p-4 align-top whitespace-normal">
                <div class="flex items-center justify-between mb-1">
                    <div class="font-bold text-gray-800 text-sm">${row.NAME}</div>
                    <div class="font-mono text-xs text-indigo-600 font-bold cursor-pointer select-all">${row.SERI}</div>
                </div>
                <div class="flex gap-2 text-xs text-gray-500">
                        ${productDetails ? `<span class="bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200">${productDetails}</span>` : ''}
                        ${statusDetails ? `<span class="bg-green-50 text-green-700 px-1.5 py-0.5 rounded border border-green-100">${statusDetails}</span>` : ''}
                </div>
                ${row.GHICHU ? `<div class="text-xs text-gray-400 italic mt-1 truncate max-w-[250px]"><i class="fa-regular fa-note-sticky mr-1"></i>${row.GHICHU}</div>` : ''}
            </td>
            <td class="p-4 align-top hidden md:table-cell">
                <div class="font-bold text-gray-700 text-sm">${row.SDTKHACH || '-'}</div>
                <div class="text-[10px] text-gray-400 mt-0.5 uppercase">Sale: ${row.SALE || '-'}</div>
            </td>
            <td class="p-4 text-center hidden md:table-cell">
                <div class="text-[10px] text-blue-700 font-bold mb-1">${row.BAOTEST || '-'}</div>
                <div class="text-xs font-bold text-green-600">${row.BAOHANH || '-'}</div>
            </td>
            <td class="p-4 text-right align-top hidden md:table-cell">
                <div class="font-mono font-bold text-red-600">${formatMoney(row.GIABAN)}</div>
                <div class="text-[10px] bg-indigo-50 text-indigo-700 inline-block px-1.5 py-0.5 rounded border border-indigo-100 mt-1 font-bold truncate max-w-[120px]">${row.PTTT}</div>
            </td>
            <!-- ƒê√É B·ªé C·ªòT SALE -->
            <td class="p-4 text-center align-middle sticky right-0 z-10 bg-white group-hover:bg-indigo-50 shadow-left">
                <button onclick="openActionMenu('${row.SERI}')" class="text-gray-400 hover:text-indigo-600 p-2 rounded-full hover:bg-indigo-100 transition"><i class="fa-solid fa-ellipsis-vertical text-lg"></i></button>
            </td>
        `;
        tbody.appendChild(tr);

        const card = document.createElement('div');
        card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 mobile-card relative";
        card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-mono text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">${dateDisplay}</span>
                    <span class="text-[10px] font-bold text-indigo-600 border border-indigo-100 px-1.5 py-0.5 rounded bg-indigo-50 truncate max-w-[150px]">${row.PTTT}</span>
                </div>
                <button onclick="openActionMenu('${row.SERI}')" class="text-gray-400 p-1"><i class="fa-solid fa-ellipsis-vertical text-lg"></i></button>
            </div>
            <div class="mb-3">
                <div class="font-bold text-gray-800 text-base mb-1">${row.NAME}</div>
                <div class="flex flex-wrap gap-2 text-xs text-gray-500 mb-1">
                    ${productDetails ? `<span>${productDetails}</span>` : ''}
                </div>
                <div class="font-mono text-xs text-indigo-600 font-bold bg-indigo-50 px-2 py-1 rounded inline-block select-all">${row.SERI}</div>
            </div>
            <div class="flex justify-between items-end border-t border-gray-50 pt-2">
                <div>
                    <div class="text-xs font-bold text-gray-600">${row.SDTKHACH || 'Kh√°ch l·∫ª'}</div>
                    <!-- ƒê√É B·ªé D√íNG SALE -->
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-400 mb-0.5">Th√†nh ti·ªÅn</div>
                    <div class="font-mono font-bold text-red-600 text-lg">${formatMoney(row.GIABAN)}</div>
                </div>
            </div>
        `;
        mobileList.appendChild(card);
    });
}

// === ACTION SHEET LOGIC ===
function openActionMenu(seri) {
    const item = allData.find(r => r.SERI == seri);
    const name = item ? item.NAME : '';
    qs('#mas_title').innerText = name;
    qs('#mas_seri').value = seri;
    qs('#actionSheet').classList.remove('hidden');
    setTimeout(() => { qs('#mas_content').classList.remove('translate-y-full'); }, 10);
}

function closeActionMenu() {
    qs('#mas_content').classList.add('translate-y-full');
    setTimeout(() => { qs('#actionSheet').classList.add('hidden'); }, 200);
}

function triggerAction(type) {
    const seri = qs('#mas_seri').value;
    closeActionMenu();
    setTimeout(() => {
        if(type === 'copy') copyOrderReport(seri);
        if(type === 'print') printWarranty(seri);
        if(type === 'edit') openEdit(seri);
        // DELETE ƒê√É B·ªä LO·∫†I B·ªé
    }, 200);
}

// === NEW: GIFT LOGIC & MODALS ===
async function openGiftSelect() {
    qs('#giftModal').classList.remove('hidden'); 
    setTimeout(() => { qs('#giftModal').classList.remove('modal-hide'); qs('#giftModal').classList.add('modal-open'); }, 10);
    
    // Only fetch if empty to save bandwidth
    if(accData.length === 0) {
        qs('#giftLoading').classList.remove('hidden');
        accData = await fetchAccessories();
        qs('#giftLoading').classList.add('hidden');
    }
    renderGiftList();
}

function closeGiftModal() {
    qs('#giftModal').classList.remove('modal-open'); qs('#giftModal').classList.add('modal-hide');
    setTimeout(() => qs('#giftModal').classList.add('hidden'), 200);
}

function renderGiftList() {
    const k = qs('#giftSearch').value.toLowerCase();
    const container = qs('#giftListBody');
    container.innerHTML = '';

    const filtered = accData.filter(i => i.NAME.toLowerCase().includes(k) || i.SKU.toLowerCase().includes(k));
    
    if(filtered.length === 0) {
        container.innerHTML = '<div class="text-center p-4 text-gray-400">Kh√¥ng t√¨m th·∫•y ph·ª• ki·ªán</div>';
        return;
    }

    filtered.forEach(item => {
        const div = document.createElement('div');
        div.className = "bg-white p-3 rounded shadow-sm border flex justify-between items-center";
        // Create stock buttons
        const btnCN1 = item.QTY_CN1 > 0 
            ? `<button onclick="addGiftToOrder('${item.SKU}', 'CN1')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs font-bold hover:bg-blue-200">CN1 (${item.QTY_CN1})</button>`
            : `<button class="bg-gray-100 text-gray-400 px-3 py-1 rounded text-xs font-bold cursor-not-allowed">CN1 (0)</button>`;
            
        const btnCN2 = item.QTY_CN2 > 0 
            ? `<button onclick="addGiftToOrder('${item.SKU}', 'CN2')" class="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold hover:bg-green-200">CN2 (${item.QTY_CN2})</button>`
            : `<button class="bg-gray-100 text-gray-400 px-3 py-1 rounded text-xs font-bold cursor-not-allowed">CN2 (0)</button>`;

        div.innerHTML = `
            <div>
                <div class="font-bold text-sm text-gray-800">${item.NAME}</div>
                <div class="text-xs text-gray-500 font-mono">${item.SKU}</div>
            </div>
            <div class="flex gap-2">
                ${btnCN1} ${btnCN2}
            </div>
        `;
        container.appendChild(div);
    });
}

function addGiftToOrder(sku, from) {
    const item = accData.find(i => i.SKU === sku);
    if(!item) return;
    
    // Add to selected list
    selectedGifts.push({
        SKU: sku,
        NAME: item.NAME,
        QTY: 1,
        PRICE: 0, // Gift is 0
        COST: item.COST,
        FROM: from,
        FROM_LABEL: from === 'CN1' ? 'CN 1' : 'CN 2'
    });
    
    renderSelectedGifts();
    closeGiftModal();
}

function renderSelectedGifts() {
    const container = qs('#selected-gifts-container');
    container.innerHTML = '';
    
    if(selectedGifts.length === 0) {
        container.innerHTML = '(Ch∆∞a c√≥ qu√† t·∫∑ng)';
        return;
    }

    selectedGifts.forEach((g, idx) => {
        const tag = document.createElement('span');
        tag.className = 'gift-tag';
        tag.innerHTML = `${g.NAME} (${g.FROM_LABEL}) <button onclick="removeGift(${idx})">&times;</button>`;
        container.appendChild(tag);
    });
}

function removeGift(idx) {
    selectedGifts.splice(idx, 1);
    renderSelectedGifts();
}

// === MAIN MODAL ACTIONS ===
function openModal(mode) {
    qs('#modal').classList.remove('hidden'); 
    setTimeout(() => { qs('#modal').classList.remove('modal-hide'); qs('#modal').classList.add('modal-open'); }, 10);
    if(mode === 'add') {
        isEditing = false; qs('#modalTitle').innerHTML = '<i class="fa-solid fa-file-circle-plus"></i> T·∫°o ƒê∆°n H√†ng M·ªõi';
        setVal('seri_key', ''); setVal('inp_date', new Date().toISOString().split('T')[0]);
        setVal('inp_seri', ''); setVal('inp_name', ''); setVal('inp_dl', '');
        setVal('inp_color', ''); setVal('inp_sim', ''); setVal('inp_tt', '');
        setVal('inp_pin', ''); setVal('inp_ghichu', ''); setVal('inp_giaban', ''); setVal('inp_gianhap', '');
        setVal('inp_baotest', ''); setVal('inp_baohanh', ''); setVal('inp_sdt', ''); 
        
        // Reset PTTT
        isSplitPttt = false; togglePtttMode(); 
        setVal('inp_pttt_simple', 'CK');
        setVal('pttt_amount_1', ''); setVal('pttt_amount_2', '');
        // Force reset UI state because toggle flips bool
        isSplitPttt = true; togglePtttMode(); // Set to False visual state

        qs('#cust_name_display').value = '';
        setVal('inp_sale', 'SHOP');
        
        // Clear gifts for new order
        selectedGifts = [];
        renderSelectedGifts();
    }
}

function openEdit(seri) {
    const item = allData.find(r => r.SERI == seri);
    if(!item) return;
    openModal(); isEditing = true; qs('#modalTitle').innerHTML = '<i class="fa-solid fa-pen-to-square"></i> S·ª≠a ƒê∆°n H√†ng';
    setVal('seri_key', item.SERI); setVal('inp_date', convertToISO(item.DATE));
    setVal('inp_seri', item.SERI); setVal('inp_name', item.NAME); setVal('inp_dl', item.DL);
    setVal('inp_color', item.COLOR); setVal('inp_sim', item.SIM); setVal('inp_tt', item.TINHTRANG);
    setVal('inp_pin', item.PIN); setVal('inp_ghichu', item.GHICHU);
    setVal('inp_giaban', formatMoney(item.GIABAN)); setVal('inp_gianhap', formatMoney(item.GIANHAP));
    setVal('inp_baotest', item.BAOTEST); setVal('inp_baohanh', item.BAOHANH);
    setVal('inp_sale', item.SALE || 'SHOP');
    setVal('inp_sdt', item.SDTKHACH ? item.SDTKHACH.replace(/'/g, '') : '');
    
    // PTTT Handling (Auto-detect split vs simple)
    const pttt = item.PTTT || 'CK';
    const standardPttt = ['CK', 'TM', 'G√ìP', 'TH·∫∫', 'N·ª¢'];
    
    if (standardPttt.includes(pttt)) {
        // Simple Mode
        isSplitPttt = true; togglePtttMode(); 
        setVal('inp_pttt_simple', pttt);
        setVal('pttt_amount_1', ''); setVal('pttt_amount_2', '');
    } else {
        // Complex Mode (Split) -> Try to parse "TM 500000 + CK 1000000"
        isSplitPttt = false; togglePtttMode(); 
        
        // Regex to parse: Method1 Amount1 + Method2 Amount2
        // Handles "TM 500.000 + CK 1.000.000" or raw numbers
        const parts = pttt.split('+').map(p => p.trim());
        if(parts.length >= 2) {
            const p1 = parts[0].split(' ');
            const p2 = parts[1].split(' ');
            
            // Set First Part
            setVal('pttt_method_1', p1[0] || 'TM');
            setVal('pttt_amount_1', p1[1] || '');
            
            // Set Second Part
            setVal('pttt_method_2', p2[0] || 'CK');
            setVal('pttt_amount_2', p2[1] || '');
        } else {
            // Fallback if parsing fails but not standard
            setVal('pttt_amount_1', ''); setVal('pttt_amount_2', '');
        }
    }

    lookupCustomer();
    
    // NOTE: When editing, we do not restore gift list to avoid double deduction logic complexity
    // Just start with empty gift list (user can add more if needed)
    selectedGifts = [];
    renderSelectedGifts();
}

function closeModal() { 
    qs('#modal').classList.remove('modal-open'); qs('#modal').classList.add('modal-hide');
    setTimeout(() => qs('#modal').classList.add('hidden'), 200);
}

// === SAVE DATA LOGIC (Modified to deduct stock & calculate profit) ===
async function saveData() {
    const btn = qs('#btnSave');
    const seri = getVal('inp_seri').trim();
    const sdtRaw = getVal('inp_sdt').trim();
    if(!seri || !sdtRaw) return alert("Vui l√≤ng nh·∫≠p Seri v√† SƒêT!");
    
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...'; btn.disabled = true;

    // 1. Prepare Note & Cost Logic
    let note = getVal('inp_ghichu');
    let totalGiftCost = 0; // Initialize cost accumulator

    if(selectedGifts.length > 0) {
        // Map names and sum cost
        const giftNames = selectedGifts.map(g => {
            totalGiftCost += Number(g.COST || 0); // Accumulate Cost
            return g.NAME;
        }).join(', ');
        
        // Append gift info to note
        // We clean old tag if exists then append new
        note = note.replace(/\[T·∫∑ng: .*?\]/g, "").trim();
        note = `${note} [T·∫∑ng: ${giftNames}]`.trim();
    }
    
    // Calculate Final Import Price (Machine Cost + Gifts Cost)
    const currentImportPrice = Number(getVal('inp_gianhap').replace(/\./g, '')) || 0;
    const finalImportPrice = currentImportPrice + totalGiftCost;

    // Get PTTT Value using Helper
    const finalPttt = getPtttValue();

    const item = {
        DATE: getVal('inp_date'), SERI: seri, NAME: getVal('inp_name'), DL: getVal('inp_dl'),
        COLOR: getVal('inp_color'), SIM: getVal('inp_sim'), TINHTRANG: getVal('inp_tt'), PIN: getVal('inp_pin'),
        GHICHU: note, 
        GIABAN: getVal('inp_giaban').replace(/\./g, ''), 
        GIANHAP: finalImportPrice, // Use updated import price
        BAOTEST: getVal('inp_baotest'), BAOHANH: getVal('inp_baohanh'), SALE: getVal('inp_sale'),
        SDTKHACH: sdtRaw, 
        PTTT: finalPttt // Use new value
    };

    const body = { action: isEditing ? 'edit' : 'add', ...item, SDTKHACH: "'" + sdtRaw };
    if(isEditing) body.SERI_KEY = getVal('seri_key');

    try {
        // STEP 1: Save Machine Order
        const res = await fetchData(body);
        
        if(res && res.success) {
            
            // STEP 2: Deduct Gifts from Accessory Inventory (If gifts exist & NOT editing)
            // Warning: We generally only deduct on NEW orders to prevent double deduction on edits.
            if(selectedGifts.length > 0 && !isEditing) {
                try {
                     const accBody = {
                        action: 'sell_multi_acc',
                        items: selectedGifts,
                        customer: {
                            PHONE: sdtRaw,
                            NAME: qs('#cust_name_display').value || 'Kh√°ch mua m√°y',
                            SALE: getVal('inp_sale'),
                            BAOTEST: '', BAOHANH: '', PTTT: 'GIFT',
                            DATE: getVal('inp_date'),
                            NOTE: `T·∫∑ng k√®m theo m√°y ${seri}`
                        }
                    };
                    
                    // Call Accessory API
                    // No await needed here if we want UI to return fast, but safer to log
                    fetch(API_ACC_URL, {
                        method: 'POST',
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify(accBody)
                    }).then(r => console.log("Sent gift deduction request"));
                    
                } catch(err) {
                    console.error("L·ªói tr·ª´ kho qu√†: " + err.message);
                }
            }

            closeModal();
            loadData();
            if(!isEditing) printWarranty(seri);
            
        } else alert("L·ªói: " + (res ? res.message : 'K·∫øt n·ªëi th·∫•t b·∫°i'));
    } catch(e) { alert("L·ªói: " + e.message); }
    finally { btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> L∆∞u ƒê∆°n H√†ng'; btn.disabled = false; }
}

function initSaleSelect(targetValue) {
    const sel = qs('#inp_sale');
    sel.value = localStorage.getItem("NV_TEN") || "SHOP";
}

async function printWarranty(seri) {
    const row = allData.find(r => r.SERI === seri);
    if(!row) return;

    qs('#printModal').classList.remove('hidden');
    qs('#printModal').classList.add('flex');
    switchPrintTab('editor');

    setVal('print_prodType', row.NAME);
    setVal('print_prodModel', `${row.DL || ''} ${row.COLOR || ''} ${row.SIM || ''}`.trim());
    setVal('print_prodIMEI', row.SERI);
    setVal('print_prodCond', `${row.TINHTRANG || ''} ${row.PIN ? '- Pin '+row.PIN+'%' : ''}`.trim());
    setVal('print_custPhone', row.SDTKHACH ? row.SDTKHACH.replace(/'/g, '') : '');
    setVal('print_baotest', row.BAOTEST || '');
    setVal('print_warRepair', row.BAOHANH || '');

    // Extract Gift from Note
    let giftPrint = "";
    if (row.GHICHU && row.GHICHU.includes("[T·∫∑ng:")) {
        const match = row.GHICHU.match(/\[T·∫∑ng: (.*?)\]/);
        if(match) giftPrint = match[1];
    }
    setVal('print_gift', giftPrint);

    if(row.SDTKHACH) {
        const res = await fetchData({ action: 'lookup_customer', SDT: row.SDTKHACH.replace(/'/g, '') });
        if(res && res.success) {
            setVal('print_custName', res.data.TEN || '');
            setVal('print_custAddr', res.data.DIACHI || '');
            setVal('print_custCCCD', res.data.CCCD ? res.data.CCCD.replace(/'/g, '') : '');
        }
    }
    
    const today = new Date();
    document.getElementById('prev_date').innerText = `Ng√†y ${today.getDate()} th√°ng ${today.getMonth() + 1} nƒÉm ${today.getFullYear()}`;
    updatePrintPreview();
}

function updatePrintPreview() {
    const getTxt = (id) => document.getElementById(id).value;
    const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
    const setCheck = (id, targetId) => {
        const checked = document.getElementById(id).checked;
        const el = document.getElementById(targetId);
        if(el) {
            el.innerText = checked ? "(‚úì) ƒê√£ thay" : "(‚úó) Nguy√™n b·∫£n";
            el.className = checked ? "tech-check replaced" : "tech-check original";
        }
    }
    
    setTxt('prev_custName', getTxt('print_custName').toUpperCase());
    setTxt('prev_signName', getTxt('print_custName').toUpperCase());
    setTxt('prev_custPhone', getTxt('print_custPhone'));
    setTxt('prev_custAddr', getTxt('print_custAddr'));
    setTxt('prev_custCCCD', getTxt('print_custCCCD'));
    setTxt('prev_prodType', getTxt('print_prodType'));
    setTxt('prev_prodModel', getTxt('print_prodModel'));
    setTxt('prev_prodIMEI', getTxt('print_prodIMEI'));
    setTxt('prev_page2IMEI', getTxt('print_prodIMEI'));
    setTxt('prev_prodAcc', getTxt('print_prodAcc'));
    setTxt('prev_prodCond', getTxt('print_prodCond'));
    setTxt('prev_baotest', getTxt('print_baotest'));
    setTxt('prev_warRepair', getTxt('print_warRepair'));
    setTxt('prev_warBattery', getTxt('print_warBattery'));
    setTxt('prev_gift', getTxt('print_gift'));
    setTxt('prev_notes', getTxt('print_notes'));

    setCheck('chk_lung', 'v_lung'); setCheck('chk_suon', 'v_suon'); setCheck('chk_epkinh', 'v_epkinh');
    setCheck('chk_manzin', 'v_manzin'); setCheck('chk_manlk', 'v_manlk'); setCheck('chk_pinzin', 'v_pinzin');
    setCheck('chk_pinchu', 'v_pinchu'); setCheck('chk_pincao', 'v_pincao'); setCheck('chk_camtr', 'v_camtr');
    setCheck('chk_camsau', 'v_camsau'); setCheck('chk_main', 'v_main');
    
    const cloudEl = document.getElementById('v_cloud');
    if(document.getElementById('chk_cloud').checked) {
        cloudEl.innerText = "(‚úì) OK"; cloudEl.className = "tech-check original";
    } else {
        cloudEl.innerText = "(‚úó) C√≥ iCloud"; cloudEl.className = "tech-check replaced";
    }
}

function autoScalePrintPreview() {
    const wrapper = qs('#preview-wrapper');
    const container = qs('#print-preview');
    if (!wrapper || !container) return;
    if (window.innerWidth < 768) {
        const originalWidth = 800; const availableWidth = container.offsetWidth - 32; 
        const scale = Math.min(availableWidth / originalWidth, 1);
        wrapper.style.transform = `scale(${scale})`;
        wrapper.style.transformOrigin = 'top center'; 
    } else { wrapper.style.transform = 'none'; }
}

async function copyOrderReport(seri) {
    const row = allData.find(r => r.SERI === seri);
    if (!row) return;

    let custName = "Kh√°ch h√†ng";
    if (row.SDTKHACH) {
        const res = await fetchData({ action: 'lookup_customer', SDT: row.SDTKHACH.replace(/'/g, '') });
        if (res && res.success) custName = res.data.TEN || custName;
    }

    const today = new Date();
    const dateStr = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;
    const reportText = `*B√ÅO C√ÅO B√ÅN H√ÄNG*\nüìÖ Ng√†y: ${dateStr}\n--------------------------\nüë§ Kh√°ch: ${custName}\nüìû SƒêT: ${row.SDTKHACH ? row.SDTKHACH.replace(/'/g, '') : ''}\nüì± M√°y: ${row.NAME} ${row.DL||''} ${row.COLOR||''}\nüî¢ IMEI: ${row.SERI}\nüõ°Ô∏è B·∫£o h√†nh: ${row.BAOHANH || '-'}`;

    navigator.clipboard.writeText(reportText).then(() => alert("‚úÖ ƒê√£ copy b√°o c√°o!"));
}

function switchPrintTab(tabName) {
    const editor = qs('#print-editor'), preview = qs('#print-preview');
    const bE = qs('#ptab-editor'), bP = qs('#ptab-preview');
    if (tabName === 'editor') {
        editor.classList.remove('hidden'); preview.classList.add('hidden');
        bE.className = "flex-1 py-3 text-sm font-bold text-indigo-700 border-b-2 border-indigo-700 bg-white";
        bP.className = "flex-1 py-3 text-sm text-gray-500 font-medium hover:bg-gray-100";
    } else {
        editor.classList.add('hidden'); preview.classList.remove('hidden'); preview.classList.add('flex');
        bE.className = "flex-1 py-3 text-sm text-gray-500 font-medium hover:bg-gray-100";
        bP.className = "flex-1 py-3 text-sm font-bold text-indigo-700 border-b-2 border-indigo-700 bg-white";
        setTimeout(autoScalePrintPreview, 50);
    }
}

function closePrintModal() { qs('#printModal').classList.add('hidden'); qs('#printModal').classList.remove('flex'); }

window.addEventListener('resize', autoScalePrintPreview);
loadData();
</script>
</body>
</html>